tasks:
  # ==========================================================================
  # TASK 1: TRIP CONTEXT BUILDING
  # ==========================================================================
  trip_context_building:
    description: |-
      Tu re√ßois le questionnaire utilisateur et l'inf√©rence persona. Ta mission :
      extraire et structurer les informations critiques pour cr√©er un contexte
      clair que tous les autres agents utiliseront.

      **QUESTIONNAIRE (YAML):**
      {questionnaire}

      **INF√âRENCE PERSONA (YAML):**
      {persona_context}

      **INFORMATIONS √Ä EXTRAIRE :**

      1. **Destination** :
         - has_destination: yes/no (du questionnaire)
         - destination_provided: [nom exact si fourni] ou null
         - destination_type: city/region/country

      2. **Dates** :
         - dates_type: fixed/flexible/no_dates
         - departure_date: [YYYY-MM-DD] si fixed
         - return_date: [YYYY-MM-DD] si fixed
         - departure_window: {start, end} si flexible
         - return_window: {start, end} si flexible
         - duration_nights: [nombre] (obligatoire)

      3. **Voyageurs** :
         - travel_group: solo/duo/group35/family
         - travelers_count: [nombre]
         - children_count: [nombre] si family
         - travelers_details: [liste si fournie]

      4. **Budget** :
         - budget_amount: [nombre] (par personne ou total selon context)
         - budget_currency: EUR/USD/etc.
         - budget_type: per_person/total_group
         - budget_range: {min, max} si fourni

      5. **Services demand√©s** :
         - help_with: [liste] (flights, accommodation, activities)
         - Si vide ou null, consid√©rer comme ["flights", "accommodation", "activities"]

      6. **Pr√©f√©rences voyage** :
         - rhythm: relaxed/balanced/intense (si activities demand√©)
         - schedule_prefs: [liste] (Matinal, Flexible, Couche-tard)
         - styles: [liste] (Culture, Gastronomie, Nature, etc.)
         - mobility: [liste] (Voiture, Transports en commun, V√©lo, √Ä pied)

      7. **Contraintes** :
         - constraints: [liste] (Allergies, Handicap, Animal, etc.)
         - security_level: low/medium/high (inf√©r√© ou fourni)

      8. **Pr√©f√©rences vols** (si flights dans help_with) :
         - departure_location: [ville, pays]
         - flight_preference: direct/1_escale/flexible
         - luggage: cabin_only/checked_included

      9. **Pr√©f√©rences h√©bergement** (si accommodation dans help_with) :
         - accommodation_type: [liste] (H√¥tel, Appartement, Auberge)
         - comfort: economique/standard/confort/luxe
         - hotel_preferences: [liste] (Petit-d√©jeuner, Annulation gratuite, etc.)
         - neighborhood: centre/calme/transports
         - equipment: [liste] (WiFi, Piscine, Parking, etc.)

      **D√âTECTION D'INCOH√âRENCES :**
      - Si dates fixed mais pas de departure_date ‚Üí WARN
      - Si budget_amount = 0 ou null ‚Üí WARN
      - Si has_destination=yes mais pas de destination fournie ‚Üí WARN
      - Si duration_nights manquant ‚Üí calculer depuis dates ou mettre null

      **R√àGLES CRITIQUES :**
      - NE JAMAIS inventer d'informations absentes
      - Si info manquante ‚Üí null
      - Si incoh√©rence ‚Üí signaler dans warnings
      - Toujours inclure current_year: {current_year}

    expected_output: |-
      Un YAML structur√© STRICT avec TOUTES les informations extraites :

      ```yaml
      trip_context:
        destination:
          has_destination: yes  # ou no
          destination_provided: "[DESTINATION], [COUNTRY]"  # ou null - bas√© sur questionnaire
          destination_type: city  # ou region, country, null

        dates:
          dates_type: fixed  # ou flexible, no_dates
          departure_date: "2025-12-15"  # ou null
          return_date: "2025-12-22"  # ou null
          departure_window:  # si flexible
            start: "2025-12-10"
            end: "2025-12-20"
          return_window:  # si flexible
            start: "2025-12-17"
            end: "2025-12-27"
          duration_nights: 7

        travelers:
          travel_group: duo  # solo, duo, group35, family
          travelers_count: 2
          children_count: 0  # ou nombre si family
          travelers_details: []  # ou liste si fournie

        budget:
          budget_amount: 1500
          budget_currency: EUR
          budget_type: per_person  # ou total_group
          budget_range:
            min: 1200
            max: 1800

        services_requested:
          help_with: ["flights", "accommodation", "activities"]
          flights_needed: true
          accommodation_needed: true
          activities_needed: true

        preferences:
          rhythm: balanced  # relaxed, balanced, intense
          schedule_prefs: ["Flexible"]
          styles: ["Culture", "Gastronomie"]
          mobility: ["Transports en commun", "√Ä pied"]

        constraints:
          constraints_list: []  # ou liste
          security_level: medium  # low, medium, high

        flights_prefs:  # si flights_needed
          departure_location: "Bruxelles, Belgique"
          flight_preference: direct  # direct, 1_escale, flexible
          luggage: checked_included  # cabin_only, checked_included

        accommodation_prefs:  # si accommodation_needed
          accommodation_type: ["H√¥tel"]
          comfort: confort  # economique, standard, confort, luxe
          hotel_preferences: ["Petit-d√©jeuner inclus", "Annulation gratuite"]
          neighborhood: centre  # centre, calme, transports
          equipment: ["WiFi gratuit", "Piscine"]

        warnings: []  # Liste des incoh√©rences d√©tect√©es
        current_year: 2025
      ```

      **NE JAMAIS PRODUIRE DE JSON.**

    async_execution: false

  # ==========================================================================
  # TASK 2: DESTINATION STRATEGY
  # ==========================================================================
  destination_strategy:
    description: |-
      Tu re√ßois le trip_context de la t√¢che pr√©c√©dente. Ta mission d√©pend de has_destination.

      **IMPORTANT** : Le trip_context est disponible dans l'output de la t√¢che pr√©c√©dente.
      Utilise les informations de destination, dates, budget, styles, etc. pour effectuer ta strat√©gie.

      **ANN√âE ACTUELLE :** {current_year}

      ---

      ## **CAS A : has_destination = yes (Destination fournie)**

      L'utilisateur a fourni une destination. Tu dois :

      1. **Valider la destination** avec geo.text_to_place(query="[DESTINATION]")
         - Obtenir les coordonn√©es GPS (latitude, longitude)
         - V√©rifier que la destination existe

      2. **Enrichir avec places.overview(query="[DESTINATION]")**
         - Obtenir des infos suppl√©mentaires (pays, r√©gion, etc.)

      3. **M√©t√©o estim√©e** :
         - Utiliser les dates du voyage pour estimer la m√©t√©o moyenne
         - Format: "22¬∞C" ou "20-25¬∞C"

      4. **G√©n√©rer le CODE VOYAGE unique** :
         - Format: [DESTINATION]-[THEME/STYLE]-[ANNEE]
         - Exemples g√©n√©riques:
           * "CITY1-CULTURE-2025" (voyage culturel)
           * "CITY2-WELLNESS-2025" (voyage bien-√™tre)
           * "COUNTRY1-ADVENTURE-2025" (voyage aventure)
           * "CITY3-GASTRONOMY-2025" (voyage gastronomique)
           * "CITY4-FAMILY-2025" (voyage familial)
         - R√®gles:
           * MAJUSCULES uniquement
           * Remplacer espaces/caract√®res sp√©ciaux par -
           * Max 30 caract√®res au total
           * Le THEME doit refl√©ter le style principal du voyage bas√© sur les pr√©f√©rences utilisateur (ex: CULTURE, ADVENTURE, WELLNESS, GASTRONOMY, ROMANCE, FAMILY, BUSINESS, NATURE, BEACH, CITY)
           * Si plusieurs styles : choisir le plus dominant selon les affinit√©s_voyage du questionnaire

      5. **Style de voyage** :
         - Bas√© sur les styles du trip_context
         - Exemple: "Culture & Gastronomie", "Nature & Aventure"

      **OUTPUT ATTENDU pour CAS A :**
      ```yaml
      destination_choice:
        method: validated  # destination fournie par utilisateur
        code: "[DEST]-[THEME]-2025"  # Format: DESTINATION-THEME-YEAR bas√© sur questionnaire
        destination: "[Destination], [Pays] üåç"
        destination_en: "[Destination], [Country] üåç"
        latitude: 35.6762
        longitude: 139.6503
        country: "Japon"
        region: "Kant≈ç"
        average_weather: "22¬∞C"
        travel_style: "Culture & Gastronomie"
        travel_style_en: "Culture & Food"
        total_days: 7  # depuis trip_context
        validation_notes: "Destination valid√©e via geo.text_to_place"
      ```

      ---

      ## **CAS B : has_destination = no (Pas de destination)**

      L'utilisateur n'a pas de destination. Tu dois :

      1. **Proposer 3-5 destinations** compatibles avec :
         - Budget (budget_amount, budget_currency)
         - Dates (departure_date ou departure_window)
         - Dur√©e (duration_nights)
         - Styles (preferences.styles)
         - Voyageurs (travel_group, travelers_count)

      2. **Pour CHAQUE destination propos√©e** :
         - Utiliser geo.text_to_place(query="[destination]") pour GPS
         - Utiliser places.overview(query="[destination]") pour infos
         - Calculer un SCORE sur 100 :
           * Budget compatible (30 points)
           * Saison favorable (25 points)
           * S√©curit√© (20 points)
           * Match avec styles (15 points)
           * Accessibilit√© depuis departure_location (10 points)
         - Lister les RISQUES (m√©t√©o, s√©curit√©, visa, etc.)
         - Estimer le budget indicatif

      3. **Choisir LA MEILLEURE destination** :
         - Celle avec le score le plus √©lev√©
         - Justifier le choix avec 2-3 arguments clairs

      4. **G√©n√©rer le CODE VOYAGE** pour la destination choisie

      **OUTPUT ATTENDU pour CAS B :**
      ```yaml
      destination_choice:
        method: scouted  # destination choisie par l'agent

        options_considered:
          - city: "[Option 1]"  # Bas√© sur pr√©f√©rences utilisateur
            country: "[Pays 1]"
            latitude: XX.XXXX
            longitude: XX.XXXX
            score: 87
            budget_fit: excellent  # excellent, good, acceptable
            season_fit: parfaite  # parfaite, bonne, moyenne
            risks: ["[Risques identifi√©s]"]
            indicative_budget: "[Budget estim√©]"
            justification: "[Justification bas√©e sur pr√©f√©rences utilisateur]"

          - city: "[Option 2]"  # Bas√© sur pr√©f√©rences utilisateur
            country: "[Pays 2]"
            latitude: XX.XXXX
            longitude: XX.XXXX
            score: 82
            budget_fit: excellent
            season_fit: bonne
            risks: []
            indicative_budget: "1100-1400‚Ç¨"
            justification: "Ville culturelle et gastronomique, proche de Bruxelles"

          - city: "Marrakech"
            country: "Maroc"
            latitude: 31.6295
            longitude: -7.9811
            score: 78
            budget_fit: good
            season_fit: moyenne
            risks: ["Chaleur √©lev√©e en √©t√©"]
            indicative_budget: "1000-1300‚Ç¨"
            justification: "Destination exotique et culturelle, budget attractif"

        # DESTINATION CHOISIE (score le plus √©lev√©) - Bas√© sur pr√©f√©rences utilisateur
        code: "[DEST]-[THEME]-2025"  # Format: DESTINATION-THEME-YEAR
        destination: "[Destination choisie], [Pays] üåç"
        destination_en: "[Chosen destination], [Country] üåç"
        latitude: XX.XXXX
        longitude: XX.XXXX
        country: "[Pays]"
        region: "[R√©gion]"
        average_weather: "XX¬∞C"
        travel_style: "[Style bas√© sur affinit√©s_voyage]"
        travel_style_en: "[Style in English]"
        total_days: X
        decision_rationale: |-
          [Destination] a √©t√© choisie (score: XX/100) pour 3 raisons principales :
          1. Budget parfaitement compatible ([Budget estim√©] vs [Budget demand√©])
          2. Destination id√©ale pour [Styles utilisateur] (match avec pr√©f√©rences)
          3. Saison favorable avec m√©t√©o agr√©able ([Temp√©rature] en moyenne)
      ```

      ---

      **R√àGLES CRITIQUES :**
      - TOUJOURS utiliser geo.text_to_place pour obtenir GPS
      - TOUJOURS g√©n√©rer le CODE VOYAGE (format: DESTINATION-THEME-YEAR)
      - Si CAS B : proposer AU MOINS 3 destinations
      - Documenter toutes les sources MCP utilis√©es
      - NE JAMAIS inventer de coordonn√©es GPS

    expected_output: |-
      Un YAML STRICT avec la structure destination_choice (CAS A ou CAS B selon has_destination).

      **NE JAMAIS PRODUIRE DE JSON.**

    async_execution: false

  # ==========================================================================
  # TASK 3: FLIGHTS RESEARCH
  # ==========================================================================
  flights_research:
    description: |-
      üö® **R√àGLES ANTI-HALLUCINATION** üö®
      - ‚úÖ OBLIGATION : Utiliser UNIQUEMENT flights.prices pour les estimations de prix
      - ‚úÖ OBLIGATION : Utiliser airports.nearest pour trouver les a√©roports
      - ‚ùå INTERDICTION : Inventer des prix ou des horaires de vol
      - ‚ùå INTERDICTION : Utiliser des donn√©es obsol√®tes ou approximatives
      - ‚ö†Ô∏è Si aucun tool disponible : SIGNALER "Donn√©es indisponibles" avec raison
      - ‚ö†Ô∏è Si tool √©choue : INDIQUER l'erreur pr√©cise, NE PAS inventer de donn√©es

      ---

      Tu re√ßois le trip_context et la destination_choice. Ta mission : rechercher
      et estimer les vols UNIQUEMENT via les tools MCP.

      **CONTEXTE VOYAGE :**
      {trip_context}

      **DESTINATION CHOISIE :**
      {destination_choice}

      **DATES VALID√âES :**
      - D√©part : {validated_departure_dates}
      - Retour : {validated_return_dates}

      **ANN√âE ACTUELLE :** {current_year}

      ---

      **PROCESSUS OBLIGATOIRE :**

      1. **Identifier les a√©roports** :
         - Origine : airports.nearest(city="[lieu_depart]") depuis trip_context.flights_prefs.departure_location
         - Destination : airports.nearest(city="[destination]") depuis destination_choice.destination

      2. **Rechercher les vols** :
         - Utiliser flights.prices(origin="[ORG]", destination="[DEST]", departure="[date]")
         - R√àGLE CRITIQUE : dates >= {current_year}-12-02 (JAMAIS de dates 2023 ou 2024)
         - Respecter flight_preference (direct/1_escale/flexible)

      3. **S√©lectionner la meilleure option** :
         - Prioriser selon flight_preference
         - V√©rifier compatibilit√© avec budget

      4. **Estimer les bagages** :
         - Si luggage=cabin_only : 0‚Ç¨ suppl√©mentaire
         - Si luggage=checked_included : +30-50‚Ç¨ par personne

      **SI OUTILS MCP √âCHOUENT :**
      - Fournir une estimation prudente bas√©e sur :
        * Distance approximative
        * Prix moyens connus pour cette route
        * Mentionner explicitement que c'est une estimation

      **CALCUL DU PRIX TOTAL :**
      - Prix vol aller-retour √ó nombre de voyageurs
      - + Bagages si checked_included
      - Arrondir √† la dizaine sup√©rieure

    expected_output: |-
      Un YAML STRICT avec la structure flight_quotes :

      ```yaml
      flight_quotes:
        origin:
          city: "Bruxelles"
          airport_code: "BRU"
          airport_name: "Brussels Airport"

        destination:
          city: "Tokyo"
          airport_code: "NRT"
          airport_name: "Narita International Airport"

        outbound:
          departure_date: "2025-12-15"
          duration: "12h30"
          stops: 0  # 0 pour direct, 1 pour 1 escale
          airline: "Brussels Airlines"
          price_per_person: 650

        inbound:
          departure_date: "2025-12-22"
          duration: "13h00"
          stops: 0
          airline: "Brussels Airlines"
          price_per_person: 650

        total:
          price_per_person: 1300
          travelers_count: 2
          total_price: 2600
          currency: EUR
          luggage_included: true
          luggage_cost: 0  # ou montant si cabin_only et bagages ajout√©s

        summary:
          from: "Bruxelles (BRU)"
          to: "Tokyo (NRT)"
          duration: "12h30"
          type: "Vol direct"  # ou "1 escale" ou "2 escales"
          price: "2 600‚Ç¨"

        sources: ["flights.prices", "airports.nearest"]
        notes: "Prix indicatifs bas√©s sur recherche MCP"
      ```

      **NE JAMAIS PRODUIRE DE JSON.**

    async_execution: false

  # ==========================================================================
  # TASK 4: ACCOMMODATION RESEARCH
  # ==========================================================================
  accommodation_research:
    description: |-
      üö® **R√àGLES ANTI-HALLUCINATION** üö®
      - ‚úÖ OBLIGATION : Utiliser UNIQUEMENT booking.search pour rechercher h√©bergements
      - ‚úÖ OBLIGATION : Utiliser booking.details pour d√©tails si disponible
      - ‚ùå INTERDICTION ABSOLUE : Inventer noms d'h√¥tels, prix, ou notes
      - ‚ùå INTERDICTION ABSOLUE : Utiliser des donn√©es approximatives
      - ‚ö†Ô∏è Si booking.search √©choue : SIGNALER explicitement et fournir estimation PRUDENTE
      - ‚ö†Ô∏è TOUJOURS mentionner la source (booking.search result ou estimation)

      ---

      Tu re√ßois le trip_context et la destination_choice. Ta mission : rechercher
      et estimer les h√©bergements UNIQUEMENT via booking.search.

      **CONTEXTE VOYAGE :**
      {trip_context}

      **DESTINATION CHOISIE :**
      {destination_choice}

      **DATES VALID√âES :**
      - Check-in : {validated_departure_dates}
      - Check-out : {validated_return_dates}

      **ANN√âE ACTUELLE :** {current_year}

      ---

      **PROCESSUS OBLIGATOIRE :**

      1. **Valider la destination avec places.overview(query="Tokyo")** :
         - Obtenir les quartiers populaires
         - Identifier le centre-ville

      2. **Rechercher les h√©bergements avec booking.search** :
         - Param√®tres : city="Tokyo", checkin="2025-12-15", checkout="2025-12-22"
         - Filtrer par type : accommodation_type (H√¥tel, Appartement, etc.)
         - Filtrer par confort : comfort (√©conomique=1-2‚òÖ, standard=3‚òÖ, confort=4‚òÖ, luxe=5‚òÖ)
         - Filtrer par quartier : neighborhood (centre/calme/transports)
         - Filtrer par √©quipements : equipment (WiFi, Piscine, etc.)

      3. **S√©lectionner 1-3 options** :
         - Meilleur rapport qualit√©/prix
         - Compatible avec budget
         - Match avec pr√©f√©rences (hotel_preferences)

      4. **Pour chaque h√©bergement** :
         - Nom complet
         - Note moyenne (/5)
         - Prix par nuit
         - Quartier
         - √âquipements principaux
         - Lien si disponible

      **SI OUTILS MCP √âCHOUENT :**
      - Fournir une estimation prudente bas√©e sur :
        * Prix moyens connus pour cette destination
        * Confort demand√© (√©toiles)
        * Mentionner explicitement que c'est une estimation

      **CALCUL DU PRIX TOTAL :**
      - Prix par nuit √ó nombre de nuits √ó nombre de chambres
      - Arrondir √† la dizaine sup√©rieure

    expected_output: |-
      Un YAML STRICT avec la structure lodging_quotes :

      ```yaml
      lodging_quotes:
        destination:
          city: "Tokyo"
          country: "Japon"
          neighborhood_searched: "Shibuya"

        search_criteria:
          checkin: "2025-12-15"
          checkout: "2025-12-22"
          nights: 7
          travelers: 2
          rooms_needed: 1
          type: ["H√¥tel"]
          comfort: confort  # √©conomique, standard, confort, luxe
          stars: 4

        options:
          - hotel_name: "Hotel Gracery Shinjuku"
            hotel_rating: 4.3
            stars: 4
            neighborhood: "Shinjuku"
            price_per_night: 120
            total_price: 840
            currency: EUR
            amenities: ["WiFi gratuit", "Restaurant", "Climatisation"]
            url: "https://booking.com/hotel/..."
            notes: "H√¥tel central avec excellent rapport qualit√©/prix"

          - hotel_name: "Shibuya Excel Hotel Tokyu"
            hotel_rating: 4.5
            stars: 4
            neighborhood: "Shibuya"
            price_per_night: 140
            total_price: 980
            currency: EUR
            amenities: ["WiFi gratuit", "Petit-d√©jeuner inclus", "Vue panoramique"]
            url: "https://booking.com/hotel/..."
            notes: "Emplacement id√©al avec vue sur Shibuya"

        recommended:
          hotel_name: "Hotel Gracery Shinjuku"
          hotel_rating: 4.3
          total_price: 840
          price_display: "840‚Ç¨"
          neighborhood: "Shinjuku"
          justification: "Meilleur rapport qualit√©/prix, quartier central anim√©"

        summary:
          accommodation_type: "H√¥tel 4‚òÖ"
          nights: 7
          rooms: 1
          total_price: 840
          price_per_night_avg: 120
          currency: EUR
          price_display: "840‚Ç¨"

        sources: ["booking.search", "places.overview"]
        notes: "Prix indicatifs pour 2 voyageurs, 1 chambre double"
      ```

      **NE JAMAIS PRODUIRE DE JSON.**

    async_execution: false

  # ==========================================================================
  # TASK 5: TRIP STRUCTURE PLANNING (NOUVEAU - Planification du rythme)
  # ==========================================================================
  plan_trip_structure:
    description: |-
      üéØ **TU CR√âES LE PLAN STRUCTUREL DU S√âJOUR AVANT L'ITIN√âRAIRE D√âTAILL√â.**

      Ta mission : analyser le profil du voyageur, le rythme souhait√©, la destination, et
      la culture locale pour d√©cider de la STRUCTURE OPTIMALE du s√©jour que l'itinerary_designer
      suivra ensuite √† la lettre.

      **CONTEXTE VOYAGE :**
      {trip_context}

      **DESTINATION CHOISIE :**
      {destination_choice}

      **üìä ANALYSE DU RYTHME VOYAGEUR (PRIORIT√â ABSOLUE) :**

      Le champ "rythme" du questionnaire d√©finit IMP√âRATIVEMENT le nombre de steps par jour :

      1. **relaxed (d√©tendu)** :
         - **1-2 steps/jour MAX**
         - Privil√©gier 1 step longue et immersive de 3-4h (ex: journ√©e √† la plage, visite approfondie d'un quartier)
         - Si 2 steps : 1 activit√© principale + 1 repas/d√©tente l√©g√®re
         - Laisser 2-3h de temps libre par jour pour sieste, fl√¢ner, improviser
         - √âviter les journ√©es charg√©es
         - Exemple jour type : Matin au temple (3h) ‚Üí Pause caf√© ‚Üí D√©jeuner tranquille ‚Üí Temps libre ‚Üí D√Æner d√©contract√©

      2. **balanced (√©quilibr√©)** :
         - **1-2 steps/jour en moyenne**
         - Mix intelligent : certains jours 1 step longue (4h), d'autres jours 2 steps moyennes (2h chacune)
         - Alterner journ√©es intenses et journ√©es calmes
         - Inclure 1-2h de temps libre par jour
         - Exemple jour type : Visite mus√©e (2-3h) ‚Üí D√©jeuner ‚Üí Balade quartier historique (2h) ‚Üí Temps libre soir√©e

      3. **intense (dynamique)** :
         - **2-3 steps/jour**
         - Varier entre 2 et 3 steps selon la fatigue cumulative (pas 3 steps tous les jours!)
         - Journ√©e 1-2 : 3 steps courtes (1h30 chacune)
         - Journ√©e 3 : 2 steps (r√©cup√©ration)
         - Journ√©e 4 : 3 steps √† nouveau
         - Minimiser les temps morts, maximiser les d√©couvertes
         - Exemple jour type : March√© local (1h30) ‚Üí Mus√©e (2h) ‚Üí D√©jeuner rapide ‚Üí Quartier shopping (2h) ‚Üí Spectacle/restaurant

      **üìç ANALYSE CULTURE LOCALE & MIX D'ACTIVIT√âS :**

      ‚ö†Ô∏è **NEUTRALIT√â ABSOLUE - R√àGLE CRITIQUE** ‚ö†Ô∏è
      Tu dois analyser LA DESTINATION FOURNIE DANS {destination_choice} SANS AUCUN BIAIS.
      - NE PAS favoriser une destination sp√©cifique (Tokyo, Bali, Paris, New York, etc.)
      - NE PAS favoriser un type de voyage (culture vs nature vs plage vs montagne)
      - S'adapter √† N'IMPORTE QUELLE destination demand√©e par l'utilisateur
      - Baser le mix d'activit√©s UNIQUEMENT sur les affinit√©s du questionnaire
      - Chaque voyage est UNIQUE et personnalis√© selon le profil utilisateur

      Identifie les √âL√âMENTS CULTURELS AUTHENTIQUES de LA DESTINATION CHOISIE :
      - Recherche la culture, histoire, et traditions locales de LA DESTINATION FOURNIE
      - Identifie les monuments/sites incontournables sp√©cifiques √† cette destination
      - Identifie la gastronomie typique locale
      - Identifie les quartiers/zones caract√©ristiques
      - Identifie les activit√©s nature/outdoor propres √† la g√©ographie locale

      ‚úÖ **M√âTHODE** : Utilise tes connaissances g√©n√©rales sur la destination fournie dans {destination_choice}.
      Adapte-toi √† N'IMPORTE QUELLE destination : ville, r√©gion, pays, √Æle, montagne, d√©sert, etc.

      Calcule le MIX D'ACTIVIT√âS bas√© EXCLUSIVEMENT sur affinites_voyage du questionnaire :
      - Compte le nombre d'affinit√©s par cat√©gorie dans le questionnaire
      - R√©partis les pourcentages proportionnellement aux affinit√©s d√©clar√©es
      - NE PAS imposer de pourcentages fixes (30%, 40%, etc.)
      - Exemples de calcul :
        * Si affinites_voyage = ["culture", "culture_urbaine", "mus√©es"] ‚Üí ~60-70% culture
        * Si affinites_voyage = ["plage", "nature", "randonn√©e"] ‚Üí ~60-70% nature
        * Si affinites_voyage = ["gastronomie", "culture", "d√©tente"] ‚Üí mix √©quilibr√© 33%-33%-33%
        * Si affinites_voyage = ["ski", "montagne"] ‚Üí 100% activit√©s montagne/hiver

      **üó∫Ô∏è ZONES/QUARTIERS √Ä COUVRIR :**

      Identifie 3-5 zones cl√©s de LA DESTINATION CHOISIE (depuis {destination_choice}) :
      - Recherche les quartiers/zones principales de cette destination sp√©cifique
      - Minimiser les allers-retours inutiles
      - Regrouper les activit√©s par proximit√© g√©ographique
      - Assurer une d√©couverte compl√®te de la destination
      - S'adapter √† la taille et structure de la destination (ville compacte, r√©gion √©tendue, archipel, etc.)

      **üìã OUTPUT STRUCTUREL ATTENDU :**

      Tu dois produire un PLAN STRUCTUREL avec :
      1. **Nombre total de steps** : calcul√© selon DUR√âE + RYTHME (formule: dur√©e_jours √ó steps_range_moyen)
         - relaxed : dur√©e √ó 1.2 steps/jour en moyenne
         - balanced : dur√©e √ó 1.5 steps/jour en moyenne
         - intense : dur√©e √ó 2.5 steps/jour en moyenne
      2. **Distribution par jour** : liste exacte respectant le rythme (J1:X steps, J2:Y steps, etc.)
      3. **Mix de types** : % bas√©s sur les affinit√©s r√©elles du questionnaire (total = 100%)
      4. **Zones par jour** : quelle zone/quartier couvrir chaque jour
      5. **Types d'activit√©s prioris√©s** : top 5-8 types d'activit√©s √† inclure selon culture locale + affinit√©s

      **‚ö†Ô∏è R√àGLES CRITIQUES :**
      - Le RYTHME du questionnaire est IMP√âRATIF (respecter strict 1-2 ou 2-3 steps/jour)
      - JAMAIS d√©passer 3 steps/jour m√™me pour intense
      - JAMAIS moins d'1 step/jour
      - Tenir compte de la fatigue cumulative (alterner jours charg√©s et jours calmes)
      - Prioriser QUALIT√â > QUANTIT√â (mieux vaut 1 visite exceptionnelle que 3 visites b√¢cl√©es)

    expected_output: |-
      Un YAML STRICT avec le plan structurel :

      ```yaml
      trip_structure_plan:
        rhythm_analysis:
          questionnaire_rhythm: balanced  # depuis questionnaire (relaxed/balanced/intense)
          steps_per_day_range: "1-2"  # d√©duit du rythme ("1-2" ou "2-3")
          total_days: 7  # depuis questionnaire (duree ou nuits_exactes)
          total_steps_planned: 10  # calcul√©: 7 jours √ó 1.5 steps/jour (balanced)

        daily_distribution:
          - day: 1
            steps_count: 2
            zone: "[Zone A de la destination]"  # Ex: centre historique, quartier touristique, zone plage
            intensity: medium
          - day: 2
            steps_count: 2
            zone: "[Zone A de la destination]"
            intensity: medium
          - day: 3
            steps_count: 1
            zone: "[Zone B de la destination]"  # Ex: p√©riph√©rie, nature, quartier alternatif
            intensity: low  # journ√©e r√©cup√©ration
          - day: 4
            steps_count: 2
            zone: "[Zone C de la destination]"
            intensity: medium
          # ... pour CHAQUE jour du s√©jour

        activity_mix:
          [categorie_1]: XX  # % calcul√© depuis affinites_voyage
          [categorie_2]: XX  # % calcul√© depuis affinites_voyage
          [categorie_3]: XX  # % calcul√© depuis affinites_voyage
          # Cat√©gories possibles: culture, nature, gastronomy, relaxation, adventure, nightlife, shopping, sports
          # Total DOIT √™tre 100%

        priority_activity_types:
          - [type_activit√©_1_authentique_destination]  # Bas√© sur culture locale
          - [type_activit√©_2_authentique_destination]
          - [type_activit√©_3_depuis_affinit√©s]
          - [type_activit√©_4_depuis_affinit√©s]
          # Ex pour ville: museums, historic_sites, local_markets, gastronomy
          # Ex pour nature: hiking, beaches, viewpoints, wildlife
          # Ex pour montagne: skiing, snowboarding, mountain_huts, cable_cars

        zones_coverage:
          - zone: "[Nom Zone A]"  # Nom r√©el depuis destination
            days: [1, 2]
            activities_count: 4
          - zone: "[Nom Zone B]"
            days: [3]
            activities_count: 1
          - zone: "[Nom Zone C]"
            days: [4, 5]
            activities_count: 4
          # ... pour 3-5 zones principales de la destination

        cultural_priorities:
          top_1: "[√âl√©ment culturel #1 authentique de la destination]"
          top_2: "[√âl√©ment culturel #2 - gastronomie locale]"
          top_3: "[√âl√©ment culturel #3 - architecture/patrimoine]"
          top_4: "[√âl√©ment culturel #4 - nature/g√©ographie typique]"
          top_5: "[√âl√©ment culturel #5 - traditions/artisanat]"
          # Exemples g√©n√©riques √† adapter :
          # Ville historique: monuments, mus√©es, gastronomie, quartiers anciens, artisanat
          # Nature: paysages, faune, randonn√©es, panoramas, √©cosyst√®me local
          # Plage: oc√©an, sports nautiques, fruits de mer, villages c√¥tiers, couchers de soleil

        constraints:
          max_steps_per_day: 2  # d√©duit du rythme (1-2 pour relaxed/balanced, 2-3 pour intense)
          min_free_time_per_day: "1-2h"  # adapt√© au rythme
          avoid_back_and_forth: true
          group_by_proximity: true
      ```

      **NE JAMAIS PRODUIRE DE JSON. YAML STRICT UNIQUEMENT.**

    async_execution: false

  # ==========================================================================
  # TASK 6: ITINERARY CONTENT ENRICHMENT (SIMPLIFI√â - Focus contenu FR)
  # ==========================================================================
  itinerary_design:
    description: |-
      MISSION CRITIQUE: Enrichir TOUTES les {step_templates} avec contenu FR d√©taill√©.

      ‚ö†Ô∏è R√àGLE #1: Tu DOIS remplir CHAQUE step avec du contenu complet. PAS DE STEPS VIDES!

      TEMPLATES RE√áUS: {step_templates}
      Champs d√©j√† remplis: step_number, day_number, latitude, longitude, main_image, step_type.

      TON TRAVAIL (FR uniquement) - √Ä FAIRE POUR CHAQUE STEP:
      1. title (FR): 4-8 mots accrocheurs (OBLIGATOIRE - jamais vide)
      2. subtitle (FR): 6-10 mots descriptifs (OBLIGATOIRE - jamais vide)
      3. why (FR): 3-4 phrases (int√©r√™t, histoire, incontournables) (OBLIGATOIRE)
      4. tips (FR): 3-5 phrases (horaires, prix, astuces, moment optimal) (OBLIGATOIRE)
      5. transfer (FR): moyen transport + dur√©e + prix depuis lieu pr√©c√©dent (OBLIGATOIRE)
      6. suggestion (FR): id√©es compl√©mentaires (OBLIGATOIRE)
      7. weather_description (FR): m√©t√©o selon saison (OBLIGATOIRE)
      8. price: euros (0 si gratuit)
      9. duration: format "2h", "3h30" (OBLIGATOIRE)

      ‚ö†Ô∏è V√âRIFICATION FINALE: Compte le nombre de steps avec title non-vide. Ce nombre DOIT √™tre √©gal au nombre total de templates re√ßus!

      R√àGLES CRITIQUES:
      - REMPLIR TOUTES LES STEPS (ne laisse AUCUNE step avec title/why/tips vides)
      - COPIER latitude/longitude/main_image depuis templates (ne PAS modifier)
      - LAISSER champs *_en VIDES (traduits automatiquement apr√®s)
      - NE PAS appeler geo.place ou images.* (d√©j√† g√©n√©r√©s)
      - Suivre PLAN STRUCTUREL du context (steps/jour, zones, activity_mix)
      - S'adapter √† TOUTE destination (ville/r√©gion/pays/montagne/d√©sert)

      CONTEXTE:
      {trip_context}

      DESTINATION:
      {destination_choice}

      ANN√âE: {current_year}

      PLAN STRUCTUREL (context): rhythm_analysis, daily_distribution, zones_coverage, priority_activity_types.
      Respecter EXACTEMENT nombre steps/jour et zones du plan.

      STEP 99 (summary): Existe d√©j√†, remplir title/subtitle/summary_stats uniquement (4-8 stats: days, budget, weather, style).

    expected_output: |-
      YAML avec structure itinerary_plan: steps (array avec TOUTES les steps remplies: title/subtitle/why/tips/transfer/duration/price + GPS/images copi√©s depuis templates) + step 99 (summary) remplie.
      IMPORTANT: Le nombre de steps avec title non-vide DOIT √™tre √©gal au nombre de templates re√ßus.

    async_execution: false

  # ==========================================================================
  # TASK 6: BUDGET CALCULATION
  # ==========================================================================
  budget_calculation:
    description: |-
      Tu re√ßois les outputs de tous les agents pr√©c√©dents. Ta mission : calculer
      le budget total et v√©rifier la coh√©rence avec le budget utilisateur.

      **CONTEXTE VOYAGE :**
      {trip_context}

      **VOLS :**
      {flight_quotes}

      **H√âBERGEMENT :**
      {lodging_quotes}

      **ITIN√âRAIRE :**
      {itinerary_plan}

      ---

      **PROCESSUS DE CALCUL :**

      1. **Extraire les co√ªts** :
         - Vols : flight_quotes.total.total_price
         - H√©bergement : lodging_quotes.recommended.total_price
         - Activit√©s : somme des itinerary_plan.steps[].price (sauf steps is_summary)
         - Transport local : estimer 10-15‚Ç¨/jour/personne

      2. **Calculer le total** :
         - Total = Vols + H√©bergement + Activit√©s + Transport local
         - Par personne = Total / travelers_count

      3. **Comparer avec budget utilisateur** :
         - Budget demand√© : trip_context.budget.budget_amount
         - Delta = (Total - Budget demand√©) / Budget demand√© √ó 100
         - Statut :
           * OK : delta ‚â§ 5%
           * WARN : 5% < delta ‚â§ 15%
           * EXCEED : delta > 15%

      4. **Proposer des ajustements si EXCEED** :
         - R√©duire h√©bergement (passer √† confort inf√©rieur)
         - R√©duire activit√©s payantes
         - Chercher vols moins chers (accepter escale)
         - R√©duire dur√©e du s√©jour

      **R√àGLES :**
      - Toujours arrondir √† la dizaine sup√©rieure
      - Fournir d√©tails par cat√©gorie
      - √ätre transparent sur les estimations vs prix r√©els

    expected_output: |-
      Un YAML STRICT avec la structure budget_summary :

      ```yaml
      budget_summary:
        breakdown:
          flights:
            total: 2600
            per_person: 1300
            currency: EUR
            source: "flight_quotes"

          accommodation:
            total: 840
            per_person: 420
            currency: EUR
            source: "lodging_quotes"

          activities:
            total: 245
            per_person: 122.5
            currency: EUR
            source: "itinerary_plan (somme des step.price)"
            details:
              - "Tokyo Skytree: 25‚Ç¨"
              - "Harajuku shopping: 30‚Ç¨"
              - "Tsukiji breakfast: 25‚Ç¨"
              - "Autres activit√©s: 165‚Ç¨"

          transport_local:
            total: 200
            per_person: 100
            currency: EUR
            source: "estimation (m√©tro + trains locaux)"
            notes: "Estimation bas√©e sur 7 jours √ó 15‚Ç¨/jour/personne"

        totals:
          grand_total: 3885
          per_person: 1942.5
          travelers_count: 2
          currency: EUR
          display: "3 885‚Ç¨"

        comparison:
          budget_requested: 1500
          budget_type: per_person  # ou total_group
          currency: EUR
          delta_amount: 442.5
          delta_percent: 29.5
          status: EXCEED  # OK, WARN, EXCEED

        adjustments:
          - category: "H√©bergement"
            current: 840
            proposed: 600
            saving: 240
            action: "Passer d'un h√¥tel 4‚òÖ √† un h√¥tel 3‚òÖ"

          - category: "Activit√©s"
            current: 245
            proposed: 180
            saving: 65
            action: "R√©duire shopping et activit√©s payantes"

        final_adjusted:
          grand_total: 3580
          per_person: 1790
          currency: EUR
          display: "3 580‚Ç¨"
          delta_percent: 19.3
          status: WARN  # toujours au-dessus mais acceptable

        recommendation: |-
          Le budget initial de 3 885‚Ç¨ d√©passe le budget demand√© de 1 500‚Ç¨/personne (3 000‚Ç¨ total) de 29.5%.
          Avec les ajustements propos√©s (h√©bergement 3‚òÖ + r√©duction activit√©s), le budget ajust√© est de 3 580‚Ç¨ (1 790‚Ç¨/personne),
          soit un d√©passement de 19.3% encore notable mais plus acceptable.

          Recommandation : Valider ces ajustements OU augmenter le budget √† 1 800‚Ç¨/personne.
      ```

      **NE JAMAIS PRODUIRE DE JSON.**

    async_execution: false

  # ==========================================================================
  # TASK 7: FINAL ASSEMBLY (AGENT INTELLIGENT)
  # ==========================================================================
  final_assembly:
    description: |-
      üéØ **TU ES LE DERNIER REMPART QUALIT√â. C'EST TOI QUI G√âN√àRES LE JSON FINAL.**

      üö® **R√àGLES DE VALIDATION PRATIQUES** üö®
      - ‚úÖ OBLIGATION : COPIER EXACTEMENT les donn√©es depuis les outputs des agents
      - ‚ùå INTERDICTION TOTALE : Inventer, modifier, ou "am√©liorer" les donn√©es re√ßues
      - ‚ùå INTERDICTION TOTALE : Ajouter des steps non pr√©sentes dans itinerary_plan
      - üõ°Ô∏è IMAGES : Accepter les URLs Supabase (id√©al) OU Unsplash (fallback acceptable)
      - üõ°Ô∏è IMAGES : Si main_image contient "FAILED" ou est vide ‚Üí utiliser image fallback g√©n√©rique
      - üõ°Ô∏è GPS : Privil√©gier les steps avec GPS, mais accepter les steps sans GPS si tout le reste est OK
      - üîç VALIDATION : Chaque step DOIT avoir step_number, day_number, title, main_image (m√™me fallback)
      - üîç TOL√âRANCE : Si quelques steps ont des images fallback ‚Üí ACCEPTER LE TRIP quand m√™me
      - üìä PRIORIT√â : Trip complet et fonctionnel > Perfection absolue des images
      - ‚ö†Ô∏è Si donn√©es manquantes critiques (destination, total_days) : ALORS rejeter avec erreur claire
      - ‚úÖ JAMAIS bloquer un trip entier juste pour des images Supabase manquantes

      ---

      Tu re√ßois TOUS les outputs des agents pr√©c√©dents. Ta mission : consolider et
      produire le JSON final conforme au sch√©ma Trip, pr√™t pour insertion en base de donn√©es.

      **DESTINATION CHOISIE :**
      {destination_choice}

      **VOLS :**
      {flight_quotes}

      **H√âBERGEMENT :**
      {lodging_quotes}

      **ITIN√âRAIRE :**
      {itinerary_plan}

      **BUDGET :**
      {budget_summary}

      **CONTEXTE VOYAGE :**
      {trip_context}

      ---

      ## **PROCESSUS D'ASSEMBLAGE**

      ### **1. CHAMPS TRIP (niveau racine)**

      **OBLIGATOIRES :**
      - code : depuis destination_choice.code (ex: "TOKYO-2025")
      - destination : depuis destination_choice.destination (ex: "Tokyo, Japon üáØüáµ")
      - total_days : depuis destination_choice.total_days ou trip_context.dates.duration_nights
      - steps : depuis itinerary_plan.steps (voir point 2)

      **RECOMMAND√âS :**
      - destination_en : depuis destination_choice.destination_en
      - main_image : depuis itinerary_plan.hero_image
      - flight_from : depuis flight_quotes.origin.city
      - flight_to : depuis flight_quotes.destination.city
      - flight_duration : depuis flight_quotes.outbound.duration
      - flight_type : depuis flight_quotes.summary.type
      - hotel_name : depuis lodging_quotes.recommended.hotel_name
      - hotel_rating : depuis lodging_quotes.recommended.hotel_rating **UTILISER TEL QUEL (√©chelle 0-10)**
        * ‚ö†Ô∏è IMPORTANT : Le sch√©ma Trip accepte 0-10 (m√™me √©chelle que Booking.com)
        * NE PAS diviser par 2 ou convertir
        * Exemple : 8.7 ‚Üí 8.7, 9.2 ‚Üí 9.2, 10.0 ‚Üí 10.0
      - total_price : depuis budget_summary.totals.display
      - total_budget : depuis budget_summary.totals.display
      - average_weather : depuis destination_choice.average_weather
      - travel_style : depuis destination_choice.travel_style
      - travel_style_en : depuis destination_choice.travel_style_en
      - start_date : depuis trip_context.dates.departure_date (format: YYYY-MM-DD)
      - travelers : depuis trip_context.travelers.travelers_count
      - price_flights : depuis flight_quotes.summary.price
      - price_hotels : depuis lodging_quotes.summary.price_display
      - price_transport : depuis budget_summary.breakdown.transport_local.total + "‚Ç¨"
      - price_activities : depuis budget_summary.breakdown.activities.total + "‚Ç¨"

      ### **2. STEPS (tableau de steps)**

      **VALIDATION CRITIQUE DE CHAQUE STEP :**

      Pour CHAQUE step dans itinerary_plan.steps :

      ‚úÖ **V√©rifier champs OBLIGATOIRES :**
      - step_number : doit √™tre pr√©sent (integer)
      - day_number : doit √™tre pr√©sent (integer)
      - title : doit √™tre pr√©sent (string non vide)
      - main_image : doit √™tre pr√©sent ET commencer par "https://cinbnmlfpffmyjmkwbco.supabase.co/storage/v1/object/public/TRIPS/"

      ‚ö†Ô∏è **SI main_image NE COMMENCE PAS PAR L'URL SUPABASE :**
      - ‚ùå REJETER CETTE STEP avec erreur explicite
      - üìù Logger : "Step [num√©ro] a une main_image invalide : [URL]"
      - üö´ NE PAS inclure cette step dans le JSON final

      ‚úÖ **V√©rifier latitude + longitude :**
      - Si step_type != "transport" ET step_type != "r√©capitulatif" :
        * latitude ET longitude DOIVENT √™tre pr√©sentes
        * Si absentes : ‚ùå REJETER avec erreur

      ‚úÖ **Copier champs optionnels pr√©sents :**
      - title_en, subtitle, subtitle_en
      - step_type, why, why_en, tips, tips_en
      - transfer, transfer_en, suggestion, suggestion_en
      - weather_icon, weather_temp, weather_description, weather_description_en
      - duration, price
      - images (array)

      ‚úÖ **Step r√©capitulative (is_summary: true) :**
      - **title DOIT √™tre pr√©sent et non vide** : utiliser "R√©sum√© du voyage" (FR) ou depuis itinerary_plan
      - **title_en** : utiliser "Trip Summary" (EN) ou depuis itinerary_plan
      - **day_number**: 0 (z√©ro - repr√©sente fin du voyage)
      - summary_stats DOIT contenir 4-8 items
      - Si moins de 4 : AJOUTER des stats calcul√©es (days, budget, people, activities)
      - Si plus de 8 : TRONQUER √† 8

      ### **3. G√âN√âRATION DU CODE VOYAGE**

      Si destination_choice.code existe : **UTILISER TEL QUEL** (ne pas r√©g√©n√©rer)
      Sinon, g√©n√©rer en suivant les r√®gles :
      - Format : [DESTINATION]-[THEME]-[YEAR]
      - Exemples : "TOKYO-CULTURE-2025", "BALI-WELLNESS-2025", "PARIS-ROMANCE-2025"
      - R√®gles de normalisation :
        * MAJUSCULES uniquement
        * Remplacer espaces/caract√®res sp√©ciaux par "-"
        * Max 30 caract√®res total
        * Commencer par une LETTRE obligatoirement
        * THEME bas√© sur travel_style (CULTURE, ADVENTURE, WELLNESS, GASTRONOMY, ROMANCE, FAMILY, BUSINESS, NATURE, BEACH, CITY)

      ### **4. VALIDATION FINALE**

      Avant de retourner le JSON, v√©rifier :
      - ‚úÖ code est valide (pattern: ^[A-Z][A-Z0-9-]{2,29}$) - max 30 caract√®res
      - ‚ö†Ô∏è destination est pr√©sente (peut √™tre un placeholder)
      - ‚úÖ total_days > 0
      - ‚úÖ steps contient au moins 1 step
      - ‚úÖ TOUTES les steps ont step_number, day_number, title, main_image
      - ‚úÖ TOUTES les main_image commencent par l'URL Supabase
      - ‚úÖ AU MOINS une step avec is_summary: true
      - ‚úÖ summary_stats de la step r√©cap contient 4-8 items

      Si une validation √©choue : RETOURNER un JSON d'erreur avec :
      ```yaml
      error: true
      error_message: "Description pr√©cise de l'erreur"
      failed_validations: ["liste des validations √©chou√©es"]
      ```

      ‚ö†Ô∏è **EXCEPTION IMPORTANTE : DESTINATION**
      - Si la destination est "Destination √† pr√©ciser" ou vide : C'EST UN WARNING, PAS UNE ERREUR BLOQUANTE
      - Le trip peut √™tre g√©n√©r√© avec une destination placeholder
      - Logger un warning dans un champ `warnings`mais NE PAS rejeter le JSON complet

      ---

      ## **EXEMPLE COMPLET DE JSON FINAL ATTENDU**

      ```yaml
      trip:
        code: "TOKYO-2025"
        destination: "Tokyo, Japon üáØüáµ"
        destination_en: "Tokyo, Japan üáØüáµ"
        total_days: 7
        main_image: "[URL_RETOURN√âE_PAR_OUTIL_MCP]"

        flight_from: "Bruxelles"
        flight_to: "Tokyo"
        flight_duration: "12h30"
        flight_type: "Vol direct"

        hotel_name: "Hotel Gracery Shinjuku"
        hotel_rating: 4.3

        total_price: "3 885‚Ç¨"
        total_budget: "3 885‚Ç¨"
        average_weather: "22¬∞C"

        travel_style: "Culture & Gastronomie"
        travel_style_en: "Culture & Food"

        start_date: "2025-12-15"
        travelers: 2

        price_flights: "2 600‚Ç¨"
        price_hotels: "840‚Ç¨"
        price_transport: "200‚Ç¨"
        price_activities: "245‚Ç¨"

        steps:
          - step_number: 1
            day_number: 1
            title: "Arriv√©e √† Tokyo"
            subtitle: "Installation et premi√®re d√©couverte de Shibuya"
            main_image: "[URL_RETOURN√âE_PAR_OUTIL_MCP]"
            step_type: "activit√©"
            latitude: 35.6595
            longitude: 139.7004
            duration: "2h"
            price: 0
            why: "Shibuya Crossing est l'un des passages pi√©tons les plus embl√©matiques au monde."
            tips: "Visitez en fin d'apr√®s-midi pour voir le crossing illumin√©."
            weather_icon: "üå§Ô∏è"
            weather_temp: "22¬∞C"

          - step_number: 2
            day_number: 1
            title: "D√Æner √† Shibuya"
            main_image: "[URL_RETOURN√âE_PAR_OUTIL_MCP]"
            step_type: "restaurant"
            latitude: 35.6612
            longitude: 139.6988
            duration: "1h30"
            price: 35
            why: "D√©couverte de la cuisine locale dans le quartier anim√©."
            tips: "Testez un izakaya pour une exp√©rience authentique."

          # [...] Toutes les autres steps

          - step_number: 15
            day_number: 7
            title: "R√©sum√© du voyage"
            subtitle: "7 jours ‚Äî Tokyo, Japon üáØüáµ"
            main_image: "[URL_RETOURN√âE_PAR_OUTIL_MCP]"
            is_summary: true
            step_type: "r√©capitulatif"
            duration: "‚Äî"
            price: 0
            summary_stats:
              - type: days
                value: 7
              - type: budget
                value: "3 885‚Ç¨"
              - type: weather
                value: "22¬∞C"
              - type: style
                value: "Culture & Gastronomie"
              - type: cities
                value: 1
              - type: people
                value: 2
              - type: activities
                value: 14
              - type: custom
                value: "Direct"
                icon: "Plane"
                label: "VOL"
                color: "golden"
      ```

      ---

      **CHECKLIST FINALE :**
      - ‚úÖ Tous les champs obligatoires pr√©sents (code, total_days, steps)
      - ‚úÖ Code unique g√©n√©r√©/valid√©
      - ‚ö†Ô∏è Destination pr√©sente (peut √™tre un placeholder si agent strategist a √©chou√©)
      - ‚úÖ Toutes les steps valid√©es
      - ‚úÖ Toutes les main_image sont des URLs Supabase
      - ‚úÖ Toutes les steps ont GPS (sauf transport/r√©cap)
      - ‚úÖ Step r√©capitulative pr√©sente avec summary_stats
      - ‚úÖ JSON conforme au sch√©ma Trip

    expected_output: |-
      Un YAML STRICT contenant uniquement la cl√© `trip` avec tout le JSON final.

      **STRUCTURE :**
      ```yaml
      trip:
        code: "..."
        destination: "..."
        # [...] tous les champs
        steps:
          - step_number: 1
            # [...]
      ```

      ‚ö†Ô∏è **SI ERREURS DE VALIDATION :**
      ```yaml
      error: true
      error_message: "Description de l'erreur"
      failed_validations:
        - "Step 3 manque latitude/longitude"
        - "Step 5 a une main_image invalide (URL externe)"
      ```

      **NE JAMAIS PRODUIRE DE JSON.**

    async_execution: false
