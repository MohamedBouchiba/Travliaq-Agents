tasks:
  # ==========================================================================
  # TASK 1: TRIP CONTEXT BUILDING
  # ==========================================================================
  trip_context_building:
    description: |-
      Tu re√ßois le questionnaire utilisateur et l'inf√©rence persona. Ta mission :
      extraire et structurer les informations critiques pour cr√©er un contexte
      clair que tous les autres agents utiliseront.

      **QUESTIONNAIRE (YAML):**
      {questionnaire}

      **INF√âRENCE PERSONA (YAML):**
      {persona_context}

      **INFORMATIONS √Ä EXTRAIRE :**

      1. **Destination** :
         - has_destination: yes/no (du questionnaire)
         - destination_provided: [nom exact si fourni] ou null
         - destination_type: city/region/country

      2. **Dates** :
         - dates_type: fixed/flexible/no_dates
         - departure_date: [YYYY-MM-DD] si fixed
         - return_date: [YYYY-MM-DD] si fixed
         - departure_window: {start, end} si flexible
         - return_window: {start, end} si flexible
         - duration_nights: [nombre] (obligatoire)

      3. **Voyageurs** :
         - travel_group: solo/duo/group35/family
         - travelers_count: [nombre]
         - children_count: [nombre] si family
         - travelers_details: [liste si fournie]

      4. **Budget** :
         - budget_amount: [nombre] (par personne ou total selon context)
         - budget_currency: EUR/USD/etc.
         - budget_type: per_person/total_group
         - budget_range: {min, max} si fourni

      5. **Services demand√©s** :
         - help_with: [liste] (flights, accommodation, activities)
         - Si vide ou null, consid√©rer comme ["flights", "accommodation", "activities"]

      6. **Pr√©f√©rences voyage** :
         - rhythm: relaxed/balanced/intense (si activities demand√©)
         - schedule_prefs: [liste] (Matinal, Flexible, Couche-tard)
         - styles: [liste] (Culture, Gastronomie, Nature, etc.)
         - mobility: [liste] (Voiture, Transports en commun, V√©lo, √Ä pied)

      7. **Contraintes** :
         - constraints: [liste] (Allergies, Handicap, Animal, etc.)
         - security_level: low/medium/high (inf√©r√© ou fourni)

      8. **Pr√©f√©rences vols** (si flights dans help_with) :
         - departure_location: [ville, pays]
         - flight_preference: direct/1_escale/flexible
         - luggage: cabin_only/checked_included

      9. **Pr√©f√©rences h√©bergement** (si accommodation dans help_with) :
         - accommodation_type: [liste] (H√¥tel, Appartement, Auberge)
         - comfort: economique/standard/confort/luxe
         - hotel_preferences: [liste] (Petit-d√©jeuner, Annulation gratuite, etc.)
         - neighborhood: centre/calme/transports
         - equipment: [liste] (WiFi, Piscine, Parking, etc.)

      **D√âTECTION D'INCOH√âRENCES :**
      - Si dates fixed mais pas de departure_date ‚Üí WARN
      - Si budget_amount = 0 ou null ‚Üí WARN
      - Si has_destination=yes mais pas de destination fournie ‚Üí WARN
      - Si duration_nights manquant ‚Üí calculer depuis dates ou mettre null

      **R√àGLES CRITIQUES :**
      - NE JAMAIS inventer d'informations absentes
      - Si info manquante ‚Üí null
      - Si incoh√©rence ‚Üí signaler dans warnings
      - Toujours inclure current_year: {current_year}

    expected_output: |-
      Un YAML structur√© STRICT avec TOUTES les informations extraites :

      ```yaml
      trip_context:
        destination:
          has_destination: yes  # ou no
          destination_provided: "Tokyo, Japon"  # ou null
          destination_type: city  # ou region, country, null

        dates:
          dates_type: fixed  # ou flexible, no_dates
          departure_date: "2025-12-15"  # ou null
          return_date: "2025-12-22"  # ou null
          departure_window:  # si flexible
            start: "2025-12-10"
            end: "2025-12-20"
          return_window:  # si flexible
            start: "2025-12-17"
            end: "2025-12-27"
          duration_nights: 7

        travelers:
          travel_group: duo  # solo, duo, group35, family
          travelers_count: 2
          children_count: 0  # ou nombre si family
          travelers_details: []  # ou liste si fournie

        budget:
          budget_amount: 1500
          budget_currency: EUR
          budget_type: per_person  # ou total_group
          budget_range:
            min: 1200
            max: 1800

        services_requested:
          help_with: ["flights", "accommodation", "activities"]
          flights_needed: true
          accommodation_needed: true
          activities_needed: true

        preferences:
          rhythm: balanced  # relaxed, balanced, intense
          schedule_prefs: ["Flexible"]
          styles: ["Culture", "Gastronomie"]
          mobility: ["Transports en commun", "√Ä pied"]

        constraints:
          constraints_list: []  # ou liste
          security_level: medium  # low, medium, high

        flights_prefs:  # si flights_needed
          departure_location: "Bruxelles, Belgique"
          flight_preference: direct  # direct, 1_escale, flexible
          luggage: checked_included  # cabin_only, checked_included

        accommodation_prefs:  # si accommodation_needed
          accommodation_type: ["H√¥tel"]
          comfort: confort  # economique, standard, confort, luxe
          hotel_preferences: ["Petit-d√©jeuner inclus", "Annulation gratuite"]
          neighborhood: centre  # centre, calme, transports
          equipment: ["WiFi gratuit", "Piscine"]

        warnings: []  # Liste des incoh√©rences d√©tect√©es
        current_year: 2025
      ```

      **NE JAMAIS PRODUIRE DE JSON.**

    async_execution: false

  # ==========================================================================
  # TASK 2: DESTINATION STRATEGY
  # ==========================================================================
  destination_strategy:
    description: |-
      Tu re√ßois le trip_context de la t√¢che pr√©c√©dente. Ta mission d√©pend de has_destination.

      **IMPORTANT** : Le trip_context est disponible dans l'output de la t√¢che pr√©c√©dente.
      Utilise les informations de destination, dates, budget, styles, etc. pour effectuer ta strat√©gie.

      **ANN√âE ACTUELLE :** {current_year}

      ---

      ## **CAS A : has_destination = yes (Destination fournie)**

      L'utilisateur a fourni une destination. Tu dois :

      1. **Valider la destination** avec geo.text_to_place(query="Tokyo")
         - Obtenir les coordonn√©es GPS (latitude, longitude)
         - V√©rifier que la destination existe

      2. **Enrichir avec places.overview(query="Tokyo")**
         - Obtenir des infos suppl√©mentaires (pays, r√©gion, etc.)

      3. **M√©t√©o estim√©e** :
         - Utiliser les dates du voyage pour estimer la m√©t√©o moyenne
         - Format: "22¬∞C" ou "20-25¬∞C"

      4. **G√©n√©rer le CODE VOYAGE unique** :
         - Format: [DESTINATION]-[THEME/STYLE]-[ANNEE]
         - Exemples:
           * "TOKYO-CULTURE-2025" (Tokyo, voyage culturel)
           * "BALI-WELLNESS-2025" (Bali, voyage bien-√™tre)
           * "ICELAND-ADVENTURE-2025" (Islande, voyage aventure)
           * "PARIS-ROMANCE-2025" (Paris, voyage romantique)
           * "NYC-BUSINESS-2025" (New York, voyage d'affaires)
         - R√®gles:
           * MAJUSCULES uniquement
           * Remplacer espaces/caract√®res sp√©ciaux par -
           * Max 30 caract√®res au total
           * Le THEME doit refl√©ter le style principal du voyage (ex: CULTURE, ADVENTURE, WELLNESS, GASTRONOMY, ROMANCE, FAMILY, BUSINESS, NATURE, BEACH, CITY)
           * Si plusieurs styles : choisir le plus dominant

      5. **Style de voyage** :
         - Bas√© sur les styles du trip_context
         - Exemple: "Culture & Gastronomie", "Nature & Aventure"

      **OUTPUT ATTENDU pour CAS A :**
      ```yaml
      destination_choice:
        method: validated  # destination fournie par utilisateur
        code: "TOKYO-CULTURE-2025"  # Format: DESTINATION-THEME-YEAR
        destination: "Tokyo, Japon üáØüáµ"
        destination_en: "Tokyo, Japan üáØüáµ"
        latitude: 35.6762
        longitude: 139.6503
        country: "Japon"
        region: "Kant≈ç"
        average_weather: "22¬∞C"
        travel_style: "Culture & Gastronomie"
        travel_style_en: "Culture & Food"
        total_days: 7  # depuis trip_context
        validation_notes: "Destination valid√©e via geo.text_to_place"
      ```

      ---

      ## **CAS B : has_destination = no (Pas de destination)**

      L'utilisateur n'a pas de destination. Tu dois :

      1. **Proposer 3-5 destinations** compatibles avec :
         - Budget (budget_amount, budget_currency)
         - Dates (departure_date ou departure_window)
         - Dur√©e (duration_nights)
         - Styles (preferences.styles)
         - Voyageurs (travel_group, travelers_count)

      2. **Pour CHAQUE destination propos√©e** :
         - Utiliser geo.text_to_place(query="Bali") pour GPS
         - Utiliser places.overview(query="Bali") pour infos
         - Calculer un SCORE sur 100 :
           * Budget compatible (30 points)
           * Saison favorable (25 points)
           * S√©curit√© (20 points)
           * Match avec styles (15 points)
           * Accessibilit√© depuis departure_location (10 points)
         - Lister les RISQUES (m√©t√©o, s√©curit√©, visa, etc.)
         - Estimer le budget indicatif

      3. **Choisir LA MEILLEURE destination** :
         - Celle avec le score le plus √©lev√©
         - Justifier le choix avec 2-3 arguments clairs

      4. **G√©n√©rer le CODE VOYAGE** pour la destination choisie

      **OUTPUT ATTENDU pour CAS B :**
      ```yaml
      destination_choice:
        method: scouted  # destination choisie par l'agent

        options_considered:
          - city: "Bali"
            country: "Indon√©sie"
            latitude: -8.3405
            longitude: 115.0920
            score: 87
            budget_fit: excellent  # excellent, good, acceptable
            season_fit: parfaite  # parfaite, bonne, moyenne
            risks: ["Saison des pluies partielle"]
            indicative_budget: "1200-1500‚Ç¨"
            justification: "Destination tropicale id√©ale pour culture et nature, budget compatible"

          - city: "Lisbonne"
            country: "Portugal"
            latitude: 38.7223
            longitude: -9.1393
            score: 82
            budget_fit: excellent
            season_fit: bonne
            risks: []
            indicative_budget: "1100-1400‚Ç¨"
            justification: "Ville culturelle et gastronomique, proche de Bruxelles"

          - city: "Marrakech"
            country: "Maroc"
            latitude: 31.6295
            longitude: -7.9811
            score: 78
            budget_fit: good
            season_fit: moyenne
            risks: ["Chaleur √©lev√©e en √©t√©"]
            indicative_budget: "1000-1300‚Ç¨"
            justification: "Destination exotique et culturelle, budget attractif"

        # DESTINATION CHOISIE (score le plus √©lev√©)
        code: "BALI-CULTURE-2025"  # Format: DESTINATION-THEME-YEAR
        destination: "Bali, Indon√©sie üáÆüá©"
        destination_en: "Bali, Indonesia üáÆüá©"
        latitude: -8.3405
        longitude: 115.0920
        country: "Indon√©sie"
        region: "Bali"
        average_weather: "28¬∞C"
        travel_style: "Culture & Nature"
        travel_style_en: "Culture & Nature"
        total_days: 7
        decision_rationale: |-
          Bali a √©t√© choisie (score: 87/100) pour 3 raisons principales :
          1. Budget parfaitement compatible (1200-1500‚Ç¨ vs 1500‚Ç¨ demand√©)
          2. Destination id√©ale pour Culture & Nature (match avec vos styles)
          3. Saison favorable avec m√©t√©o agr√©able (28¬∞C en moyenne)
      ```

      ---

      **R√àGLES CRITIQUES :**
      - TOUJOURS utiliser geo.text_to_place pour obtenir GPS
      - TOUJOURS g√©n√©rer le CODE VOYAGE (format: DESTINATION-THEME-YEAR)
      - Si CAS B : proposer AU MOINS 3 destinations
      - Documenter toutes les sources MCP utilis√©es
      - NE JAMAIS inventer de coordonn√©es GPS

    expected_output: |-
      Un YAML STRICT avec la structure destination_choice (CAS A ou CAS B selon has_destination).

      **NE JAMAIS PRODUIRE DE JSON.**

    async_execution: false

  # ==========================================================================
  # TASK 3: FLIGHTS RESEARCH
  # ==========================================================================
  flights_research:
    description: |-
      üö® **R√àGLES ANTI-HALLUCINATION** üö®
      - ‚úÖ OBLIGATION : Utiliser UNIQUEMENT flights.prices pour les estimations de prix
      - ‚úÖ OBLIGATION : Utiliser airports.nearest pour trouver les a√©roports
      - ‚ùå INTERDICTION : Inventer des prix ou des horaires de vol
      - ‚ùå INTERDICTION : Utiliser des donn√©es obsol√®tes ou approximatives
      - ‚ö†Ô∏è Si aucun tool disponible : SIGNALER "Donn√©es indisponibles" avec raison
      - ‚ö†Ô∏è Si tool √©choue : INDIQUER l'erreur pr√©cise, NE PAS inventer de donn√©es

      ---

      Tu re√ßois le trip_context et la destination_choice. Ta mission : rechercher
      et estimer les vols UNIQUEMENT via les tools MCP.

      **CONTEXTE VOYAGE :**
      {trip_context}

      **DESTINATION CHOISIE :**
      {destination_choice}

      **DATES VALID√âES :**
      - D√©part : {validated_departure_dates}
      - Retour : {validated_return_dates}

      **ANN√âE ACTUELLE :** {current_year}

      ---

      **PROCESSUS OBLIGATOIRE :**

      1. **Identifier les a√©roports** :
         - Origine : airports.nearest(city="Bruxelles") depuis trip_context.flights_prefs.departure_location
         - Destination : airports.nearest(city="Tokyo") depuis destination_choice.destination

      2. **Rechercher les vols** :
         - Utiliser flights.prices(origin="BRU", destination="NRT", departure="2025-12-15")
         - R√àGLE CRITIQUE : dates >= {current_year}-12-02 (JAMAIS de dates 2023 ou 2024)
         - Respecter flight_preference (direct/1_escale/flexible)

      3. **S√©lectionner la meilleure option** :
         - Prioriser selon flight_preference
         - V√©rifier compatibilit√© avec budget

      4. **Estimer les bagages** :
         - Si luggage=cabin_only : 0‚Ç¨ suppl√©mentaire
         - Si luggage=checked_included : +30-50‚Ç¨ par personne

      **SI OUTILS MCP √âCHOUENT :**
      - Fournir une estimation prudente bas√©e sur :
        * Distance approximative
        * Prix moyens connus pour cette route
        * Mentionner explicitement que c'est une estimation

      **CALCUL DU PRIX TOTAL :**
      - Prix vol aller-retour √ó nombre de voyageurs
      - + Bagages si checked_included
      - Arrondir √† la dizaine sup√©rieure

    expected_output: |-
      Un YAML STRICT avec la structure flight_quotes :

      ```yaml
      flight_quotes:
        origin:
          city: "Bruxelles"
          airport_code: "BRU"
          airport_name: "Brussels Airport"

        destination:
          city: "Tokyo"
          airport_code: "NRT"
          airport_name: "Narita International Airport"

        outbound:
          departure_date: "2025-12-15"
          duration: "12h30"
          stops: 0  # 0 pour direct, 1 pour 1 escale
          airline: "Brussels Airlines"
          price_per_person: 650

        inbound:
          departure_date: "2025-12-22"
          duration: "13h00"
          stops: 0
          airline: "Brussels Airlines"
          price_per_person: 650

        total:
          price_per_person: 1300
          travelers_count: 2
          total_price: 2600
          currency: EUR
          luggage_included: true
          luggage_cost: 0  # ou montant si cabin_only et bagages ajout√©s

        summary:
          from: "Bruxelles (BRU)"
          to: "Tokyo (NRT)"
          duration: "12h30"
          type: "Vol direct"  # ou "1 escale" ou "2 escales"
          price: "2 600‚Ç¨"

        sources: ["flights.prices", "airports.nearest"]
        notes: "Prix indicatifs bas√©s sur recherche MCP"
      ```

      **NE JAMAIS PRODUIRE DE JSON.**

    async_execution: false

  # ==========================================================================
  # TASK 4: ACCOMMODATION RESEARCH
  # ==========================================================================
  accommodation_research:
    description: |-
      üö® **R√àGLES ANTI-HALLUCINATION** üö®
      - ‚úÖ OBLIGATION : Utiliser UNIQUEMENT booking.search pour rechercher h√©bergements
      - ‚úÖ OBLIGATION : Utiliser booking.details pour d√©tails si disponible
      - ‚ùå INTERDICTION ABSOLUE : Inventer noms d'h√¥tels, prix, ou notes
      - ‚ùå INTERDICTION ABSOLUE : Utiliser des donn√©es approximatives
      - ‚ö†Ô∏è Si booking.search √©choue : SIGNALER explicitement et fournir estimation PRUDENTE
      - ‚ö†Ô∏è TOUJOURS mentionner la source (booking.search result ou estimation)

      ---

      Tu re√ßois le trip_context et la destination_choice. Ta mission : rechercher
      et estimer les h√©bergements UNIQUEMENT via booking.search.

      **CONTEXTE VOYAGE :**
      {trip_context}

      **DESTINATION CHOISIE :**
      {destination_choice}

      **DATES VALID√âES :**
      - Check-in : {validated_departure_dates}
      - Check-out : {validated_return_dates}

      **ANN√âE ACTUELLE :** {current_year}

      ---

      **PROCESSUS OBLIGATOIRE :**

      1. **Valider la destination avec places.overview(query="Tokyo")** :
         - Obtenir les quartiers populaires
         - Identifier le centre-ville

      2. **Rechercher les h√©bergements avec booking.search** :
         - Param√®tres : city="Tokyo", checkin="2025-12-15", checkout="2025-12-22"
         - Filtrer par type : accommodation_type (H√¥tel, Appartement, etc.)
         - Filtrer par confort : comfort (√©conomique=1-2‚òÖ, standard=3‚òÖ, confort=4‚òÖ, luxe=5‚òÖ)
         - Filtrer par quartier : neighborhood (centre/calme/transports)
         - Filtrer par √©quipements : equipment (WiFi, Piscine, etc.)

      3. **S√©lectionner 1-3 options** :
         - Meilleur rapport qualit√©/prix
         - Compatible avec budget
         - Match avec pr√©f√©rences (hotel_preferences)

      4. **Pour chaque h√©bergement** :
         - Nom complet
         - Note moyenne (/5)
         - Prix par nuit
         - Quartier
         - √âquipements principaux
         - Lien si disponible

      **SI OUTILS MCP √âCHOUENT :**
      - Fournir une estimation prudente bas√©e sur :
        * Prix moyens connus pour cette destination
        * Confort demand√© (√©toiles)
        * Mentionner explicitement que c'est une estimation

      **CALCUL DU PRIX TOTAL :**
      - Prix par nuit √ó nombre de nuits √ó nombre de chambres
      - Arrondir √† la dizaine sup√©rieure

    expected_output: |-
      Un YAML STRICT avec la structure lodging_quotes :

      ```yaml
      lodging_quotes:
        destination:
          city: "Tokyo"
          country: "Japon"
          neighborhood_searched: "Shibuya"

        search_criteria:
          checkin: "2025-12-15"
          checkout: "2025-12-22"
          nights: 7
          travelers: 2
          rooms_needed: 1
          type: ["H√¥tel"]
          comfort: confort  # √©conomique, standard, confort, luxe
          stars: 4

        options:
          - hotel_name: "Hotel Gracery Shinjuku"
            hotel_rating: 4.3
            stars: 4
            neighborhood: "Shinjuku"
            price_per_night: 120
            total_price: 840
            currency: EUR
            amenities: ["WiFi gratuit", "Restaurant", "Climatisation"]
            url: "https://booking.com/hotel/..."
            notes: "H√¥tel central avec excellent rapport qualit√©/prix"

          - hotel_name: "Shibuya Excel Hotel Tokyu"
            hotel_rating: 4.5
            stars: 4
            neighborhood: "Shibuya"
            price_per_night: 140
            total_price: 980
            currency: EUR
            amenities: ["WiFi gratuit", "Petit-d√©jeuner inclus", "Vue panoramique"]
            url: "https://booking.com/hotel/..."
            notes: "Emplacement id√©al avec vue sur Shibuya"

        recommended:
          hotel_name: "Hotel Gracery Shinjuku"
          hotel_rating: 4.3
          total_price: 840
          price_display: "840‚Ç¨"
          neighborhood: "Shinjuku"
          justification: "Meilleur rapport qualit√©/prix, quartier central anim√©"

        summary:
          accommodation_type: "H√¥tel 4‚òÖ"
          nights: 7
          rooms: 1
          total_price: 840
          price_per_night_avg: 120
          currency: EUR
          price_display: "840‚Ç¨"

        sources: ["booking.search", "places.overview"]
        notes: "Prix indicatifs pour 2 voyageurs, 1 chambre double"
      ```

      **NE JAMAIS PRODUIRE DE JSON.**

    async_execution: false

  # ==========================================================================
  # TASK 5: ITINERARY DESIGN (C≈íUR DE LA PIPELINE)
  # ==========================================================================
  itinerary_design:
    description: |-
      üéØ **TU ES LE C≈íUR DE LA PIPELINE. Cette t√¢che est LA PLUS IMPORTANTE.**

      üö® **R√àGLES ANTI-HALLUCINATION CRITIQUES** üö®
      - ‚úÖ OBLIGATION ABSOLUE : Utiliser geo.text_to_place pour CHAQUE step (GPS)
      - ‚úÖ OBLIGATION ABSOLUE : Utiliser images.hero UNE FOIS pour hero_image (avec retry si √©chec)
      - ‚úÖ OBLIGATION ABSOLUE : Utiliser images.background pour CHAQUE step (avec retry si √©chec)
      - ‚ùå INTERDICTION TOTALE : URLs Wikipedia, Unsplash, Pexels, ou externes
      - ‚ùå INTERDICTION TOTALE : Inventer des coordonn√©es GPS
      - ‚ùå INTERDICTION TOTALE : Inventer des lieux qui n'existent pas
      - ‚ö†Ô∏è Si geo.text_to_place √©choue : ESSAYER un autre nom, NE PAS inventer GPS
      - ‚ö†Ô∏è Si images √©chouent : RETRY puis utiliser placeholder, NE PAS bloquer la pipeline
      - üéØ PRIORIT√â : Pertinence > Quantit√©. Mieux vaut 1 step parfaite que 3 approximatives
      - üõ°Ô∏è R√âSISTANCE : La pipeline doit continuer m√™me en cas d'√©checs partiels de tools

      ---

      Tu re√ßois tout le contexte et tu dois concevoir un itin√©raire complet jour par jour.

      **CONTEXTE VOYAGE :**
      {trip_context}

      **DESTINATION CHOISIE :**
      {destination_choice}

      **ANN√âE ACTUELLE :** {current_year}

      ---

      ## **R√àGLES ABSOLUES - √Ä RESPECTER IMP√âRATIVEMENT**

      ### **1. NOMBRE DE STEPS PAR JOUR (FLEXIBLE)**
      - ‚ö†Ô∏è **PAS DE NOMBRE FIXE** : Adapter le nombre de steps selon le contexte
      - **MINIMUM ABSOLU : 1 step par jour**
      - **MAXIMUM ABSOLU : 3 steps par jour**
      - **RECOMMANDATION** : Adapter selon rhythm ET type de journ√©e :
        * relaxed : 1-2 steps/jour (privil√©gier 1 step longue et immersive)
        * balanced : 1-2 steps/jour (2 steps si activit√©s courtes, 1 si activit√© longue)
        * intense : 2-3 steps/jour (varier entre 2 et 3 selon fatigue)
      - üéØ **PRIORIT√â : PERTINENCE > QUANTIT√â**
        * Mieux vaut 1 visite exceptionnelle de 4h qu'ajouter 2 steps moyennes
        * Respecter les temps de transport, pauses, repas
        * √âviter de surcharger les journ√©es juste pour atteindre un quota

      ### **2. COORDONN√âES GPS OBLIGATOIRES**
      Pour CHAQUE step (sauf steps de type "transport" ou "r√©capitulatif") :
      - Appeler geo.text_to_place(query="Tokyo Tower") OU places.overview(query="Tokyo Tower")
      - Extraire latitude et longitude
      - NE JAMAIS inventer de coordonn√©es GPS
      - Si tool √©choue : signaler l'erreur et essayer un autre nom

      ### **3. IMAGES SUPABASE OBLIGATOIRES**

      **√âTAPE A : Image Hero (UNE FOIS AU D√âBUT)**
      ```
      images.hero(
        city="Tokyo",
        country="Japon",
        trip_name="Tokyo Adventure",
        trip_folder="tokyo-2025-abc123"
      )
      ```
      ‚Üí Tu re√ßois : `{"url": "https://xznsdvvfqoztlqtqhkhv.supabase.co/storage/v1/object/public/TRIPS/tokyo-2025-abc123/hero_1733155800.jpg", "type": "hero"}`

      ‚Üí **COPIE CETTE URL** dans le champ `hero_image` de ton output

      **√âTAPE B : Images Background (POUR CHAQUE STEP)**
      Pour step 1 - "Tokyo Tower" :
      ```
      images.background(
        activity="visiting Tokyo Tower",
        city="Tokyo",
        country="Japon",
        trip_name="Tokyo Adventure",
        trip_folder="tokyo-2025-abc123"
      )
      ```
      ‚Üí Tu re√ßois : `{"url": "https://xznsdvvfqoztlqtqhkhv.supabase.co/storage/v1/object/public/TRIPS/tokyo-2025-abc123/background_1733155920.jpg", "type": "background"}`

      ‚Üí **COPIE CETTE URL** dans le champ `main_image` de cette step

      Pour step 2 - "Senso-ji Temple" :
      ```
      images.background(
        activity="exploring Senso-ji Temple",
        city="Tokyo",
        country="Japon",
        trip_name="Tokyo Adventure",
        trip_folder="tokyo-2025-abc123"
      )
      ```
      ‚Üí **COPIE L'URL RETOURN√âE** dans le champ `main_image` de cette step

      **R√àGLES CRITIQUES POUR LES IMAGES :**
      - ‚ùå JAMAIS d'URLs Wikipedia
      - ‚ùå JAMAIS d'URLs Unsplash
      - ‚ùå JAMAIS d'URLs Pexels ou autre source externe
      - ‚úÖ TOUJOURS utiliser les URLs retourn√©es par images.hero et images.background
      - ‚úÖ URLs commencent par "https://xznsdvvfqoztlqtqhkhv.supabase.co/storage/v1/object/public/TRIPS/"

      **GESTION DES ERREURS IMAGES (R√âSISTANCE AUX √âCHECS) :**
      - ‚ö†Ô∏è Si images.hero √©choue :
        * RETRY une fois avec des param√®tres l√©g√®rement diff√©rents
        * Si √©chec persistant : utiliser URL placeholder sp√©ciale "HERO_IMAGE_GENERATION_FAILED"
        * Continuer l'ex√©cution normalement pour les images.background
        * NE PAS bloquer toute la pipeline pour une erreur d'image
      - ‚ö†Ô∏è Si images.background √©choue pour UNE step :
        * RETRY une fois avec description simplifi√©e
        * Si √©chec persistant : utiliser "BACKGROUND_IMAGE_GENERATION_FAILED"
        * Continuer avec les autres steps
        * Documenter l'erreur dans un champ notes de la step
      - üéØ **PRINCIPE : La pipeline doit √™tre R√âSISTANTE aux √©checs d'images**
        * Les images enrichissent l'exp√©rience mais ne doivent PAS bloquer le voyage
        * En cas d'√©chec massif d'images : compl√©ter l'itin√©raire avec donn√©es GPS/texte valides

      ### **4. STRUCTURE DE CHAQUE STEP**

      Champs OBLIGATOIRES :
      - step_number : num√©ro d'ordre (1, 2, 3, ...)
      - day_number : jour du voyage (1, 2, 3, ...)
      - title : titre court et accrocheur
      - main_image : URL Supabase (depuis images.background)

      Champs FORTEMENT RECOMMAND√âS :
      - latitude : GPS (depuis geo.text_to_place)
      - longitude : GPS (depuis geo.text_to_place)
      - why : pourquoi visiter (2-3 phrases)
      - tips : conseils pratiques (2-3 phrases)
      - duration : dur√©e estim√©e (ex: "2h", "3h30", "Demi-journ√©e")
      - price : prix estim√© en euros (nombre, ex: 15, 25, 0 pour gratuit)

      Champs OPTIONNELS :
      - subtitle : sous-titre descriptif
      - step_type : activit√©/visite/restaurant/transport/h√©bergement
      - transfer : comment se rendre depuis step pr√©c√©dente
      - weather_icon : emoji m√©t√©o (üå§Ô∏è, ‚òÄÔ∏è, ‚õÖ)
      - weather_temp : temp√©rature estim√©e

      ### **5. STEP R√âCAPITULATIVE FINALE**

      TOUJOURS ajouter une derni√®re step de type "r√©capitulatif" :
      - is_summary: true
      - step_number : dernier num√©ro
      - day_number : dernier jour
      - title : "R√©sum√© du voyage"
      - subtitle : "[X] jours ‚Äî [Destination]"
      - main_image : r√©utiliser hero_image
      - summary_stats : 4-8 statistiques (voir ci-dessous)

      **SUMMARY_STATS (4 √† 8 items obligatoires) :**
      Types disponibles :
      - days : nombre de jours
      - budget : budget total
      - weather : m√©t√©o moyenne
      - style : style de voyage
      - cities : nombre de villes
      - people : nombre de voyageurs
      - activities : nombre d'activit√©s
      - custom : statistique personnalis√©e (avec icon, label, color)

      Exemple :
      ```yaml
      summary_stats:
        - type: days
          value: 7
        - type: budget
          value: "3 500‚Ç¨"
        - type: weather
          value: "22¬∞C"
        - type: style
          value: "Culture & Gastronomie"
        - type: cities
          value: 2
        - type: people
          value: 2
        - type: activities
          value: 12
        - type: custom
          value: "Direct"
          icon: "Plane"
          label: "VOL"
          color: "golden"
      ```

      ### **6. ADAPTATION AU RYTHME**

      **relaxed (tranquille)** :
      - 1-2 activit√©s/jour maximum
      - Dur√©e: 2-3h par activit√©
      - Inclure temps libre/repos
      - √âviter les journ√©es charg√©es

      **balanced (√©quilibr√©)** :
      - 2 activit√©s/jour
      - Dur√©e: 2-4h par activit√©
      - Mix activit√©s + temps libre
      - Rythme confortable

      **intense (intense)** :
      - 2-3 activit√©s/jour
      - Dur√©e: 3-5h par activit√©
      - Journ√©es bien remplies
      - Optimisation des trajets

      ### **7. STYLES √Ä RESPECTER**

      Adapter les activit√©s selon styles du trip_context :
      - Culture : mus√©es, temples, sites historiques
      - Gastronomie : restaurants, march√©s, cours de cuisine
      - Nature : parcs, randonn√©es, plages
      - Aventure : sports, activit√©s outdoor
      - D√©tente : spa, plages, wellness
      - Nightlife : bars, clubs, spectacles

      ---

      ## **EXEMPLE COMPLET D'OUTPUT ATTENDU**

      ```yaml
      itinerary_plan:
        hero_image: "https://xznsdvvfqoztlqtqhkhv.supabase.co/storage/v1/object/public/TRIPS/tokyo-2025-abc123/hero_1733155800.jpg"

        steps:
          # JOUR 1
          - step_number: 1
            day_number: 1
            title: "Arriv√©e √† Tokyo"
            subtitle: "Installation et premi√®re d√©couverte de Shibuya"
            main_image: "https://xznsdvvfqoztlqtqhkhv.supabase.co/storage/v1/object/public/TRIPS/tokyo-2025-abc123/background_1733155900.jpg"
            step_type: "activit√©"
            latitude: 35.6595
            longitude: 139.7004
            duration: "2h"
            price: 0
            why: "Shibuya Crossing est l'un des passages pi√©tons les plus embl√©matiques au monde. Immersion imm√©diate dans l'√©nergie de Tokyo."
            tips: "Visitez en fin d'apr√®s-midi pour voir le crossing illumin√©. Montez au Shibuya Sky pour une vue panoramique (2000¬•)."
            transfer: "30 min en train depuis l'a√©roport Narita (3000¬•)"
            weather_icon: "üå§Ô∏è"
            weather_temp: "22¬∞C"

          - step_number: 2
            day_number: 1
            title: "D√Æner √† Shibuya"
            subtitle: "D√©couverte de la cuisine japonaise"
            main_image: "https://xznsdvvfqoztlqtqhkhv.supabase.co/storage/v1/object/public/TRIPS/tokyo-2025-abc123/background_1733155920.jpg"
            step_type: "restaurant"
            latitude: 35.6612
            longitude: 139.6988
            duration: "1h30"
            price: 35
            why: "Profitez de votre premi√®re soir√©e pour d√©couvrir la cuisine locale dans le quartier anim√© de Shibuya."
            tips: "Testez un izakaya pour une exp√©rience authentique. R√©servation recommand√©e pour les restaurants populaires."

          # JOUR 2
          - step_number: 3
            day_number: 2
            title: "Senso-ji Temple"
            subtitle: "Le plus ancien temple de Tokyo"
            main_image: "https://xznsdvvfqoztlqtqhkhv.supabase.co/storage/v1/object/public/TRIPS/tokyo-2025-abc123/background_1733155940.jpg"
            step_type: "visite"
            latitude: 35.7147
            longitude: 139.7966
            duration: "3h"
            price: 0
            why: "Temple bouddhiste embl√©matique d'Asakusa, avec sa porte Kaminarimon et sa rue commer√ßante Nakamise."
            tips: "Arrivez t√¥t le matin (8h) pour √©viter la foule. Gratuit. Go√ªtez les ningyo-yaki (g√¢teaux traditionnels) dans Nakamise."
            transfer: "25 min en m√©tro depuis Shibuya"
            weather_icon: "‚òÄÔ∏è"
            weather_temp: "23¬∞C"

          - step_number: 4
            day_number: 2
            title: "Tokyo Skytree"
            subtitle: "Vue panoramique sur Tokyo"
            main_image: "https://xznsdvvfqoztlqtqhkhv.supabase.co/storage/v1/object/public/TRIPS/tokyo-2025-abc123/background_1733155960.jpg"
            step_type: "activit√©"
            latitude: 35.7101
            longitude: 139.8107
            duration: "2h"
            price: 25
            why: "Plus haute tour du Japon (634m) avec vue √† 360¬∞ sur Tokyo et le Mont Fuji (par temps clair)."
            tips: "R√©servez en ligne pour √©viter la file. Sunset recommand√©. Ticket: 2500¬• (Tembo Deck) ou 4000¬• (Tembo Galleria)."
            transfer: "10 min √† pied depuis Senso-ji"

          # JOUR 3
          - step_number: 5
            day_number: 3
            title: "Meiji Shrine"
            subtitle: "Sanctuaire shinto au c≈ìur d'une for√™t"
            main_image: "https://xznsdvvfqoztlqtqhkhv.supabase.co/storage/v1/object/public/TRIPS/tokyo-2025-abc123/background_1733155980.jpg"
            step_type: "visite"
            latitude: 35.6764
            longitude: 139.6993
            duration: "2h"
            price: 0
            why: "Sanctuaire paisible d√©di√© √† l'empereur Meiji, nich√© dans une for√™t de 100 000 arbres en plein Tokyo."
            tips: "Entr√©e gratuite. Participez √† une c√©r√©monie de purification. Visitez le jardin int√©rieur (500¬•)."
            transfer: "15 min en m√©tro depuis l'h√¥tel"
            weather_icon: "üå§Ô∏è"
            weather_temp: "21¬∞C"

          - step_number: 6
            day_number: 3
            title: "Harajuku & Takeshita Street"
            subtitle: "Quartier de la mode et de la pop culture"
            main_image: "https://xznsdvvfqoztlqtqhkhv.supabase.co/storage/v1/object/public/TRIPS/tokyo-2025-abc123/background_1733156000.jpg"
            step_type: "activit√©"
            latitude: 35.6702
            longitude: 139.7026
            duration: "3h"
            price: 30
            why: "√âpicentre de la mode kawaii et de la street culture japonaise. Boutiques uniques, cr√™pes g√©antes, cosplay."
            tips: "Visitez le dimanche pour voir les cosplayeurs. Go√ªtez les cr√™pes Marion (c√©l√®bres). Budget shopping √† pr√©voir."
            transfer: "5 min √† pied depuis Meiji Shrine"

          # [...] Continuer pour tous les jours jusqu'au dernier

          # JOUR 7 (dernier jour)
          - step_number: 13
            day_number: 7
            title: "Tsukiji Outer Market"
            subtitle: "March√© aux poissons et petit-d√©jeuner sushi"
            main_image: "https://xznsdvvfqoztlqtqhkhv.supabase.co/storage/v1/object/public/TRIPS/tokyo-2025-abc123/background_1733156100.jpg"
            step_type: "activit√©"
            latitude: 35.6654
            longitude: 139.7707
            duration: "2h"
            price: 25
            why: "March√© anim√© avec stands de street food et restaurants de sushi ultra-frais. Exp√©rience authentique avant le d√©part."
            tips: "Arrivez t√¥t (7h) pour le meilleur choix. D√©jeunez dans un sushi-ya du march√©. Comptez 3000¬•/personne."
            transfer: "20 min en m√©tro depuis l'h√¥tel"
            weather_icon: "‚òÄÔ∏è"
            weather_temp: "20¬∞C"

          - step_number: 14
            day_number: 7
            title: "D√©part de Tokyo"
            subtitle: "Vol retour vers Bruxelles"
            main_image: "https://xznsdvvfqoztlqtqhkhv.supabase.co/storage/v1/object/public/TRIPS/tokyo-2025-abc123/background_1733156120.jpg"
            step_type: "transport"
            duration: "3h"
            price: 0
            why: "Transfert vers l'a√©roport Narita et vol retour."
            tips: "Arrivez 3h avant le vol international. Narita Express : 3000¬•, 60 min."
            transfer: "Train Narita Express depuis Tokyo Station"

          # STEP R√âCAPITULATIVE (OBLIGATOIRE)
          - step_number: 15
            day_number: 7
            title: "R√©sum√© du voyage"
            subtitle: "7 jours ‚Äî Tokyo, Japon üáØüáµ"
            main_image: "https://xznsdvvfqoztlqtqhkhv.supabase.co/storage/v1/object/public/TRIPS/tokyo-2025-abc123/hero_1733155800.jpg"
            is_summary: true
            step_type: "r√©capitulatif"
            duration: "‚Äî"
            price: 0
            summary_stats:
              - type: days
                value: 7
              - type: budget
                value: "3 500‚Ç¨"
              - type: weather
                value: "22¬∞C"
              - type: style
                value: "Culture & Gastronomie"
              - type: cities
                value: 1
              - type: people
                value: 2
              - type: activities
                value: 13
              - type: custom
                value: "Direct"
                icon: "Plane"
                label: "VOL"
                color: "golden"
      ```

      ---

      **CHECKLIST FINALE AVANT DE SOUMETTRE TON OUTPUT :**
      - ‚úÖ 1-3 steps par jour pour CHAQUE jour du voyage
      - ‚úÖ TOUTES les steps ont latitude + longitude (sauf transport/r√©cap)
      - ‚úÖ TOUTES les steps ont main_image avec URL Supabase
      - ‚úÖ hero_image pr√©sent en haut avec URL Supabase
      - ‚úÖ Step r√©capitulative finale avec is_summary: true
      - ‚úÖ summary_stats avec 4-8 items
      - ‚úÖ AUCUNE URL Wikipedia, Unsplash ou externe
      - ‚úÖ Prix coh√©rents avec budget
      - ‚úÖ Rythme respect√© (relaxed/balanced/intense)
      - ‚úÖ Styles respect√©s (Culture, Gastronomie, etc.)

    expected_output: |-
      Un YAML STRICT avec la structure itinerary_plan (voir exemple complet ci-dessus).

      **NE JAMAIS PRODUIRE DE JSON.**

    async_execution: false

  # ==========================================================================
  # TASK 6: BUDGET CALCULATION
  # ==========================================================================
  budget_calculation:
    description: |-
      Tu re√ßois les outputs de tous les agents pr√©c√©dents. Ta mission : calculer
      le budget total et v√©rifier la coh√©rence avec le budget utilisateur.

      **CONTEXTE VOYAGE :**
      {trip_context}

      **VOLS :**
      {flight_quotes}

      **H√âBERGEMENT :**
      {lodging_quotes}

      **ITIN√âRAIRE :**
      {itinerary_plan}

      ---

      **PROCESSUS DE CALCUL :**

      1. **Extraire les co√ªts** :
         - Vols : flight_quotes.total.total_price
         - H√©bergement : lodging_quotes.recommended.total_price
         - Activit√©s : somme des itinerary_plan.steps[].price (sauf steps is_summary)
         - Transport local : estimer 10-15‚Ç¨/jour/personne

      2. **Calculer le total** :
         - Total = Vols + H√©bergement + Activit√©s + Transport local
         - Par personne = Total / travelers_count

      3. **Comparer avec budget utilisateur** :
         - Budget demand√© : trip_context.budget.budget_amount
         - Delta = (Total - Budget demand√©) / Budget demand√© √ó 100
         - Statut :
           * OK : delta ‚â§ 5%
           * WARN : 5% < delta ‚â§ 15%
           * EXCEED : delta > 15%

      4. **Proposer des ajustements si EXCEED** :
         - R√©duire h√©bergement (passer √† confort inf√©rieur)
         - R√©duire activit√©s payantes
         - Chercher vols moins chers (accepter escale)
         - R√©duire dur√©e du s√©jour

      **R√àGLES :**
      - Toujours arrondir √† la dizaine sup√©rieure
      - Fournir d√©tails par cat√©gorie
      - √ätre transparent sur les estimations vs prix r√©els

    expected_output: |-
      Un YAML STRICT avec la structure budget_summary :

      ```yaml
      budget_summary:
        breakdown:
          flights:
            total: 2600
            per_person: 1300
            currency: EUR
            source: "flight_quotes"

          accommodation:
            total: 840
            per_person: 420
            currency: EUR
            source: "lodging_quotes"

          activities:
            total: 245
            per_person: 122.5
            currency: EUR
            source: "itinerary_plan (somme des step.price)"
            details:
              - "Tokyo Skytree: 25‚Ç¨"
              - "Harajuku shopping: 30‚Ç¨"
              - "Tsukiji breakfast: 25‚Ç¨"
              - "Autres activit√©s: 165‚Ç¨"

          transport_local:
            total: 200
            per_person: 100
            currency: EUR
            source: "estimation (m√©tro + trains locaux)"
            notes: "Estimation bas√©e sur 7 jours √ó 15‚Ç¨/jour/personne"

        totals:
          grand_total: 3885
          per_person: 1942.5
          travelers_count: 2
          currency: EUR
          display: "3 885‚Ç¨"

        comparison:
          budget_requested: 1500
          budget_type: per_person  # ou total_group
          currency: EUR
          delta_amount: 442.5
          delta_percent: 29.5
          status: EXCEED  # OK, WARN, EXCEED

        adjustments:
          - category: "H√©bergement"
            current: 840
            proposed: 600
            saving: 240
            action: "Passer d'un h√¥tel 4‚òÖ √† un h√¥tel 3‚òÖ"

          - category: "Activit√©s"
            current: 245
            proposed: 180
            saving: 65
            action: "R√©duire shopping et activit√©s payantes"

        final_adjusted:
          grand_total: 3580
          per_person: 1790
          currency: EUR
          display: "3 580‚Ç¨"
          delta_percent: 19.3
          status: WARN  # toujours au-dessus mais acceptable

        recommendation: |-
          Le budget initial de 3 885‚Ç¨ d√©passe le budget demand√© de 1 500‚Ç¨/personne (3 000‚Ç¨ total) de 29.5%.
          Avec les ajustements propos√©s (h√©bergement 3‚òÖ + r√©duction activit√©s), le budget ajust√© est de 3 580‚Ç¨ (1 790‚Ç¨/personne),
          soit un d√©passement de 19.3% encore notable mais plus acceptable.

          Recommandation : Valider ces ajustements OU augmenter le budget √† 1 800‚Ç¨/personne.
      ```

      **NE JAMAIS PRODUIRE DE JSON.**

    async_execution: false

  # ==========================================================================
  # TASK 7: FINAL ASSEMBLY (AGENT INTELLIGENT)
  # ==========================================================================
  final_assembly:
    description: |-
      üéØ **TU ES LE DERNIER REMPART QUALIT√â. C'EST TOI QUI G√âN√àRES LE JSON FINAL.**

      üö® **R√àGLES ANTI-HALLUCINATION ULTRA-STRICTES** üö®
      - ‚úÖ OBLIGATION : COPIER EXACTEMENT les donn√©es depuis les outputs des agents
      - ‚ùå INTERDICTION TOTALE : Inventer, modifier, ou "am√©liorer" les donn√©es re√ßues
      - ‚ùå INTERDICTION TOTALE : Ajouter des steps non pr√©sentes dans itinerary_plan
      - ‚ùå INTERDICTION TOTALE : Accepter des main_image ne commen√ßant PAS par Supabase URL
      - ‚ùå INTERDICTION TOTALE : Accepter des steps sans GPS (sauf transport/r√©capitulatif)
      - üîç VALIDATION : Chaque step DOIT avoir step_number, day_number, title, main_image valide
      - üîç VALIDATION : Rejeter les steps invalides, NE PAS les "corriger"
      - üìä PRIORIT√â : Qualit√© > Quantit√©. Mieux vaut 5 steps parfaites que 20 approximatives
      - ‚ö†Ô∏è Si donn√©es manquantes : SIGNALER clairement dans un champ "warnings" ou "errors"
      - ‚ö†Ô∏è JAMAIS inventer de donn√©es pour "compl√©ter" un JSON incomplet

      ---

      Tu re√ßois TOUS les outputs des agents pr√©c√©dents. Ta mission : consolider et
      produire le JSON final conforme au sch√©ma Trip, pr√™t pour insertion en base de donn√©es.

      **DESTINATION CHOISIE :**
      {destination_choice}

      **VOLS :**
      {flight_quotes}

      **H√âBERGEMENT :**
      {lodging_quotes}

      **ITIN√âRAIRE :**
      {itinerary_plan}

      **BUDGET :**
      (Disponible depuis la t√¢che pr√©c√©dente budget_calculation - utilise l'output de cette t√¢che)

      **CONTEXTE VOYAGE :**
      {trip_context}

      ---

      ## **PROCESSUS D'ASSEMBLAGE**

      ### **1. CHAMPS TRIP (niveau racine)**

      **OBLIGATOIRES :**
      - code : depuis destination_choice.code (ex: "TOKYO-2025")
      - destination : depuis destination_choice.destination (ex: "Tokyo, Japon üáØüáµ")
      - total_days : depuis destination_choice.total_days ou trip_context.dates.duration_nights
      - steps : depuis itinerary_plan.steps (voir point 2)

      **RECOMMAND√âS :**
      - destination_en : depuis destination_choice.destination_en
      - main_image : depuis itinerary_plan.hero_image
      - flight_from : depuis flight_quotes.origin.city
      - flight_to : depuis flight_quotes.destination.city
      - flight_duration : depuis flight_quotes.outbound.duration
      - flight_type : depuis flight_quotes.summary.type
      - hotel_name : depuis lodging_quotes.recommended.hotel_name
      - hotel_rating : depuis lodging_quotes.recommended.hotel_rating
      - total_price : depuis budget_summary.totals.display
      - total_budget : depuis budget_summary.totals.display
      - average_weather : depuis destination_choice.average_weather
      - travel_style : depuis destination_choice.travel_style
      - travel_style_en : depuis destination_choice.travel_style_en
      - start_date : depuis trip_context.dates.departure_date (format: YYYY-MM-DD)
      - travelers : depuis trip_context.travelers.travelers_count
      - price_flights : depuis flight_quotes.summary.price
      - price_hotels : depuis lodging_quotes.summary.price_display
      - price_transport : depuis budget_summary.breakdown.transport_local.total + "‚Ç¨"
      - price_activities : depuis budget_summary.breakdown.activities.total + "‚Ç¨"

      ### **2. STEPS (tableau de steps)**

      **VALIDATION CRITIQUE DE CHAQUE STEP :**

      Pour CHAQUE step dans itinerary_plan.steps :

      ‚úÖ **V√©rifier champs OBLIGATOIRES :**
      - step_number : doit √™tre pr√©sent (integer)
      - day_number : doit √™tre pr√©sent (integer)
      - title : doit √™tre pr√©sent (string non vide)
      - main_image : doit √™tre pr√©sent ET commencer par "https://xznsdvvfqoztlqtqhkhv.supabase.co/storage/v1/object/public/TRIPS/"

      ‚ö†Ô∏è **SI main_image NE COMMENCE PAS PAR L'URL SUPABASE :**
      - ‚ùå REJETER CETTE STEP avec erreur explicite
      - üìù Logger : "Step [num√©ro] a une main_image invalide : [URL]"
      - üö´ NE PAS inclure cette step dans le JSON final

      ‚úÖ **V√©rifier latitude + longitude :**
      - Si step_type != "transport" ET step_type != "r√©capitulatif" :
        * latitude ET longitude DOIVENT √™tre pr√©sentes
        * Si absentes : ‚ùå REJETER avec erreur

      ‚úÖ **Copier champs optionnels pr√©sents :**
      - title_en, subtitle, subtitle_en
      - step_type, why, why_en, tips, tips_en
      - transfer, transfer_en, suggestion, suggestion_en
      - weather_icon, weather_temp, weather_description, weather_description_en
      - duration, price
      - images (array)

      ‚úÖ **Step r√©capitulative (is_summary: true) :**
      - summary_stats DOIT contenir 4-8 items
      - Si moins de 4 : AJOUTER des stats calcul√©es (days, budget, people, activities)
      - Si plus de 8 : TRONQUER √† 8

      ### **3. G√âN√âRATION DU CODE VOYAGE**

      Si destination_choice.code existe : **UTILISER TEL QUEL** (ne pas r√©g√©n√©rer)
      Sinon, g√©n√©rer en suivant les r√®gles :
      - Format : [DESTINATION]-[THEME]-[YEAR]
      - Exemples : "TOKYO-CULTURE-2025", "BALI-WELLNESS-2025", "PARIS-ROMANCE-2025"
      - R√®gles de normalisation :
        * MAJUSCULES uniquement
        * Remplacer espaces/caract√®res sp√©ciaux par "-"
        * Max 30 caract√®res total
        * Commencer par une LETTRE obligatoirement
        * THEME bas√© sur travel_style (CULTURE, ADVENTURE, WELLNESS, GASTRONOMY, ROMANCE, FAMILY, BUSINESS, NATURE, BEACH, CITY)

      ### **4. VALIDATION FINALE**

      Avant de retourner le JSON, v√©rifier :
      - ‚úÖ code est valide (pattern: ^[A-Z][A-Z0-9-]{2,29}$) - max 30 caract√®res
      - ‚úÖ destination est non vide
      - ‚úÖ total_days > 0
      - ‚úÖ steps contient au moins 1 step
      - ‚úÖ TOUTES les steps ont step_number, day_number, title, main_image
      - ‚úÖ TOUTES les main_image commencent par l'URL Supabase
      - ‚úÖ AU MOINS une step avec is_summary: true
      - ‚úÖ summary_stats de la step r√©cap contient 4-8 items

      Si une validation √©choue : RETOURNER un JSON d'erreur avec :
      ```yaml
      error: true
      error_message: "Description pr√©cise de l'erreur"
      failed_validations: ["liste des validations √©chou√©es"]
      ```

      ---

      ## **EXEMPLE COMPLET DE JSON FINAL ATTENDU**

      ```yaml
      trip:
        code: "TOKYO-2025"
        destination: "Tokyo, Japon üáØüáµ"
        destination_en: "Tokyo, Japan üáØüáµ"
        total_days: 7
        main_image: "https://xznsdvvfqoztlqtqhkhv.supabase.co/storage/v1/object/public/TRIPS/tokyo-2025-abc123/hero_1733155800.jpg"

        flight_from: "Bruxelles"
        flight_to: "Tokyo"
        flight_duration: "12h30"
        flight_type: "Vol direct"

        hotel_name: "Hotel Gracery Shinjuku"
        hotel_rating: 4.3

        total_price: "3 885‚Ç¨"
        total_budget: "3 885‚Ç¨"
        average_weather: "22¬∞C"

        travel_style: "Culture & Gastronomie"
        travel_style_en: "Culture & Food"

        start_date: "2025-12-15"
        travelers: 2

        price_flights: "2 600‚Ç¨"
        price_hotels: "840‚Ç¨"
        price_transport: "200‚Ç¨"
        price_activities: "245‚Ç¨"

        steps:
          - step_number: 1
            day_number: 1
            title: "Arriv√©e √† Tokyo"
            subtitle: "Installation et premi√®re d√©couverte de Shibuya"
            main_image: "https://xznsdvvfqoztlqtqhkhv.supabase.co/storage/v1/object/public/TRIPS/tokyo-2025-abc123/background_1733155900.jpg"
            step_type: "activit√©"
            latitude: 35.6595
            longitude: 139.7004
            duration: "2h"
            price: 0
            why: "Shibuya Crossing est l'un des passages pi√©tons les plus embl√©matiques au monde."
            tips: "Visitez en fin d'apr√®s-midi pour voir le crossing illumin√©."
            weather_icon: "üå§Ô∏è"
            weather_temp: "22¬∞C"

          - step_number: 2
            day_number: 1
            title: "D√Æner √† Shibuya"
            main_image: "https://xznsdvvfqoztlqtqhkhv.supabase.co/storage/v1/object/public/TRIPS/tokyo-2025-abc123/background_1733155920.jpg"
            step_type: "restaurant"
            latitude: 35.6612
            longitude: 139.6988
            duration: "1h30"
            price: 35
            why: "D√©couverte de la cuisine locale dans le quartier anim√©."
            tips: "Testez un izakaya pour une exp√©rience authentique."

          # [...] Toutes les autres steps

          - step_number: 15
            day_number: 7
            title: "R√©sum√© du voyage"
            subtitle: "7 jours ‚Äî Tokyo, Japon üáØüáµ"
            main_image: "https://xznsdvvfqoztlqtqhkhv.supabase.co/storage/v1/object/public/TRIPS/tokyo-2025-abc123/hero_1733155800.jpg"
            is_summary: true
            step_type: "r√©capitulatif"
            duration: "‚Äî"
            price: 0
            summary_stats:
              - type: days
                value: 7
              - type: budget
                value: "3 885‚Ç¨"
              - type: weather
                value: "22¬∞C"
              - type: style
                value: "Culture & Gastronomie"
              - type: cities
                value: 1
              - type: people
                value: 2
              - type: activities
                value: 14
              - type: custom
                value: "Direct"
                icon: "Plane"
                label: "VOL"
                color: "golden"
      ```

      ---

      **CHECKLIST FINALE :**
      - ‚úÖ Tous les champs obligatoires pr√©sents
      - ‚úÖ Code unique g√©n√©r√©/valid√©
      - ‚úÖ Toutes les steps valid√©es
      - ‚úÖ Toutes les main_image sont des URLs Supabase
      - ‚úÖ Toutes les steps ont GPS (sauf transport/r√©cap)
      - ‚úÖ Step r√©capitulative pr√©sente avec summary_stats
      - ‚úÖ JSON conforme au sch√©ma Trip

    expected_output: |-
      Un YAML STRICT contenant uniquement la cl√© `trip` avec tout le JSON final.

      **STRUCTURE :**
      ```yaml
      trip:
        code: "..."
        destination: "..."
        # [...] tous les champs
        steps:
          - step_number: 1
            # [...]
      ```

      ‚ö†Ô∏è **SI ERREURS DE VALIDATION :**
      ```yaml
      error: true
      error_message: "Description de l'erreur"
      failed_validations:
        - "Step 3 manque latitude/longitude"
        - "Step 5 a une main_image invalide (URL externe)"
      ```

      **NE JAMAIS PRODUIRE DE JSON.**

    async_execution: false
