tasks:
  traveller_profile_brief:
    description: |-
      Analyse attentivement le questionnaire client et l'inférence persona existante.

      QUESTIONNAIRE (YAML):
      {questionnaire}

      INFÉRENCE PERSONA (YAML):
      {persona_context}

      Ton objectif est de comprendre les motivations, priorités et contraintes du voyageur.


      Produis un raisonnement explicite: identifie les éléments positifs, les points de vigilance, les besoins critiques.
      Termine par un paragraphe narratif immersif.
    expected_output: |-
      Une analyse structurée au format YAML STRICT.

      Format attendu :
      ```yaml
      persona_analysis:
        macro_persona_identified: "Nom du persona MCP"
        narrative: "Texte immersif..."
        pros: ["point 1", "point 2"]
        cons: ["point 1", "point 2"]
        critical_needs: ["besoin 1"]
        implicit_goals: ["objectif 1"]
      ```
      **NE JAMAIS PRODUIRE DE JSON.**
    async_execution: false

  persona_challenge_review:
    description: |-
      Tu es le relecteur critique de l'analyse précédente.

      **Action MCP OBLIGATOIRE** : Tu DOIS vérifier la faisabilité (budget, destination, saison) en consultant les guides et études via MCP (`read_guide_tourisme...`, `read_le_secteur_touristique...`).

      1. Challenge l'argumentation.
      2. Vérifie la cohérence avec le questionnaire.
      3. Cite tes sources MCP.
    expected_output: |-
      Une revue critique au format YAML STRICT.

      Format attendu :
      ```yaml
      challenge_report:
        feasibility_check:
          budget_valid: true/false
          season_valid: true/false
          notes: "Explication basée sur le guide X..."
        biases_detected: ["biais 1"]
        recommendations: ["action 1"]
      ```
      **NE JAMAIS PRODUIRE DE JSON.**
    async_execution: false

  trip_specifications_design:
    description: |-
      Tu es responsable de la création du fichier de spécifications final.
      Fusionne les faits bruts du questionnaire (input_payload) avec l'analyse validée.

      INPUT PAYLOAD (YAML):
      {input_payload}

      Directives :
      1. Fidélité Totale : Si info absente -> null.
      2. Structure : Produis un YAML propre respectant strictement la structure cible.
    expected_output: |-
      Un fichier YAML STRICT contenant uniquement la clé `normalized_trip_request`.

      Format attendu :
      ```yaml
      normalized_trip_request:
        user:
          email: "..."
        travel_party:
          travelers_count: 0
          group_type: "..."
        trip_frame:
          origin: {city: null, country: null}
          destinations: [{city: null, country: null}]
          dates: {type: "flexible", departure_dates: [], return_dates: []}
        budget:
          estimated_total_group: 0
        # ... (autres champs standards)
      ```
      **NE JAMAIS PRODUIRE DE JSON.**
    async_execution: false

  system_contract_validation:
    description: |-
      Voici le System Contract généré automatiquement par le script Python :

      {system_contract_draft}

      Ton rôle CRITIQUE :
      1. **Vérifier la cohérence** : Les dates calculées sont-elles logiques ? Le budget est-il réaliste ?
      2. **Compléter les spécifications** : Enrichis les sections `flights`, `accommodation`, `experience` avec les préférences du voyageur.
      3. **Ajouter les tags manquants** : Utilise les analyses précédentes pour compléter les `interest_vectors`, `constraints`, etc.

      Tu as accès aux analyses précédentes (narratif, challenge, trip_spec) dans le contexte.

      **IMPORTANT** : Ne modifie PAS les calculs du script (dates, budgets). Complète uniquement les champs qualitatifs.
    expected_output: |-
      Le System Contract COMPLET et VALIDÉ au format YAML STRICT.

      Format attendu (COMPLET) :
      ```yaml
      meta:
        request_id: "..."
        user_id: "..."
        timestamp: "..."
        source_version: "production_v5"
      user_intelligence:
        email: "..."
        narrative_summary: "..."
        feasibility_status: "VALID|WARNING|CRITICAL"
        feasibility_alerts: []
      timing:
        request_type: "FIXED|FLEXIBLE_RANGE|FLEXIBLE_MONTH"
        duration_min_nights: 0
        duration_max_nights: 0
        departure_dates_whitelist: []
        return_dates_whitelist: []
      geography:
        origin_iata: "XXX"
        origin_city: "..."
        destination_is_defined: true
        destination_city: "..."
        destination_country: "..."
        discovery_climate_zones: []
        discovery_regions: []
        excluded_tags: []
      financials:
        currency: "EUR"
        total_hard_cap: 0
        total_soft_cap: 0
      specifications:
        flights:
          cabin_class: "ECONOMY|BUSINESS|FIRST"
          luggage_policy: "CARRY_ON|CHECKED"
          stopover_tolerance: "0|1|2+"
        accommodation:
          types_allowed: []
          min_rating_10: 0.0
          required_amenities: []
          location_vibe: "..."
        experience:
          pace: "RELAXED|BALANCED|INTENSE"
          interest_vectors: []
          constraints: []
      ```
      **NE JAMAIS PRODUIRE DE JSON.**
    async_execution: false
