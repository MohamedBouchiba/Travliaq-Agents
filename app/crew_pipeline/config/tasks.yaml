tasks:
  traveller_profile_brief:
    description: |-
      Analyse attentivement le questionnaire client et l'inférence persona existante.

      QUESTIONNAIRE (YAML):
      {questionnaire}

      INFÉRENCE PERSONA (YAML):
      {persona_context}

      Produis un raisonnement explicite: identifie les éléments positifs, les points de vigilance, les besoins critiques.
      Termine par un paragraphe narratif immersif.
    expected_output: |-
      Une analyse structurée au format YAML STRICT.

      ```yaml
      persona_analysis:
        macro_persona_identified: "Nom du persona MCP"
        narrative: "Texte immersif..."
        pros: ["point 1", "point 2"]
        cons: ["point 1", "point 2"]
        critical_needs: ["besoin 1"]
        implicit_goals: ["objectif 1"]
      ```
      **NE JAMAIS PRODUIRE DE JSON.**
    async_execution: false

  persona_challenge_review:
    description: |-
      Tu es le relecteur critique de l'analyse précédente.

      **Action MCP OBLIGATOIRE** : vérifie la faisabilité (budget, destination, saison) en consultant les guides et études via MCP.
      1. Challenge l'argumentation.
      2. Vérifie la cohérence avec le questionnaire.
      3. Cite tes sources MCP.
    expected_output: |-
      Une revue critique au format YAML STRICT.

      ```yaml
      challenge_report:
        feasibility_check:
          budget_valid: true/false
          season_valid: true/false
          notes: "Explication basée sur le guide X..."
        biases_detected: ["biais 1"]
        recommendations: ["action 1"]
      ```
      **NE JAMAIS PRODUIRE DE JSON.**
    async_execution: false

  trip_specifications_design:
    description: |-
      Tu es responsable de la création du fichier de spécifications final.
      Fusionne les faits bruts du questionnaire (input_payload) avec l'analyse validée.

      INPUT PAYLOAD (YAML):
      {input_payload}

      Directives :
      1. Fidélité Totale : Si info absente -> null.
      2. Structure : Produis un YAML propre respectant strictement la structure cible.
    expected_output: |-
      Un fichier YAML STRICT contenant uniquement la clé `normalized_trip_request`.

      ```yaml
      normalized_trip_request:
        email: "..."
        voyageurs: 0
        destination: "..."
        nuits_exactes: 0
        contraintes: []
      ```
      **NE JAMAIS PRODUIRE DE JSON.**
    async_execution: false

  system_contract_validation:
    description: |-
      Voici le System Contract généré automatiquement par le script Python :

      {system_contract_draft}

      Ton rôle CRITIQUE :
      1. Vérifier la cohérence : Les dates calculées sont-elles logiques ? Le budget est-il réaliste ?
      2. Compléter les spécifications : Enrichis les sections flights/accommodation/experience avec les préférences du voyageur.
      3. Ajouter les tags manquants : Utilise les analyses précédentes pour compléter interest_vectors, constraints, etc.
    expected_output: |-
      Le System Contract COMPLET et VALIDÉ au format YAML STRICT.

      ```yaml
      system_contract:
        meta: {...}
        user_intelligence: {...}
        timing: {...}
        geography: {...}
        financials: {...}
        specifications: {...}
      ```
      **NE JAMAIS PRODUIRE DE JSON.**
    async_execution: false

  destination_scouting:
    description: |-
      Propose 4-5 options de destination compatibles avec le budget, les dates et le style.
      Inclue un score de faisabilité (0-100), les risques météo/sécurité et les coûts approximatifs.

      **Action MCP** : Pour valider une ville, utilise `geo.text_to_place` avec le paramètre `query` (ex: "Paris"). Ne jamais passer de dictionnaire ou d'objet complexe.
    expected_output: |-
      ```yaml
      destination_slate:
        options:
          - city: "..."
            country: "..."
            score: 78
            risks: ["..."]
            indicative_budget: "..."
      ```
    async_execution: false

  flight_pricing:
    description: |-
      Estime les vols principaux pour les options retenues (prix, durée, bagages, escales).
      Priorité : ne pas halluciner. Si info absente -> null.

      **Action MCP** : Utilise `flights.prices` et `airports.nearest` avec des valeurs STRING simples (ex: origin="BRU", destination="DPS", city="Bali"). Ne jamais passer de dictionnaire.
    expected_output: |-
      ```yaml
      flight_quotes:
        from: "Bruxelles (BRU)"
        to: "Destination"
        duration: "6h30"
        type: "1 escale"
        price: "850€"
      ```
    async_execution: false

  lodging_pricing:
    description: |-
      Estime les hébergements (type, confort, quartier) avec un slot de prix et les équipements clés.
      Mentionne la faisabilité budgétaire et les compromis éventuels.

      **Action MCP** : Pour chercher des hôtels, utilise `booking.search` avec des valeurs simples (ex: city="Bali", pas de dictionnaire). Pour valider une ville, utilise `places.overview` avec query="Bali" (string simple, pas d'objet).
    expected_output: |-
      ```yaml
      lodging_quotes:
        hotel_name: "..."
        hotel_rating: 4.5
        price: "620€"
        neighborhood: "Central"
      ```
    async_execution: false

  activities_geo_design:
    description: |-
      Conçois les steps géolocalisés (1-3/jour) en tenant compte du rythme demandé.
      Chaque step doit contenir main_image, lat/lon si connu, why/tips et une estimation de durée/prix.
    expected_output: |-
      ```yaml
      activities_plan:
        steps:
          - step_number: 1
            day_number: 1
            title: "Arrivée"
            main_image: "https://..."
            duration: "2h"
            price: 0
      ```
    async_execution: false

  budget_consistency:
    description: |-
      Vérifie l'alignement budget total vs vols/hôtels/activités. Si dépassement >15%, propose des arbitrages explicites.
    expected_output: |-
      ```yaml
      budget_alignment_report:
        status: "OK|WARN|BLOCK"
        delta_percent: 12
        recommendations: ["..."]
      ```
    async_execution: false

  destination_decision:
    description: |-
      Choisis l'option finale en fixant total_budget/total_price, travel_style et les summary_stats (4-8 stats).
      Documente les hypothèses et les risques résiduels.
    expected_output: |-
      ```yaml
      final_destination_choice:
        code: "DEST2026"
        destination: "Doha, Qatar"
        total_days: 21
        total_budget: "900-1 200€"
        summary_stats: []
      ```
    async_execution: false

  feasibility_safety_gate:
    description: |-
      Applique un filtre final visa/météo/sécurité. Si risque critique, statut=CRITICAL.
    expected_output: |-
      ```yaml
      feasibility_gate:
        status: "OK|WARN|CRITICAL"
        alerts: ["visa obligatoire"]
      ```
    async_execution: false
