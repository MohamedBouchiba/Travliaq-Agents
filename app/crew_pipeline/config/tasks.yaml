tasks:
  # ==========================================================================
  # TASK 1: TRIP CONTEXT BUILDING
  # ==========================================================================
  trip_context_building:
    description: |-
      Tu re√ßois le questionnaire utilisateur et l'inf√©rence persona. Ta mission :
      extraire et structurer les informations critiques pour cr√©er un contexte
      clair que tous les autres agents utiliseront.

      **QUESTIONNAIRE (YAML):**
      {questionnaire}

      **INF√âRENCE PERSONA (YAML):**
      {persona_context}

      **INFORMATIONS √Ä EXTRAIRE :**

      1. **Destination** :
         - has_destination: yes/no (du questionnaire)
         - destination_provided: [nom exact si fourni] ou null
         - destination_type: city/region/country

      2. **Dates** :
         - dates_type: fixed/flexible/no_dates
         - departure_date: [YYYY-MM-DD] si fixed
         - return_date: [YYYY-MM-DD] si fixed
         - departure_window: {start, end} si flexible
         - return_window: {start, end} si flexible
         - duration_nights: [nombre] (obligatoire)

      3. **Voyageurs** :
         - travel_group: solo/duo/group35/family
         - travelers_count: [nombre]
         - children_count: [nombre] si family
         - travelers_details: [liste si fournie]

      4. **Budget** :
         - budget_amount: [nombre] (par personne ou total selon context)
         - budget_currency: EUR/USD/etc.
         - budget_type: per_person/total_group
         - budget_range: {min, max} si fourni

      5. **Services demand√©s** :
         - help_with: [liste] (flights, accommodation, activities)
         - Si vide ou null, consid√©rer comme ["flights", "accommodation", "activities"]

      6. **Pr√©f√©rences voyage** :
         - rhythm: relaxed/balanced/intense (si activities demand√©)
         - schedule_prefs: [liste] (Matinal, Flexible, Couche-tard)
         - styles: [liste] (Culture, Gastronomie, Nature, etc.)
         - mobility: [liste] (Voiture, Transports en commun, V√©lo, √Ä pied)

      7. **Contraintes** :
         - constraints: [liste] (Allergies, Handicap, Animal, etc.)
         - security_level: low/medium/high (inf√©r√© ou fourni)

      8. **Pr√©f√©rences vols** (si flights dans help_with) :
         - departure_location: [ville, pays]
         - flight_preference: direct/1_escale/flexible
         - luggage: cabin_only/checked_included

      9. **Pr√©f√©rences h√©bergement** (si accommodation dans help_with) :
         - accommodation_type: [liste] (H√¥tel, Appartement, Auberge)
         - comfort: economique/standard/confort/luxe
         - hotel_preferences: [liste] (Petit-d√©jeuner, Annulation gratuite, etc.)
         - neighborhood: centre/calme/transports
         - equipment: [liste] (WiFi, Piscine, Parking, etc.)

      **D√âTECTION D'INCOH√âRENCES :**
      - Si dates fixed mais pas de departure_date ‚Üí WARN
      - Si budget_amount = 0 ou null ‚Üí WARN
      - Si has_destination=yes mais pas de destination fournie ‚Üí WARN
      - Si duration_nights manquant ‚Üí calculer depuis dates ou mettre null

      **R√àGLES CRITIQUES :**
      - NE JAMAIS inventer d'informations absentes
      - Si info manquante ‚Üí null
      - Si incoh√©rence ‚Üí signaler dans warnings
      - Toujours inclure current_year: {current_year}

    expected_output: |-
      Un YAML structur√© STRICT avec TOUTES les informations extraites :

      ```yaml
      trip_context:
        destination:
          has_destination: yes  # ou no
          destination_provided: "[DESTINATION], [COUNTRY]"  # ou null - bas√© sur questionnaire
          destination_type: city  # ou region, country, null

        dates:
          dates_type: fixed  # ou flexible, no_dates
          departure_date: "2025-12-15"  # ou null
          return_date: "2025-12-22"  # ou null
          departure_window:  # si flexible
            start: "2025-12-10"
            end: "2025-12-20"
          return_window:  # si flexible
            start: "2025-12-17"
            end: "2025-12-27"
          duration_nights: 7

        travelers:
          travel_group: duo  # solo, duo, group35, family
          travelers_count: 2
          children_count: 0  # ou nombre si family
          travelers_details: []  # ou liste si fournie

        budget:
          budget_amount: 1500
          budget_currency: EUR
          budget_type: per_person  # ou total_group
          budget_range:
            min: 1200
            max: 1800

        services_requested:
          help_with: ["flights", "accommodation", "activities"]
          flights_needed: true
          accommodation_needed: true
          activities_needed: true

        preferences:
          rhythm: balanced  # relaxed, balanced, intense
          schedule_prefs: ["Flexible"]
          styles: ["Culture", "Gastronomie"]
          mobility: ["Transports en commun", "√Ä pied"]

        constraints:
          constraints_list: []  # ou liste
          security_level: medium  # low, medium, high

        flights_prefs:  # si flights_needed
          departure_location: "Bruxelles, Belgique"
          flight_preference: direct  # direct, 1_escale, flexible
          luggage: checked_included  # cabin_only, checked_included

        accommodation_prefs:  # si accommodation_needed
          accommodation_type: ["H√¥tel"]
          comfort: confort  # economique, standard, confort, luxe
          hotel_preferences: ["Petit-d√©jeuner inclus", "Annulation gratuite"]
          neighborhood: centre  # centre, calme, transports
          equipment: ["WiFi gratuit", "Piscine"]

        warnings: []  # Liste des incoh√©rences d√©tect√©es
        current_year: 2025
      ```

      **NE JAMAIS PRODUIRE DE JSON.**

    async_execution: false

  # ==========================================================================
  # TASK 2: DESTINATION STRATEGY
  # ==========================================================================
  destination_strategy:
    description: |-
      Tu re√ßois le trip_context de la t√¢che pr√©c√©dente. Ta mission d√©pend de has_destination.

      **IMPORTANT** : Le trip_context est disponible dans l'output de la t√¢che pr√©c√©dente.
      Utilise les informations de destination, dates, budget, styles, etc. pour effectuer ta strat√©gie.

      **ANN√âE ACTUELLE :** {current_year}

      ---

      ## **CAS A : has_destination = yes (Destination fournie)**

      L'utilisateur a fourni une destination. Tu dois :

      1. **Valider la destination** avec geo.text_to_place(query="[DESTINATION]")
         - Obtenir les coordonn√©es GPS (latitude, longitude)
         - V√©rifier que la destination existe

      2. **Enrichir avec places.overview(query="[DESTINATION]")**
         - Obtenir des infos suppl√©mentaires (pays, r√©gion, etc.)

      3. **M√©t√©o estim√©e** :
         - Utiliser les dates du voyage pour estimer la m√©t√©o moyenne
         - Format: "22¬∞C" ou "20-25¬∞C"

      4. **G√©n√©rer le CODE VOYAGE unique** :
         - Format: [DESTINATION]-[THEME/STYLE]-[ANNEE]
         - Exemples g√©n√©riques:
           * "CITY1-CULTURE-2025" (voyage culturel)
           * "CITY2-WELLNESS-2025" (voyage bien-√™tre)
           * "COUNTRY1-ADVENTURE-2025" (voyage aventure)
           * "CITY3-GASTRONOMY-2025" (voyage gastronomique)
           * "CITY4-FAMILY-2025" (voyage familial)
         - R√®gles:
           * MAJUSCULES uniquement
           * Remplacer espaces/caract√®res sp√©ciaux par -
           * Max 30 caract√®res au total
           * Le THEME doit refl√©ter le style principal du voyage bas√© sur les pr√©f√©rences utilisateur (ex: CULTURE, ADVENTURE, WELLNESS, GASTRONOMY, ROMANCE, FAMILY, BUSINESS, NATURE, BEACH, CITY)
           * Si plusieurs styles : choisir le plus dominant selon les affinit√©s_voyage du questionnaire

      5. **Style de voyage** :
         - Bas√© sur les styles du trip_context
         - Exemple: "Culture & Gastronomie", "Nature & Aventure"

      **OUTPUT ATTENDU pour CAS A :**
      ```yaml
      destination_choice:
        method: validated  # destination fournie par utilisateur
        code: "[DEST]-[THEME]-2025"  # Format: DESTINATION-THEME-YEAR bas√© sur questionnaire
        destination: "[Destination], [Pays] üåç"
        destination_en: "[Destination], [Country] üåç"
        latitude: 35.6762
        longitude: 139.6503
        country: "Japon"
        region: "Kant≈ç"
        average_weather: "22¬∞C"
        travel_style: "Culture & Gastronomie"
        travel_style_en: "Culture & Food"
        total_days: 7  # depuis trip_context
        validation_notes: "Destination valid√©e via geo.text_to_place"
      ```

      ---

      ## **CAS B : has_destination = no (Pas de destination)**

      L'utilisateur n'a pas de destination. Tu dois :

      1. **Proposer 3-5 destinations** compatibles avec :
         - Budget (budget_amount, budget_currency)
         - Dates (departure_date ou departure_window)
         - Dur√©e (duration_nights)
         - Styles (preferences.styles)
         - Voyageurs (travel_group, travelers_count)

      2. **Pour CHAQUE destination propos√©e** :
         - Utiliser geo.text_to_place(query="[destination]") pour GPS
         - Utiliser places.overview(query="[destination]") pour infos
         - Calculer un SCORE sur 100 :
           * Budget compatible (30 points)
           * Saison favorable (25 points)
           * S√©curit√© (20 points)
           * Match avec styles (15 points)
           * Accessibilit√© depuis departure_location (10 points)
         - Lister les RISQUES (m√©t√©o, s√©curit√©, visa, etc.)
         - Estimer le budget indicatif

      3. **Choisir LA MEILLEURE destination** :
         - Celle avec le score le plus √©lev√©
         - Justifier le choix avec 2-3 arguments clairs

      4. **G√©n√©rer le CODE VOYAGE** pour la destination choisie

      **OUTPUT ATTENDU pour CAS B :**
      ```yaml
      destination_choice:
        method: scouted  # destination choisie par l'agent

        options_considered:
          - city: "[Option 1]"  # Bas√© sur pr√©f√©rences utilisateur
            country: "[Pays 1]"
            latitude: XX.XXXX
            longitude: XX.XXXX
            score: 87
            budget_fit: excellent  # excellent, good, acceptable
            season_fit: parfaite  # parfaite, bonne, moyenne
            risks: ["[Risques identifi√©s]"]
            indicative_budget: "[Budget estim√©]"
            justification: "[Justification bas√©e sur pr√©f√©rences utilisateur]"

          - city: "[Option 2]"  # Bas√© sur pr√©f√©rences utilisateur
            country: "[Pays 2]"
            latitude: XX.XXXX
            longitude: XX.XXXX
            score: 82
            budget_fit: excellent
            season_fit: bonne
            risks: []
            indicative_budget: "1100-1400‚Ç¨"
            justification: "Ville culturelle et gastronomique, proche de Bruxelles"

          - city: "Marrakech"
            country: "Maroc"
            latitude: 31.6295
            longitude: -7.9811
            score: 78
            budget_fit: good
            season_fit: moyenne
            risks: ["Chaleur √©lev√©e en √©t√©"]
            indicative_budget: "1000-1300‚Ç¨"
            justification: "Destination exotique et culturelle, budget attractif"

        # DESTINATION CHOISIE (score le plus √©lev√©) - Bas√© sur pr√©f√©rences utilisateur
        code: "[DEST]-[THEME]-2025"  # Format: DESTINATION-THEME-YEAR
        destination: "[Destination choisie], [Pays] üåç"
        destination_en: "[Chosen destination], [Country] üåç"
        latitude: XX.XXXX
        longitude: XX.XXXX
        country: "[Pays]"
        region: "[R√©gion]"
        average_weather: "XX¬∞C"
        travel_style: "[Style bas√© sur affinit√©s_voyage]"
        travel_style_en: "[Style in English]"
        total_days: X
        decision_rationale: |-
          [Destination] a √©t√© choisie (score: XX/100) pour 3 raisons principales :
          1. Budget parfaitement compatible ([Budget estim√©] vs [Budget demand√©])
          2. Destination id√©ale pour [Styles utilisateur] (match avec pr√©f√©rences)
          3. Saison favorable avec m√©t√©o agr√©able ([Temp√©rature] en moyenne)
      ```

      ---

      **R√àGLES CRITIQUES :**
      - TOUJOURS utiliser geo.text_to_place pour obtenir GPS
      - TOUJOURS g√©n√©rer le CODE VOYAGE (format: DESTINATION-THEME-YEAR)
      - Si CAS B : proposer AU MOINS 3 destinations
      - Documenter toutes les sources MCP utilis√©es
      - NE JAMAIS inventer de coordonn√©es GPS

    expected_output: |-
      Un YAML STRICT avec la structure destination_choice (CAS A ou CAS B selon has_destination).

      **NE JAMAIS PRODUIRE DE JSON.**

    async_execution: false

  # ==========================================================================
  # TASK 3: FLIGHTS RESEARCH
  # ==========================================================================
  flights_research:
    description: |-
      üö® **R√àGLES ANTI-HALLUCINATION** üö®
      - ‚úÖ OBLIGATION : Utiliser UNIQUEMENT flights.prices pour les estimations de prix
      - ‚úÖ OBLIGATION : Utiliser airports.nearest pour trouver les a√©roports
      - ‚ùå INTERDICTION : Inventer des prix ou des horaires de vol
      - ‚ùå INTERDICTION : Utiliser des donn√©es obsol√®tes ou approximatives
      - ‚ö†Ô∏è Si aucun tool disponible : SIGNALER "Donn√©es indisponibles" avec raison
      - ‚ö†Ô∏è Si tool √©choue : INDIQUER l'erreur pr√©cise, NE PAS inventer de donn√©es

      ---

      Tu re√ßois le trip_context et la destination_choice. Ta mission : rechercher
      et estimer les vols UNIQUEMENT via les tools MCP.

      **CONTEXTE VOYAGE :**
      {trip_context}

      **DESTINATION CHOISIE :**
      {destination_choice}

      **DATES VALID√âES :**
      - D√©part : {validated_departure_dates}
      - Retour : {validated_return_dates}

      **ANN√âE ACTUELLE :** {current_year}

      ---

      **PROCESSUS OBLIGATOIRE :**

      1. **Identifier les a√©roports** :
         - Origine : airports.nearest(city="[lieu_depart]") depuis trip_context.flights_prefs.departure_location
         - Destination : airports.nearest(city="[destination]") depuis destination_choice.destination

      2. **Rechercher les vols** :
         - Utiliser flights.prices(origin="[ORG]", destination="[DEST]", departure="[date]")
         - R√àGLE CRITIQUE : dates >= {current_year}-12-02 (JAMAIS de dates 2023 ou 2024)
         - Respecter flight_preference (direct/1_escale/flexible)

      3. **S√©lectionner la meilleure option** :
         - Prioriser selon flight_preference
         - V√©rifier compatibilit√© avec budget

      4. **Estimer les bagages** :
         - Si luggage=cabin_only : 0‚Ç¨ suppl√©mentaire
         - Si luggage=checked_included : +30-50‚Ç¨ par personne

      **SI OUTILS MCP √âCHOUENT :**
      - Fournir une estimation prudente bas√©e sur :
        * Distance approximative
        * Prix moyens connus pour cette route
        * Mentionner explicitement que c'est une estimation

      **CALCUL DU PRIX TOTAL :**
      - Prix vol aller-retour √ó nombre de voyageurs
      - + Bagages si checked_included
      - Arrondir √† la dizaine sup√©rieure

    expected_output: |-
      Un YAML STRICT avec la structure flight_quotes :

      ```yaml
      flight_quotes:
        origin:
          city: "Bruxelles"
          airport_code: "BRU"
          airport_name: "Brussels Airport"

        destination:
          city: "Tokyo"
          airport_code: "NRT"
          airport_name: "Narita International Airport"

        outbound:
          departure_date: "2025-12-15"
          duration: "12h30"
          stops: 0  # 0 pour direct, 1 pour 1 escale
          airline: "Brussels Airlines"
          price_per_person: 650

        inbound:
          departure_date: "2025-12-22"
          duration: "13h00"
          stops: 0
          airline: "Brussels Airlines"
          price_per_person: 650

        total:
          price_per_person: 1300
          travelers_count: 2
          total_price: 2600
          currency: EUR
          luggage_included: true
          luggage_cost: 0  # ou montant si cabin_only et bagages ajout√©s

        summary:
          from: "Bruxelles (BRU)"
          to: "Tokyo (NRT)"
          duration: "12h30"
          type: "Vol direct"  # ou "1 escale" ou "2 escales"
          price: "2 600‚Ç¨"

        sources: ["flights.prices", "airports.nearest"]
        notes: "Prix indicatifs bas√©s sur recherche MCP"
      ```

      **NE JAMAIS PRODUIRE DE JSON.**

    async_execution: false

  # ==========================================================================
  # TASK 4: ACCOMMODATION RESEARCH
  # ==========================================================================
  accommodation_research:
    description: |-
      üö® **R√àGLES ANTI-HALLUCINATION** üö®
      - ‚úÖ OBLIGATION : Utiliser UNIQUEMENT booking.search pour rechercher h√©bergements
      - ‚úÖ OBLIGATION : Utiliser booking.details pour d√©tails si disponible
      - ‚ùå INTERDICTION ABSOLUE : Inventer noms d'h√¥tels, prix, ou notes
      - ‚ùå INTERDICTION ABSOLUE : Utiliser des donn√©es approximatives
      - ‚ö†Ô∏è Si booking.search √©choue : SIGNALER explicitement et fournir estimation PRUDENTE
      - ‚ö†Ô∏è TOUJOURS mentionner la source (booking.search result ou estimation)

      ---

      Tu re√ßois le trip_context et la destination_choice. Ta mission : rechercher
      et estimer les h√©bergements UNIQUEMENT via booking.search.

      **CONTEXTE VOYAGE :**
      {trip_context}

      **DESTINATION CHOISIE :**
      {destination_choice}

      **DATES VALID√âES :**
      - Check-in : {validated_departure_dates}
      - Check-out : {validated_return_dates}

      **ANN√âE ACTUELLE :** {current_year}

      ---

      **PROCESSUS OBLIGATOIRE :**

      1. **Valider la destination avec places.overview(query="Tokyo")** :
         - Obtenir les quartiers populaires
         - Identifier le centre-ville

      2. **Rechercher les h√©bergements avec booking.search** :
         - Param√®tres : city="Tokyo", checkin="2025-12-15", checkout="2025-12-22"
         - Filtrer par type : accommodation_type (H√¥tel, Appartement, etc.)
         - Filtrer par confort : comfort (√©conomique=1-2‚òÖ, standard=3‚òÖ, confort=4‚òÖ, luxe=5‚òÖ)
         - Filtrer par quartier : neighborhood (centre/calme/transports)
         - Filtrer par √©quipements : equipment (WiFi, Piscine, etc.)

      3. **S√©lectionner 1-3 options** :
         - Meilleur rapport qualit√©/prix
         - Compatible avec budget
         - Match avec pr√©f√©rences (hotel_preferences)

      4. **Pour chaque h√©bergement** :
         - Nom complet
         - Note moyenne (/5)
         - Prix par nuit
         - Quartier
         - √âquipements principaux
         - Lien si disponible

      **SI OUTILS MCP √âCHOUENT :**
      - Fournir une estimation prudente bas√©e sur :
        * Prix moyens connus pour cette destination
        * Confort demand√© (√©toiles)
        * Mentionner explicitement que c'est une estimation

      **CALCUL DU PRIX TOTAL :**
      - Prix par nuit √ó nombre de nuits √ó nombre de chambres
      - Arrondir √† la dizaine sup√©rieure

    expected_output: |-
      Un YAML STRICT avec la structure lodging_quotes :

      ```yaml
      lodging_quotes:
        destination:
          city: "Tokyo"
          country: "Japon"
          neighborhood_searched: "Shibuya"

        search_criteria:
          checkin: "2025-12-15"
          checkout: "2025-12-22"
          nights: 7
          travelers: 2
          rooms_needed: 1
          type: ["H√¥tel"]
          comfort: confort  # √©conomique, standard, confort, luxe
          stars: 4

        options:
          - hotel_name: "Hotel Gracery Shinjuku"
            hotel_rating: 4.3
            stars: 4
            neighborhood: "Shinjuku"
            price_per_night: 120
            total_price: 840
            currency: EUR
            amenities: ["WiFi gratuit", "Restaurant", "Climatisation"]
            url: "https://booking.com/hotel/..."
            notes: "H√¥tel central avec excellent rapport qualit√©/prix"

          - hotel_name: "Shibuya Excel Hotel Tokyu"
            hotel_rating: 4.5
            stars: 4
            neighborhood: "Shibuya"
            price_per_night: 140
            total_price: 980
            currency: EUR
            amenities: ["WiFi gratuit", "Petit-d√©jeuner inclus", "Vue panoramique"]
            url: "https://booking.com/hotel/..."
            notes: "Emplacement id√©al avec vue sur Shibuya"

        recommended:
          hotel_name: "Hotel Gracery Shinjuku"
          hotel_rating: 4.3
          total_price: 840
          price_display: "840‚Ç¨"
          neighborhood: "Shinjuku"
          justification: "Meilleur rapport qualit√©/prix, quartier central anim√©"

        summary:
          accommodation_type: "H√¥tel 4‚òÖ"
          nights: 7
          rooms: 1
          total_price: 840
          price_per_night_avg: 120
          currency: EUR
          price_display: "840‚Ç¨"

        sources: ["booking.search", "places.overview"]
        notes: "Prix indicatifs pour 2 voyageurs, 1 chambre double"
      ```

      **NE JAMAIS PRODUIRE DE JSON.**

    async_execution: false

  # ==========================================================================
  # TASK 5: TRIP STRUCTURE PLANNING (NOUVEAU - Planification du rythme)
  # ==========================================================================
  plan_trip_structure:
    description: |-
      üéØ **TU CR√âES LE PLAN STRUCTUREL DU S√âJOUR AVANT L'ITIN√âRAIRE D√âTAILL√â.**

      Ta mission : analyser le profil du voyageur, le rythme souhait√©, la destination, et
      la culture locale pour d√©cider de la STRUCTURE OPTIMALE du s√©jour que l'itinerary_designer
      suivra ensuite √† la lettre.

      **CONTEXTE VOYAGE :**
      {trip_context}

      **DESTINATION CHOISIE :**
      {destination_choice}

      **üìä ANALYSE DU RYTHME VOYAGEUR (PRIORIT√â ABSOLUE) :**

      Le champ "rythme" du questionnaire d√©finit IMP√âRATIVEMENT le nombre de steps par jour :

      1. **relaxed (d√©tendu)** :
         - **1-2 steps/jour MAX**
         - Privil√©gier 1 step longue et immersive de 3-4h (ex: journ√©e √† la plage, visite approfondie d'un quartier)
         - Si 2 steps : 1 activit√© principale + 1 repas/d√©tente l√©g√®re
         - Laisser 2-3h de temps libre par jour pour sieste, fl√¢ner, improviser
         - √âviter les journ√©es charg√©es
         - Exemple jour type : Matin au temple (3h) ‚Üí Pause caf√© ‚Üí D√©jeuner tranquille ‚Üí Temps libre ‚Üí D√Æner d√©contract√©

      2. **balanced (√©quilibr√©)** :
         - **1-2 steps/jour en moyenne**
         - Mix intelligent : certains jours 1 step longue (4h), d'autres jours 2 steps moyennes (2h chacune)
         - Alterner journ√©es intenses et journ√©es calmes
         - Inclure 1-2h de temps libre par jour
         - Exemple jour type : Visite mus√©e (2-3h) ‚Üí D√©jeuner ‚Üí Balade quartier historique (2h) ‚Üí Temps libre soir√©e

      3. **intense (dynamique)** :
         - **2-3 steps/jour**
         - Varier entre 2 et 3 steps selon la fatigue cumulative (pas 3 steps tous les jours!)
         - Journ√©e 1-2 : 3 steps courtes (1h30 chacune)
         - Journ√©e 3 : 2 steps (r√©cup√©ration)
         - Journ√©e 4 : 3 steps √† nouveau
         - Minimiser les temps morts, maximiser les d√©couvertes
         - Exemple jour type : March√© local (1h30) ‚Üí Mus√©e (2h) ‚Üí D√©jeuner rapide ‚Üí Quartier shopping (2h) ‚Üí Spectacle/restaurant

      **üìç ANALYSE CULTURE LOCALE & MIX D'ACTIVIT√âS :**

      ‚ö†Ô∏è **NEUTRALIT√â ABSOLUE - R√àGLE CRITIQUE** ‚ö†Ô∏è
      Tu dois analyser LA DESTINATION FOURNIE DANS {destination_choice} SANS AUCUN BIAIS.
      - NE PAS favoriser une destination sp√©cifique (Tokyo, Bali, Paris, New York, etc.)
      - NE PAS favoriser un type de voyage (culture vs nature vs plage vs montagne)
      - S'adapter √† N'IMPORTE QUELLE destination demand√©e par l'utilisateur
      - Baser le mix d'activit√©s UNIQUEMENT sur les affinit√©s du questionnaire
      - Chaque voyage est UNIQUE et personnalis√© selon le profil utilisateur

      Identifie les √âL√âMENTS CULTURELS AUTHENTIQUES de LA DESTINATION CHOISIE :
      - Recherche la culture, histoire, et traditions locales de LA DESTINATION FOURNIE
      - Identifie les monuments/sites incontournables sp√©cifiques √† cette destination
      - Identifie la gastronomie typique locale
      - Identifie les quartiers/zones caract√©ristiques
      - Identifie les activit√©s nature/outdoor propres √† la g√©ographie locale

      ‚úÖ **M√âTHODE** : Utilise tes connaissances g√©n√©rales sur la destination fournie dans {destination_choice}.
      Adapte-toi √† N'IMPORTE QUELLE destination : ville, r√©gion, pays, √Æle, montagne, d√©sert, etc.

      Calcule le MIX D'ACTIVIT√âS bas√© EXCLUSIVEMENT sur affinites_voyage du questionnaire :
      - Compte le nombre d'affinit√©s par cat√©gorie dans le questionnaire
      - R√©partis les pourcentages proportionnellement aux affinit√©s d√©clar√©es
      - NE PAS imposer de pourcentages fixes (30%, 40%, etc.)
      - Exemples de calcul :
        * Si affinites_voyage = ["culture", "culture_urbaine", "mus√©es"] ‚Üí ~60-70% culture
        * Si affinites_voyage = ["plage", "nature", "randonn√©e"] ‚Üí ~60-70% nature
        * Si affinites_voyage = ["gastronomie", "culture", "d√©tente"] ‚Üí mix √©quilibr√© 33%-33%-33%
        * Si affinites_voyage = ["ski", "montagne"] ‚Üí 100% activit√©s montagne/hiver

      **üó∫Ô∏è ZONES/QUARTIERS √Ä COUVRIR :**

      Identifie 3-5 zones cl√©s de LA DESTINATION CHOISIE (depuis {destination_choice}) :
      - Recherche les quartiers/zones principales de cette destination sp√©cifique
      - Minimiser les allers-retours inutiles
      - Regrouper les activit√©s par proximit√© g√©ographique
      - Assurer une d√©couverte compl√®te de la destination
      - S'adapter √† la taille et structure de la destination (ville compacte, r√©gion √©tendue, archipel, etc.)

      **üìã OUTPUT STRUCTUREL ATTENDU :**

      Tu dois produire un PLAN STRUCTUREL avec :
      1. **Nombre total de steps** : calcul√© selon DUR√âE + RYTHME (formule: dur√©e_jours √ó steps_range_moyen)
         - relaxed : dur√©e √ó 1.2 steps/jour en moyenne
         - balanced : dur√©e √ó 1.5 steps/jour en moyenne
         - intense : dur√©e √ó 2.5 steps/jour en moyenne
      2. **Distribution par jour** : liste exacte respectant le rythme (J1:X steps, J2:Y steps, etc.)
      3. **Mix de types** : % bas√©s sur les affinit√©s r√©elles du questionnaire (total = 100%)
      4. **Zones par jour** : quelle zone/quartier couvrir chaque jour
      5. **Types d'activit√©s prioris√©s** : top 5-8 types d'activit√©s √† inclure selon culture locale + affinit√©s

      **‚ö†Ô∏è R√àGLES CRITIQUES :**
      - Le RYTHME du questionnaire est IMP√âRATIF (respecter strict 1-2 ou 2-3 steps/jour)
      - JAMAIS d√©passer 3 steps/jour m√™me pour intense
      - JAMAIS moins d'1 step/jour
      - Tenir compte de la fatigue cumulative (alterner jours charg√©s et jours calmes)
      - Prioriser QUALIT√â > QUANTIT√â (mieux vaut 1 visite exceptionnelle que 3 visites b√¢cl√©es)

    expected_output: |-
      Un YAML STRICT avec le plan structurel :

      ```yaml
      trip_structure_plan:
        rhythm_analysis:
          questionnaire_rhythm: balanced  # depuis questionnaire (relaxed/balanced/intense)
          steps_per_day_range: "1-2"  # d√©duit du rythme ("1-2" ou "2-3")
          total_days: 7  # depuis questionnaire (duree ou nuits_exactes)
          total_steps_planned: 10  # calcul√©: 7 jours √ó 1.5 steps/jour (balanced)

        daily_distribution:
          - day: 1
            steps_count: 2
            zone: "[Zone A de la destination]"  # Ex: centre historique, quartier touristique, zone plage
            intensity: medium
          - day: 2
            steps_count: 2
            zone: "[Zone A de la destination]"
            intensity: medium
          - day: 3
            steps_count: 1
            zone: "[Zone B de la destination]"  # Ex: p√©riph√©rie, nature, quartier alternatif
            intensity: low  # journ√©e r√©cup√©ration
          - day: 4
            steps_count: 2
            zone: "[Zone C de la destination]"
            intensity: medium
          # ... pour CHAQUE jour du s√©jour

        activity_mix:
          [categorie_1]: XX  # % calcul√© depuis affinites_voyage
          [categorie_2]: XX  # % calcul√© depuis affinites_voyage
          [categorie_3]: XX  # % calcul√© depuis affinites_voyage
          # Cat√©gories possibles: culture, nature, gastronomy, relaxation, adventure, nightlife, shopping, sports
          # Total DOIT √™tre 100%

        priority_activity_types:
          - [type_activit√©_1_authentique_destination]  # Bas√© sur culture locale
          - [type_activit√©_2_authentique_destination]
          - [type_activit√©_3_depuis_affinit√©s]
          - [type_activit√©_4_depuis_affinit√©s]
          # Ex pour ville: museums, historic_sites, local_markets, gastronomy
          # Ex pour nature: hiking, beaches, viewpoints, wildlife
          # Ex pour montagne: skiing, snowboarding, mountain_huts, cable_cars

        zones_coverage:
          - zone: "[Nom Zone A]"  # Nom r√©el depuis destination
            days: [1, 2]
            activities_count: 4
          - zone: "[Nom Zone B]"
            days: [3]
            activities_count: 1
          - zone: "[Nom Zone C]"
            days: [4, 5]
            activities_count: 4
          # ... pour 3-5 zones principales de la destination

        cultural_priorities:
          top_1: "[√âl√©ment culturel #1 authentique de la destination]"
          top_2: "[√âl√©ment culturel #2 - gastronomie locale]"
          top_3: "[√âl√©ment culturel #3 - architecture/patrimoine]"
          top_4: "[√âl√©ment culturel #4 - nature/g√©ographie typique]"
          top_5: "[√âl√©ment culturel #5 - traditions/artisanat]"
          # Exemples g√©n√©riques √† adapter :
          # Ville historique: monuments, mus√©es, gastronomie, quartiers anciens, artisanat
          # Nature: paysages, faune, randonn√©es, panoramas, √©cosyst√®me local
          # Plage: oc√©an, sports nautiques, fruits de mer, villages c√¥tiers, couchers de soleil

        constraints:
          max_steps_per_day: 2  # d√©duit du rythme (1-2 pour relaxed/balanced, 2-3 pour intense)
          min_free_time_per_day: "1-2h"  # adapt√© au rythme
          avoid_back_and_forth: true
          group_by_proximity: true
      ```

      **NE JAMAIS PRODUIRE DE JSON. YAML STRICT UNIQUEMENT.**

    async_execution: false

  # ==========================================================================
  # TASK 6: ITINERARY CONTENT ENRICHMENT (SIMPLIFI√â - Focus contenu FR)
  # ==========================================================================
  itinerary_design:
    description: |-
      üéØ **MISSION: Enrichir les templates de steps avec du contenu d√©taill√© en FRAN√áAIS.**

      üì¶ **TU RE√áOIS DES TEMPLATES PR√â-REMPLIES** (fournies plus bas dans {step_templates}):

      Les steps suivantes ont D√âJ√Ä des GPS et images Supabase g√©n√©r√©s par script:
      - latitude, longitude (GPS r√©els via geo.place)
      - main_image (URL Supabase via images.background)
      - step_number, day_number, step_type

      ‚ö†Ô∏è **COPIE CES CHAMPS DEPUIS LES TEMPLATES (ne les modifie pas):**
      - latitude, longitude ‚Üí COPIE tels quels
      - main_image ‚Üí COPIE telle quelle
      - step_number, day_number ‚Üí COPIE tels quels
      - step_type ‚Üí COPIE tel quel

      ‚úÖ **TON TRAVAIL: COPIER les templates et AJOUTER le contenu FR:**

      Pour CHAQUE step template, tu dois remplir:

      1. **title** (FR): Titre court et accrocheur (4-8 mots)
      2. **subtitle** (FR): Sous-titre descriptif (6-10 mots)
      3. **why** (FR): 3-4 phrases riches d√©crivant:
         - L'int√©r√™t historique/culturel
         - Ce qu'on y trouve/voit
         - Pourquoi c'est incontournable
      4. **tips** (FR): 3-5 phrases avec:
         - Horaires d'ouverture (si applicable)
         - Prix d'entr√©e estim√©
         - Astuces pratiques (√©viter foule, meilleur moment)
         - Conseils vestimentaires si applicable
      5. **transfer** (FR): Comment s'y rendre depuis le lieu pr√©c√©dent
         - Moyen de transport (m√©tro, bus, marche)
         - Dur√©e approximative
         - Prix si pertinent
      6. **suggestion** (FR): Id√©es compl√©mentaires pour prolonger l'exp√©rience
      7. **weather_description** (FR): Description m√©t√©o selon la saison
      8. **price**: Prix d'entr√©e en euros (0 si gratuit)
      9. **duration**: Dur√©e de visite (ex: "2h", "3h30", "1h")

      ‚ùå **INTERDICTIONS:**
      - NE PAS modifier GPS des templates (d√©j√† corrects)
      - NE PAS modifier images des templates (d√©j√† Supabase)
      - NE PAS traduire en EN (g√©r√© par script apr√®s - donc title_en peut √™tre vide ou copie de title)
      - NE PAS appeler geo.place ou images.* si templates fournis (d√©j√† fait par script)
      - NE PAS inventer de nouvelles steps (copier le nombre exact depuis templates)

      üéØ **FOCUS:** Qualit√© contenu FR uniquement! Maximum de d√©tails et pertinence.

      ---

      **NEUTRALIT√â ABSOLUE - R√àGLE CRITIQUE:**
      - S'adapter √† N'IMPORTE QUELLE destination (ville, r√©gion, pays, √Æle, montagne, d√©sert, plage)
      - Suivre strictement le PLAN STRUCTUREL fourni dans le CONTEXT
      - Baser les activit√©s sur les affinit√©s et le rythme du questionnaire UNIQUEMENT
      - Ne PAS favoriser un type de destination ou d'activit√©s
      - Chaque itin√©raire est UNIQUE et personnalis√©

      ---

      Tu re√ßois tout le contexte et tu dois enrichir l'itin√©raire jour par jour.

      **CONTEXTE VOYAGE :**
      {trip_context}

      **DESTINATION CHOISIE :**
      {destination_choice}

      **ANN√âE ACTUELLE :** {current_year}

      **üìã PLAN STRUCTUREL DU S√âJOUR (CONTEXT DE LA T√ÇCHE PR√âC√âDENTE) :**

      Tu as acc√®s au PLAN STRUCTUREL g√©n√©r√© par l'agent trip_structure_planner dans ton CONTEXT.
      Ce plan contient :
      - rhythm_analysis : rythme d√©tect√© (relaxed/balanced/intense) et nombre total de steps planifi√©es
      - daily_distribution : nombre exact de steps par jour (ex: J1:2, J2:1, J3:2, etc.)
      - activity_mix : pourcentages de culture/gastronomie/nature/d√©tente
      - priority_activity_types : liste des types d'activit√©s √† privil√©gier
      - zones_coverage : zones/quartiers √† couvrir par jour
      - cultural_priorities : top 5 √©l√©ments culturels de la destination

      üéØ **TU DOIS SUIVRE CE PLAN STRUCTUREL √Ä LA LETTRE** :
      - Respecter EXACTEMENT le nombre de steps par jour indiqu√© dans daily_distribution
      - Respecter les zones/quartiers assign√©s √† chaque jour
      - Respecter le mix d'activit√©s (% culture, % gastronomie, % nature, etc.)
      - Choisir les types d'activit√©s depuis priority_activity_types
      - Ne JAMAIS d√©passer max_steps_per_day du plan
      - Si le plan dit "Jour 1: 2 steps, zone Shibuya" ‚Üí cr√©er EXACTEMENT 2 steps dans Shibuya
      - Si le plan dit "Jour 3: 1 step, zone Asakusa" ‚Üí cr√©er EXACTEMENT 1 step dans Asakusa

      ‚ö†Ô∏è **COH√âRENCE ABSOLUE** : Le nombre total de steps g√©n√©r√©es DOIT correspondre au total_steps_planned du plan structurel

      ---

      **üì¶ TEMPLATES PR√â-G√âN√âR√âS (√Ä UTILISER COMME BASE) :**

      {step_templates}

      ‚ö†Ô∏è **IMPORTANT : UTILISE CES TEMPLATES COMME BASE !**
      - Les templates ci-dessus contiennent D√âJ√Ä : step_number, day_number, latitude, longitude, main_image, step_type
      - COPIE ces champs EXACTEMENT tels quels dans ton output (ne les modifie PAS)
      - AJOUTE le contenu manquant : title, title_en, subtitle, subtitle_en, why, why_en, tips, tips_en, etc.
      - Si aucun template n'est fourni ci-dessus, g√©n√®re les steps depuis le plan structurel

      ‚ö†Ô∏è **NOMBRE DE STEPS √Ä CR√âER :**
      - UNIQUEMENT les steps des templates ci-dessus (si fournis)
      - PLUS la step 99 (summary) qui existe d√©j√† - √† remplir uniquement
      - ‚ùå NE JAMAIS cr√©er de steps suppl√©mentaires au-del√† des templates
      - ‚ùå NE JAMAIS cr√©er une nouvelle step r√©capitulative (step 99 existe d√©j√†)

      ‚ö†Ô∏è **IMAGE HERO DU TRIP (TOUJOURS OBLIGATOIRE) :**
      - Les templates NE contiennent PAS l'image hero du trip global
      - Tu DOIS TOUJOURS appeler images.hero pour g√©n√©rer hero_image
      - M√™me si les templates contiennent les main_image des steps, hero_image est s√©par√©e

      ---

      ## **R√àGLES ABSOLUES - √Ä RESPECTER IMP√âRATIVEMENT**

      ### **1. NOMBRE DE STEPS PAR JOUR (FLEXIBLE)**
      - ‚ö†Ô∏è **PAS DE NOMBRE FIXE** : Adapter le nombre de steps selon le contexte
      - **MINIMUM ABSOLU : 1 step par jour**
      - **MAXIMUM ABSOLU : 3 steps par jour**
      - **RECOMMANDATION** : Adapter selon rhythm ET type de journ√©e :
        * relaxed : 1-2 steps/jour (privil√©gier 1 step longue et immersive)
        * balanced : 1-2 steps/jour (2 steps si activit√©s courtes, 1 si activit√© longue)
        * intense : 2-3 steps/jour (varier entre 2 et 3 selon fatigue)
      - üéØ **PRIORIT√â : PERTINENCE > QUANTIT√â**
        * Mieux vaut 1 visite exceptionnelle de 4h qu'ajouter 2 steps moyennes
        * Respecter les temps de transport, pauses, repas
        * √âviter de surcharger les journ√©es juste pour atteindre un quota

      ### **2. COORDONN√âES GPS OBLIGATOIRES**
      Pour CHAQUE step (sauf steps de type "transport" ou "r√©capitulatif") :
      - Appeler geo.text_to_place(query="Tokyo Tower") OU places.overview(query="Tokyo Tower")
      - Extraire latitude et longitude
      - NE JAMAIS inventer de coordonn√©es GPS
      - Si tool √©choue : signaler l'erreur et essayer un autre nom

      ### **3. IMAGES SUPABASE OBLIGATOIRES**

      **‚ö†Ô∏è CRITIQUE : TU DOIS APPELER LES OUTILS images.hero ET images.background POUR OBTENIR DES URLS R√âELLES**
      **‚ùå NE JAMAIS copier les URLs d'exemple ci-dessous - ce sont des PLACEHOLDERS uniquement pour montrer le format**

      **√âTAPE A : Image Hero (OBLIGATOIRE - TOUJOURS APPELER)**

      ‚ö†Ô∏è **IMPORTANT : L'image HERO doit TOUJOURS √™tre g√©n√©r√©e, m√™me si des templates sont fournis !**

      Les templates contiennent les images des STEPS (activit√©s), mais PAS l'image HERO du trip.
      L'image hero est l'image de pr√©sentation du voyage complet.

      **Tu DOIS appeler images.hero dans TOUS les cas :**
      ```
      images.hero(
        city="[LA VILLE DU VOYAGE]",
        country="[LE PAYS DU VOYAGE]",
        trip_name="[NOM DU VOYAGE]",
        trip_folder="[CODE DU TRIP]"
      )
      ```

      ‚Üí L'outil te retourne une URL UNIQUE pour CE voyage (exemple de format seulement) :
      `{"url": "https://cinbnmlfpffmyjmkwbco.supabase.co/storage/v1/object/public/TRIPS/[TRIP_CODE]/hero_[TIMESTAMP].jpg", "type": "hero"}`

      ‚Üí **UTILISE L'URL RETOURN√âE PAR L'OUTIL** (pas celle de l'exemple) dans le champ `hero_image`

      **√âTAPE B : Images Background (SEULEMENT SI PAS DE TEMPLATES)**

      ‚ö†Ô∏è **Si des templates sont fournis dans {step_templates} ci-dessus** :
      - SKIP cette √©tape - les images sont d√©j√† g√©n√©r√©es
      - COPIE les main_image depuis les templates

      ‚ö†Ô∏è **Si AUCUN template fourni**, appelle images.background pour CHAQUE step :
      ```
      images.background(
        activity="[DESCRIPTION DE L'ACTIVIT√â DE CETTE STEP]",
        city="[VILLE]",
        country="[PAYS]",
        trip_name="[NOM DU VOYAGE]",
        trip_folder="[CODE DU TRIP]"
      )
      ```

      ‚Üí L'outil te retourne une URL UNIQUE pour cette step (exemple de format) :
      `{"url": "https://cinbnmlfpffmyjmkwbco.supabase.co/storage/v1/object/public/TRIPS/[TRIP_CODE]/background_[TIMESTAMP].jpg", "type": "background"}`

      ‚Üí **UTILISE L'URL RETOURN√âE PAR L'OUTIL** (pas celle de l'exemple) dans `main_image` de la step

      **R√âP√àTE POUR CHAQUE STEP** : appel images.background ‚Üí r√©cup√®re URL ‚Üí utilise dans main_image

      **R√àGLES CRITIQUES POUR LES IMAGES :**
      - ‚ùå JAMAIS d'URLs Wikipedia
      - ‚ùå JAMAIS d'URLs Unsplash
      - ‚ùå JAMAIS d'URLs Pexels ou autre source externe
      - ‚úÖ TOUJOURS utiliser les URLs retourn√©es par images.hero et images.background
      - ‚úÖ URLs commencent par "https://cinbnmlfpffmyjmkwbco.supabase.co/storage/v1/object/public/TRIPS/"

      **GESTION DES ERREURS IMAGES (WORKFLOW STRICT) :**
      - ‚ö†Ô∏è Si images.hero √©choue :
        * RETRY une fois avec des param√®tres l√©g√®rement diff√©rents
        * RETRY une deuxi√®me fois avec param√®tres encore plus simples
        * Si √©chec persistant apr√®s 3 tentatives : LAISSER LE CHAMP VIDE (ne pas mettre de placeholder)
        * ‚úÖ L'assembleur Python utilisera un fallback Unsplash SEULEMENT en dernier recours
      - ‚ö†Ô∏è Si images.background √©choue pour UNE step :
        * RETRY une fois avec description simplifi√©e (ex: "Tokyo Tower" au lieu de "visiting Tokyo Tower at sunset")
        * RETRY une deuxi√®me fois avec juste le nom du lieu (ex: "Tokyo")
        * Si √©chec persistant : LAISSER LE CHAMP main_image VIDE ou null
        * ‚ùå NE JAMAIS mettre de placeholders "FAILED" ou URLs externes
      - üéØ **PRINCIPE : TOUJOURS UTILISER LES OUTILS MCP**
        * Les URLs Supabase sont le workflow correct et OBLIGATOIRE
        * R√©essayer autant que n√©cessaire avant d'abandonner
        * Ne laisser vide qu'en dernier recours apr√®s multiples tentatives
        * En cas d'√©chec massif d'images : compl√©ter l'itin√©raire avec donn√©es GPS/texte valides

      ### **4. STRUCTURE DE CHAQUE STEP - CHAMPS D√âTAILL√âS**

      üéØ **OBLIGATION : MAXIMUM DE D√âTAILS DANS CHAQUE STEP**

      **Champs OBLIGATOIRES (100% des steps)** :
      - step_number : num√©ro d'ordre (1, 2, 3, ...)
      - day_number : jour du voyage (1, 2, 3, ...)
      - title : titre court et accrocheur (FR)
      - title_en : titre en anglais (EN)
      - main_image : URL Supabase (depuis images.background)

      **Champs OBLIGATOIRES (100% des steps hors transport/r√©cap)** :
      - subtitle : sous-titre descriptif (FR) - OBLIGATOIRE
      - subtitle_en : sous-titre en anglais (EN) - OBLIGATOIRE
      - latitude : GPS (depuis geo.text_to_place ou places.overview) - OBLIGATOIRE
      - longitude : GPS (depuis geo.text_to_place ou places.overview) - OBLIGATOIRE
      - why : pourquoi visiter - 3-4 PHRASES d√©taill√©es et informatives (FR) - OBLIGATOIRE
      - why_en : version anglaise du why - 3-4 PHRASES (EN) - OBLIGATOIRE
      - tips : conseils pratiques ULTRA-D√âTAILL√âS - 3-5 PHRASES avec horaires, prix, astuces (FR) - OBLIGATOIRE
      - tips_en : version anglaise des tips - 3-5 PHRASES (EN) - OBLIGATOIRE
      - duration : dur√©e estim√©e PR√âCISE (ex: "2h30", "3h", "Demi-journ√©e") - OBLIGATOIRE
      - price : prix estim√© R√âALISTE en euros (nombre, ex: 15, 25, 0 pour gratuit) - OBLIGATOIRE
      - step_type : activit√©/visite/restaurant/transport/h√©bergement/loisir - OBLIGATOIRE
      - weather_icon : emoji m√©t√©o (üå§Ô∏è, ‚òÄÔ∏è, ‚õÖ, üåßÔ∏è) - OBLIGATOIRE
      - weather_temp : temp√©rature estim√©e (ex: "22¬∞C") - OBLIGATOIRE
      - weather_description : description m√©t√©o en fran√ßais (ex: "Ensoleill√©", "Partiellement nuageux") - OBLIGATOIRE
      - weather_description_en : description m√©t√©o en anglais (ex: "Sunny", "Partly cloudy") - OBLIGATOIRE

      **Champs RECOMMAND√âS (50% des steps)** :
      - transfer : comment se rendre depuis step pr√©c√©dente (FR)
      - transfer_en : version anglaise du transfer (EN)
      - suggestion : suggestions compl√©mentaires (FR)
      - suggestion_en : version anglaise des suggestions (EN)
      - weather_description : description m√©t√©o (FR, ex: "Ensoleill√©")
      - weather_description_en : description m√©t√©o (EN, ex: "Sunny")
      - images : array d'URLs d'images suppl√©mentaires (galerie)

      üö® **R√àGLE CRITIQUE : BILINGUE FR + EN**
      Pour CHAQUE step :
      - Si tu √©cris "title", tu DOIS √©crire "title_en"
      - Si tu √©cris "why", tu DOIS √©crire "why_en"
      - Si tu √©cris "tips", tu DOIS √©crire "tips_en"
      - etc.

      üéØ **PRIORIT√â : QUALIT√â > QUANTIT√â**
      - Mieux vaut 8 steps ultra-d√©taill√©es que 15 steps basiques
      - Chaque step doit √™tre une exp√©rience compl√®te et document√©e
      - Utiliser TOUS les outils MCP disponibles pour enrichir les donn√©es

      ### **5. STEP R√âCAPITULATIVE FINALE**

      ‚ö†Ô∏è **IMPORTANT : NE PAS cr√©er de NOUVELLE step r√©capitulative !**

      Une step summary (step_number: 99, is_summary: true) EXISTE D√âJ√Ä dans le trip JSON.
      Tu dois UNIQUEMENT REMPLIR les champs de cette step 99 existante :

      - step_number : 99 (D√âJ√Ä EXISTANT - NE PAS MODIFIER)
      - day_number : 0 (D√âJ√Ä EXISTANT - NE PAS MODIFIER)
      - is_summary : true (D√âJ√Ä EXISTANT - NE PAS MODIFIER)
      - title : "R√©sum√© du voyage"
      - subtitle : "[X] jours ‚Äî [Destination]"
      - main_image : r√©utiliser hero_image
      - summary_stats : 4-8 statistiques (voir ci-dessous)

      **SUMMARY_STATS (4 √† 8 items obligatoires) :**
      Types disponibles :
      - days : nombre de jours
      - budget : budget total
      - weather : m√©t√©o moyenne
      - style : style de voyage
      - cities : nombre de villes
      - people : nombre de voyageurs
      - activities : nombre d'activit√©s
      - custom : statistique personnalis√©e (avec icon, label, color)

      Exemple :
      ```yaml
      summary_stats:
        - type: days
          value: 7
        - type: budget
          value: "3 500‚Ç¨"
        - type: weather
          value: "22¬∞C"
        - type: style
          value: "Culture & Gastronomie"
        - type: cities
          value: 2
        - type: people
          value: 2
        - type: activities
          value: 12
        - type: custom
          value: "Direct"
          icon: "Plane"
          label: "VOL"
          color: "golden"
      ```

      ### **6. ADAPTATION AU RYTHME**

      **relaxed (tranquille)** :
      - 1-2 activit√©s/jour maximum
      - Dur√©e: 2-3h par activit√©
      - Inclure temps libre/repos
      - √âviter les journ√©es charg√©es

      **balanced (√©quilibr√©)** :
      - 2 activit√©s/jour
      - Dur√©e: 2-4h par activit√©
      - Mix activit√©s + temps libre
      - Rythme confortable

      **intense (intense)** :
      - 2-3 activit√©s/jour
      - Dur√©e: 3-5h par activit√©
      - Journ√©es bien remplies
      - Optimisation des trajets

      ### **7. STYLES √Ä RESPECTER**

      Adapter les activit√©s selon styles du trip_context :
      - Culture : mus√©es, temples, sites historiques
      - Gastronomie : restaurants, march√©s, cours de cuisine
      - Nature : parcs, randonn√©es, plages
      - Aventure : sports, activit√©s outdoor
      - D√©tente : spa, plages, wellness
      - Nightlife : bars, clubs, spectacles

      ---

      ## **EXEMPLE COMPLET D'OUTPUT ATTENDU**

      **‚ö†Ô∏è IMPORTANT : Les URLs ci-dessous sont des PLACEHOLDERS**
      **TU DOIS appeler images.hero et images.background pour obtenir les VRAIES URLs pour CE voyage**

      ```yaml
      itinerary_plan:
        hero_image: "[URL_RETOURN√âE_PAR_images.hero_POUR_CE_VOYAGE]"

        steps:
          # JOUR 1 - EXEMPLE ULTRA-COMPLET AVEC TOUS LES CHAMPS
          - step_number: 1
            day_number: 1
            title: "Arriv√©e √† Tokyo et Shibuya Crossing"
            title_en: "Arrival in Tokyo and Shibuya Crossing"
            subtitle: "Installation et premi√®re d√©couverte du quartier embl√©matique"
            subtitle_en: "Check-in and first discovery of the iconic district"
            main_image: "[URL_RETOURN√âE_PAR_images.background_POUR_CETTE_STEP]"
            step_type: "activit√©"
            latitude: 35.6595
            longitude: 139.7004
            duration: "2h30"
            price: 0
            why: "Shibuya Crossing est l'un des passages pi√©tons les plus embl√©matiques au monde, avec jusqu'√† 3000 personnes traversant simultan√©ment. C'est l'immersion parfaite dans l'√©nergie et le rythme tr√©pidant de Tokyo d√®s votre arriv√©e."
            why_en: "Shibuya Crossing is one of the world's most iconic pedestrian crossings, with up to 3,000 people crossing simultaneously. It's the perfect immersion into Tokyo's energy and fast-paced rhythm from your arrival."
            tips: "Visitez en fin d'apr√®s-midi (17h-19h) pour voir le crossing illumin√© au coucher du soleil. Montez au Shibuya Sky (√©tage 46) pour une vue panoramique √† 360¬∞ sur Tokyo (2000¬•). Le Starbucks au 2√®me √©tage du Tsutaya Building offre une vue gratuite sur le crossing."
            tips_en: "Visit in late afternoon (5-7pm) to see the crossing illuminated at sunset. Go up to Shibuya Sky (46th floor) for a 360¬∞ panoramic view of Tokyo (2000¬•). The Starbucks on the 2nd floor of Tsutaya Building offers a free view of the crossing."
            transfer: "30 min en Narita Express depuis l'a√©roport (3220¬•), puis 5 min √† pied jusqu'√† l'h√¥tel"
            transfer_en: "30 min by Narita Express from airport (3220¬•), then 5 min walk to hotel"
            suggestion: "D√Ænez dans un izakaya local pour d√©couvrir la cuisine de rue japonaise. Le quartier regorge d'options pour tous les budgets."
            suggestion_en: "Have dinner at a local izakaya to discover Japanese street food. The area is full of options for all budgets."
            weather_icon: "üå§Ô∏è"
            weather_temp: "22¬∞C"
            weather_description: "Partiellement nuageux"
            weather_description_en: "Partly cloudy"
            images: [
              "[URL_RETOURN√âE_PAR_OUTIL_MCP]",
              "[URL_RETOURN√âE_PAR_OUTIL_MCP]"
            ]

          - step_number: 2
            day_number: 1
            title: "D√Æner √† Shibuya - Izakaya traditionnel"
            title_en: "Dinner in Shibuya - Traditional Izakaya"
            subtitle: "D√©couverte de la cuisine japonaise authentique"
            subtitle_en: "Discovery of authentic Japanese cuisine"
            main_image: "[URL_RETOURN√âE_PAR_OUTIL_MCP]"
            step_type: "restaurant"
            latitude: 35.6612
            longitude: 139.6988
            duration: "2h"
            price: 35
            why: "Profitez de votre premi√®re soir√©e pour d√©couvrir la cuisine locale dans un izakaya traditionnel. Ces tavernes japonaises offrent une ambiance conviviale o√π les habitants se retrouvent apr√®s le travail. Vous pourrez go√ªter aux yakitori (brochettes grill√©es), sashimi frais, et sak√© local dans une atmosph√®re authentique typiquement tokyo√Øte."
            why_en: "Enjoy your first evening discovering local cuisine in a traditional izakaya. These Japanese taverns offer a friendly atmosphere where locals gather after work. You can taste yakitori (grilled skewers), fresh sashimi, and local sake in an authentic Tokyo atmosphere."
            tips: "Testez un izakaya pour une exp√©rience authentique. Arrivez vers 18h-19h pour √©viter la foule du soir. Commandez le 'omakase' (s√©lection du chef) pour d√©couvrir les sp√©cialit√©s maison. Budget 30-40‚Ç¨/personne. R√©servation recommand√©e pour les √©tablissements populaires comme Torikizoku ou Watami. Peu d'izakayas acceptent les cartes bancaires, pr√©voyez du cash."
            tips_en: "Try an izakaya for an authentic experience. Arrive around 6-7pm to avoid the evening crowd. Order the 'omakase' (chef's selection) to discover house specialties. Budget 30-40‚Ç¨/person. Reservation recommended for popular establishments like Torikizoku or Watami. Few izakayas accept credit cards, bring cash."
            transfer: "10 min √† pied depuis Shibuya Crossing"
            transfer_en: "10 min walk from Shibuya Crossing"
            suggestion: "Prolongez la soir√©e au Golden Gai pour d√©couvrir les bars minuscules typiques de Shinjuku"
            suggestion_en: "Extend the evening at Golden Gai to discover the tiny typical bars of Shinjuku"
            weather_icon: "üåô"
            weather_temp: "18¬∞C"
            weather_description: "Soir√©e claire"
            weather_description_en: "Clear evening"

          # JOUR 2
          - step_number: 3
            day_number: 2
            title: "Senso-ji Temple"
            subtitle: "Le plus ancien temple de Tokyo"
            main_image: "[URL_RETOURN√âE_PAR_OUTIL_MCP]"
            step_type: "visite"
            latitude: 35.7147
            longitude: 139.7966
            duration: "3h"
            price: 0
            why: "Temple bouddhiste embl√©matique d'Asakusa, avec sa porte Kaminarimon et sa rue commer√ßante Nakamise."
            tips: "Arrivez t√¥t le matin (8h) pour √©viter la foule. Gratuit. Go√ªtez les ningyo-yaki (g√¢teaux traditionnels) dans Nakamise."
            transfer: "25 min en m√©tro depuis Shibuya"
            weather_icon: "‚òÄÔ∏è"
            weather_temp: "23¬∞C"

          - step_number: 4
            day_number: 2
            title: "Tokyo Skytree"
            subtitle: "Vue panoramique sur Tokyo"
            main_image: "[URL_RETOURN√âE_PAR_OUTIL_MCP]"
            step_type: "activit√©"
            latitude: 35.7101
            longitude: 139.8107
            duration: "2h"
            price: 25
            why: "Plus haute tour du Japon (634m) avec vue √† 360¬∞ sur Tokyo et le Mont Fuji (par temps clair)."
            tips: "R√©servez en ligne pour √©viter la file. Sunset recommand√©. Ticket: 2500¬• (Tembo Deck) ou 4000¬• (Tembo Galleria)."
            transfer: "10 min √† pied depuis Senso-ji"

          # JOUR 3
          - step_number: 5
            day_number: 3
            title: "Meiji Shrine"
            subtitle: "Sanctuaire shinto au c≈ìur d'une for√™t"
            main_image: "[URL_RETOURN√âE_PAR_OUTIL_MCP]"
            step_type: "visite"
            latitude: 35.6764
            longitude: 139.6993
            duration: "2h"
            price: 0
            why: "Sanctuaire paisible d√©di√© √† l'empereur Meiji, nich√© dans une for√™t de 100 000 arbres en plein Tokyo."
            tips: "Entr√©e gratuite. Participez √† une c√©r√©monie de purification. Visitez le jardin int√©rieur (500¬•)."
            transfer: "15 min en m√©tro depuis l'h√¥tel"
            weather_icon: "üå§Ô∏è"
            weather_temp: "21¬∞C"

          - step_number: 6
            day_number: 3
            title: "Harajuku & Takeshita Street"
            subtitle: "Quartier de la mode et de la pop culture"
            main_image: "[URL_RETOURN√âE_PAR_OUTIL_MCP]"
            step_type: "activit√©"
            latitude: 35.6702
            longitude: 139.7026
            duration: "3h"
            price: 30
            why: "√âpicentre de la mode kawaii et de la street culture japonaise. Boutiques uniques, cr√™pes g√©antes, cosplay."
            tips: "Visitez le dimanche pour voir les cosplayeurs. Go√ªtez les cr√™pes Marion (c√©l√®bres). Budget shopping √† pr√©voir."
            transfer: "5 min √† pied depuis Meiji Shrine"

          # [...] Continuer pour tous les jours jusqu'au dernier

          # JOUR 7 (dernier jour)
          - step_number: 13
            day_number: 7
            title: "Tsukiji Outer Market"
            subtitle: "March√© aux poissons et petit-d√©jeuner sushi"
            main_image: "[URL_RETOURN√âE_PAR_OUTIL_MCP]"
            step_type: "activit√©"
            latitude: 35.6654
            longitude: 139.7707
            duration: "2h"
            price: 25
            why: "March√© anim√© avec stands de street food et restaurants de sushi ultra-frais. Exp√©rience authentique avant le d√©part."
            tips: "Arrivez t√¥t (7h) pour le meilleur choix. D√©jeunez dans un sushi-ya du march√©. Comptez 3000¬•/personne."
            transfer: "20 min en m√©tro depuis l'h√¥tel"
            weather_icon: "‚òÄÔ∏è"
            weather_temp: "20¬∞C"

          - step_number: 14
            day_number: 7
            title: "D√©part de Tokyo"
            subtitle: "Vol retour vers Bruxelles"
            main_image: "[URL_RETOURN√âE_PAR_OUTIL_MCP]"
            step_type: "transport"
            duration: "3h"
            price: 0
            why: "Transfert vers l'a√©roport Narita et vol retour."
            tips: "Arrivez 3h avant le vol international. Narita Express : 3000¬•, 60 min."
            transfer: "Train Narita Express depuis Tokyo Station"

          # STEP R√âCAPITULATIVE (step 99 D√âJ√Ä EXISTANTE - √Ä REMPLIR)
          # ‚ö†Ô∏è NE PAS CR√âER UNE NOUVELLE STEP - REMPLIR LA STEP 99 EXISTANTE
          - step_number: 99
            day_number: 0
            title: "R√©sum√© du voyage"
            subtitle: "7 jours ‚Äî Tokyo, Japon üáØüáµ"
            main_image: "[URL_RETOURN√âE_PAR_OUTIL_MCP]"
            is_summary: true
            step_type: "summary"
            duration: ""
            price: 0
            summary_stats:
              - type: days
                value: 7
              - type: budget
                value: "3 500‚Ç¨"
              - type: weather
                value: "22¬∞C"
              - type: style
                value: "Culture & Gastronomie"
              - type: cities
                value: 1
              - type: people
                value: 2
              - type: activities
                value: 13
              - type: custom
                value: "Direct"
                icon: "Plane"
                label: "VOL"
                color: "golden"
      ```

      ---

      **CHECKLIST FINALE ULTRA-STRICTE AVANT DE SOUMETTRE TON OUTPUT :**

      üìã **STRUCTURE GLOBALE :**
      - ‚úÖ hero_image OBLIGATOIRE en haut - URL Supabase via images.hero (TOUJOURS appeler, m√™me avec templates)
      - ‚úÖ 1-3 steps par jour pour CHAQUE jour du voyage
      - ‚úÖ Step 99 (EXISTANTE) remplie avec title, subtitle, summary_stats (4-8 items)
      - ‚ö†Ô∏è NE PAS cr√©er de nouvelle step r√©capitulative - step 99 existe d√©j√† !

      üìã **CHAQUE STEP (hors r√©cap) DOIT AVOIR - LISTE COMPL√àTE :**
      - ‚úÖ step_number, day_number, main_image (URL Supabase) - COPI√âS depuis templates
      - ‚úÖ title (FR - 4-8 mots) + title_en (EN - temporaire: copie de title ou vide) - OBLIGATOIRE
      - ‚úÖ subtitle (FR) + subtitle_en (EN - temporaire: copie ou vide) - OBLIGATOIRE
      - ‚úÖ latitude + longitude (sauf transport/r√©cap) - COPI√âS depuis templates
      - ‚úÖ why (3-4 PHRASES d√©taill√©es FR) + why_en (temporaire: vide ou copie) - OBLIGATOIRE
      - ‚úÖ tips (3-5 PHRASES ultra-d√©taill√©es avec horaires/prix/astuces FR) + tips_en (temporaire: vide ou copie) - OBLIGATOIRE
      - ‚úÖ duration PR√âCISE (ex: "2h30", "3h", "Demi-journ√©e") + price R√âALISTE (nombre) - OBLIGATOIRE
      - ‚úÖ step_type (activit√©/visite/restaurant/transport/h√©bergement/loisir) - COPI√â depuis templates
      - ‚úÖ weather_icon (emoji üå§Ô∏è ‚òÄÔ∏è ‚õÖ üåßÔ∏è) + weather_temp (ex: "22¬∞C") - OBLIGATOIRE
      - ‚úÖ weather_description (FR: "Ensoleill√©", "Partiellement nuageux") + weather_description_en (temporaire: vide ou copie) - OBLIGATOIRE
      - ‚úÖ transfer (comment y aller FR) + transfer_en (temporaire: vide ou copie) - FORTEMENT RECOMMAND√â
      - ‚úÖ suggestion (suggestions compl√©mentaires FR) + suggestion_en (temporaire: vide ou copie) - RECOMMAND√â

      üö® **SI UNE STEP MANQUE UN DE CES CHAMPS OBLIGATOIRES ‚Üí RECOMMENCE CETTE STEP**

      üìã **QUALIT√â DES DONN√âES :**
      - ‚úÖ AUCUNE URL Wikipedia, Unsplash, Pexels, ou externe
      - ‚úÖ TOUTES les URLs d'images commencent par "https://cinbnmlfpffmyjmkwbco.supabase.co/"
      - ‚úÖ GPS r√©els obtenus via geo.text_to_place (pas invent√©s)
      - ‚úÖ Prix coh√©rents et r√©alistes pour la destination
      - ‚úÖ Dur√©es r√©alistes et adapt√©es au rythme

      üìã **COH√âRENCE GLOBALE :**
      - ‚úÖ Rythme respect√© (relaxed/balanced/intense)
      - ‚úÖ Styles respect√©s (Culture, Gastronomie, Nature, etc.)
      - ‚úÖ Budget total compatible avec demande utilisateur
      - ‚úÖ Chronologie logique (pas de t√©l√©portation entre steps)

      üö® **SI UNE SEULE CASE N'EST PAS COCH√âE : RECOMMENCE LA STEP CONCERN√âE**

    expected_output: |-
      Un YAML STRICT avec la structure itinerary_plan (voir exemple complet ci-dessus).

      **NE JAMAIS PRODUIRE DE JSON.**

    async_execution: false

  # ==========================================================================
  # TASK 6: BUDGET CALCULATION
  # ==========================================================================
  budget_calculation:
    description: |-
      Tu re√ßois les outputs de tous les agents pr√©c√©dents. Ta mission : calculer
      le budget total et v√©rifier la coh√©rence avec le budget utilisateur.

      **CONTEXTE VOYAGE :**
      {trip_context}

      **VOLS :**
      {flight_quotes}

      **H√âBERGEMENT :**
      {lodging_quotes}

      **ITIN√âRAIRE :**
      {itinerary_plan}

      ---

      **PROCESSUS DE CALCUL :**

      1. **Extraire les co√ªts** :
         - Vols : flight_quotes.total.total_price
         - H√©bergement : lodging_quotes.recommended.total_price
         - Activit√©s : somme des itinerary_plan.steps[].price (sauf steps is_summary)
         - Transport local : estimer 10-15‚Ç¨/jour/personne

      2. **Calculer le total** :
         - Total = Vols + H√©bergement + Activit√©s + Transport local
         - Par personne = Total / travelers_count

      3. **Comparer avec budget utilisateur** :
         - Budget demand√© : trip_context.budget.budget_amount
         - Delta = (Total - Budget demand√©) / Budget demand√© √ó 100
         - Statut :
           * OK : delta ‚â§ 5%
           * WARN : 5% < delta ‚â§ 15%
           * EXCEED : delta > 15%

      4. **Proposer des ajustements si EXCEED** :
         - R√©duire h√©bergement (passer √† confort inf√©rieur)
         - R√©duire activit√©s payantes
         - Chercher vols moins chers (accepter escale)
         - R√©duire dur√©e du s√©jour

      **R√àGLES :**
      - Toujours arrondir √† la dizaine sup√©rieure
      - Fournir d√©tails par cat√©gorie
      - √ätre transparent sur les estimations vs prix r√©els

    expected_output: |-
      Un YAML STRICT avec la structure budget_summary :

      ```yaml
      budget_summary:
        breakdown:
          flights:
            total: 2600
            per_person: 1300
            currency: EUR
            source: "flight_quotes"

          accommodation:
            total: 840
            per_person: 420
            currency: EUR
            source: "lodging_quotes"

          activities:
            total: 245
            per_person: 122.5
            currency: EUR
            source: "itinerary_plan (somme des step.price)"
            details:
              - "Tokyo Skytree: 25‚Ç¨"
              - "Harajuku shopping: 30‚Ç¨"
              - "Tsukiji breakfast: 25‚Ç¨"
              - "Autres activit√©s: 165‚Ç¨"

          transport_local:
            total: 200
            per_person: 100
            currency: EUR
            source: "estimation (m√©tro + trains locaux)"
            notes: "Estimation bas√©e sur 7 jours √ó 15‚Ç¨/jour/personne"

        totals:
          grand_total: 3885
          per_person: 1942.5
          travelers_count: 2
          currency: EUR
          display: "3 885‚Ç¨"

        comparison:
          budget_requested: 1500
          budget_type: per_person  # ou total_group
          currency: EUR
          delta_amount: 442.5
          delta_percent: 29.5
          status: EXCEED  # OK, WARN, EXCEED

        adjustments:
          - category: "H√©bergement"
            current: 840
            proposed: 600
            saving: 240
            action: "Passer d'un h√¥tel 4‚òÖ √† un h√¥tel 3‚òÖ"

          - category: "Activit√©s"
            current: 245
            proposed: 180
            saving: 65
            action: "R√©duire shopping et activit√©s payantes"

        final_adjusted:
          grand_total: 3580
          per_person: 1790
          currency: EUR
          display: "3 580‚Ç¨"
          delta_percent: 19.3
          status: WARN  # toujours au-dessus mais acceptable

        recommendation: |-
          Le budget initial de 3 885‚Ç¨ d√©passe le budget demand√© de 1 500‚Ç¨/personne (3 000‚Ç¨ total) de 29.5%.
          Avec les ajustements propos√©s (h√©bergement 3‚òÖ + r√©duction activit√©s), le budget ajust√© est de 3 580‚Ç¨ (1 790‚Ç¨/personne),
          soit un d√©passement de 19.3% encore notable mais plus acceptable.

          Recommandation : Valider ces ajustements OU augmenter le budget √† 1 800‚Ç¨/personne.
      ```

      **NE JAMAIS PRODUIRE DE JSON.**

    async_execution: false

  # ==========================================================================
  # TASK 7: FINAL ASSEMBLY (AGENT INTELLIGENT)
  # ==========================================================================
  final_assembly:
    description: |-
      üéØ **TU ES LE DERNIER REMPART QUALIT√â. C'EST TOI QUI G√âN√àRES LE JSON FINAL.**

      üö® **R√àGLES DE VALIDATION PRATIQUES** üö®
      - ‚úÖ OBLIGATION : COPIER EXACTEMENT les donn√©es depuis les outputs des agents
      - ‚ùå INTERDICTION TOTALE : Inventer, modifier, ou "am√©liorer" les donn√©es re√ßues
      - ‚ùå INTERDICTION TOTALE : Ajouter des steps non pr√©sentes dans itinerary_plan
      - üõ°Ô∏è IMAGES : Accepter les URLs Supabase (id√©al) OU Unsplash (fallback acceptable)
      - üõ°Ô∏è IMAGES : Si main_image contient "FAILED" ou est vide ‚Üí utiliser image fallback g√©n√©rique
      - üõ°Ô∏è GPS : Privil√©gier les steps avec GPS, mais accepter les steps sans GPS si tout le reste est OK
      - üîç VALIDATION : Chaque step DOIT avoir step_number, day_number, title, main_image (m√™me fallback)
      - üîç TOL√âRANCE : Si quelques steps ont des images fallback ‚Üí ACCEPTER LE TRIP quand m√™me
      - üìä PRIORIT√â : Trip complet et fonctionnel > Perfection absolue des images
      - ‚ö†Ô∏è Si donn√©es manquantes critiques (destination, total_days) : ALORS rejeter avec erreur claire
      - ‚úÖ JAMAIS bloquer un trip entier juste pour des images Supabase manquantes

      ---

      Tu re√ßois TOUS les outputs des agents pr√©c√©dents. Ta mission : consolider et
      produire le JSON final conforme au sch√©ma Trip, pr√™t pour insertion en base de donn√©es.

      **DESTINATION CHOISIE :**
      {destination_choice}

      **VOLS :**
      {flight_quotes}

      **H√âBERGEMENT :**
      {lodging_quotes}

      **ITIN√âRAIRE :**
      {itinerary_plan}

      **BUDGET :**
      (Disponible depuis la t√¢che pr√©c√©dente budget_calculation - utilise l'output de cette t√¢che)

      **CONTEXTE VOYAGE :**
      {trip_context}

      ---

      ## **PROCESSUS D'ASSEMBLAGE**

      ### **1. CHAMPS TRIP (niveau racine)**

      **OBLIGATOIRES :**
      - code : depuis destination_choice.code (ex: "TOKYO-2025")
      - destination : depuis destination_choice.destination (ex: "Tokyo, Japon üáØüáµ")
      - total_days : depuis destination_choice.total_days ou trip_context.dates.duration_nights
      - steps : depuis itinerary_plan.steps (voir point 2)

      **RECOMMAND√âS :**
      - destination_en : depuis destination_choice.destination_en
      - main_image : depuis itinerary_plan.hero_image
      - flight_from : depuis flight_quotes.origin.city
      - flight_to : depuis flight_quotes.destination.city
      - flight_duration : depuis flight_quotes.outbound.duration
      - flight_type : depuis flight_quotes.summary.type
      - hotel_name : depuis lodging_quotes.recommended.hotel_name
      - hotel_rating : depuis lodging_quotes.recommended.hotel_rating **UTILISER TEL QUEL (√©chelle 0-10)**
        * ‚ö†Ô∏è IMPORTANT : Le sch√©ma Trip accepte 0-10 (m√™me √©chelle que Booking.com)
        * NE PAS diviser par 2 ou convertir
        * Exemple : 8.7 ‚Üí 8.7, 9.2 ‚Üí 9.2, 10.0 ‚Üí 10.0
      - total_price : depuis budget_summary.totals.display
      - total_budget : depuis budget_summary.totals.display
      - average_weather : depuis destination_choice.average_weather
      - travel_style : depuis destination_choice.travel_style
      - travel_style_en : depuis destination_choice.travel_style_en
      - start_date : depuis trip_context.dates.departure_date (format: YYYY-MM-DD)
      - travelers : depuis trip_context.travelers.travelers_count
      - price_flights : depuis flight_quotes.summary.price
      - price_hotels : depuis lodging_quotes.summary.price_display
      - price_transport : depuis budget_summary.breakdown.transport_local.total + "‚Ç¨"
      - price_activities : depuis budget_summary.breakdown.activities.total + "‚Ç¨"

      ### **2. STEPS (tableau de steps)**

      **VALIDATION CRITIQUE DE CHAQUE STEP :**

      Pour CHAQUE step dans itinerary_plan.steps :

      ‚úÖ **V√©rifier champs OBLIGATOIRES :**
      - step_number : doit √™tre pr√©sent (integer)
      - day_number : doit √™tre pr√©sent (integer)
      - title : doit √™tre pr√©sent (string non vide)
      - main_image : doit √™tre pr√©sent ET commencer par "https://cinbnmlfpffmyjmkwbco.supabase.co/storage/v1/object/public/TRIPS/"

      ‚ö†Ô∏è **SI main_image NE COMMENCE PAS PAR L'URL SUPABASE :**
      - ‚ùå REJETER CETTE STEP avec erreur explicite
      - üìù Logger : "Step [num√©ro] a une main_image invalide : [URL]"
      - üö´ NE PAS inclure cette step dans le JSON final

      ‚úÖ **V√©rifier latitude + longitude :**
      - Si step_type != "transport" ET step_type != "r√©capitulatif" :
        * latitude ET longitude DOIVENT √™tre pr√©sentes
        * Si absentes : ‚ùå REJETER avec erreur

      ‚úÖ **Copier champs optionnels pr√©sents :**
      - title_en, subtitle, subtitle_en
      - step_type, why, why_en, tips, tips_en
      - transfer, transfer_en, suggestion, suggestion_en
      - weather_icon, weather_temp, weather_description, weather_description_en
      - duration, price
      - images (array)

      ‚úÖ **Step r√©capitulative (is_summary: true) :**
      - **title DOIT √™tre pr√©sent et non vide** : utiliser "R√©sum√© du voyage" (FR) ou depuis itinerary_plan
      - **title_en** : utiliser "Trip Summary" (EN) ou depuis itinerary_plan
      - **day_number**: 0 (z√©ro - repr√©sente fin du voyage)
      - summary_stats DOIT contenir 4-8 items
      - Si moins de 4 : AJOUTER des stats calcul√©es (days, budget, people, activities)
      - Si plus de 8 : TRONQUER √† 8

      ### **3. G√âN√âRATION DU CODE VOYAGE**

      Si destination_choice.code existe : **UTILISER TEL QUEL** (ne pas r√©g√©n√©rer)
      Sinon, g√©n√©rer en suivant les r√®gles :
      - Format : [DESTINATION]-[THEME]-[YEAR]
      - Exemples : "TOKYO-CULTURE-2025", "BALI-WELLNESS-2025", "PARIS-ROMANCE-2025"
      - R√®gles de normalisation :
        * MAJUSCULES uniquement
        * Remplacer espaces/caract√®res sp√©ciaux par "-"
        * Max 30 caract√®res total
        * Commencer par une LETTRE obligatoirement
        * THEME bas√© sur travel_style (CULTURE, ADVENTURE, WELLNESS, GASTRONOMY, ROMANCE, FAMILY, BUSINESS, NATURE, BEACH, CITY)

      ### **4. VALIDATION FINALE**

      Avant de retourner le JSON, v√©rifier :
      - ‚úÖ code est valide (pattern: ^[A-Z][A-Z0-9-]{2,29}$) - max 30 caract√®res
      - ‚ö†Ô∏è destination est pr√©sente (peut √™tre un placeholder)
      - ‚úÖ total_days > 0
      - ‚úÖ steps contient au moins 1 step
      - ‚úÖ TOUTES les steps ont step_number, day_number, title, main_image
      - ‚úÖ TOUTES les main_image commencent par l'URL Supabase
      - ‚úÖ AU MOINS une step avec is_summary: true
      - ‚úÖ summary_stats de la step r√©cap contient 4-8 items

      Si une validation √©choue : RETOURNER un JSON d'erreur avec :
      ```yaml
      error: true
      error_message: "Description pr√©cise de l'erreur"
      failed_validations: ["liste des validations √©chou√©es"]
      ```

      ‚ö†Ô∏è **EXCEPTION IMPORTANTE : DESTINATION**
      - Si la destination est "Destination √† pr√©ciser" ou vide : C'EST UN WARNING, PAS UNE ERREUR BLOQUANTE
      - Le trip peut √™tre g√©n√©r√© avec une destination placeholder
      - Logger un warning dans un champ `warnings`mais NE PAS rejeter le JSON complet

      ---

      ## **EXEMPLE COMPLET DE JSON FINAL ATTENDU**

      ```yaml
      trip:
        code: "TOKYO-2025"
        destination: "Tokyo, Japon üáØüáµ"
        destination_en: "Tokyo, Japan üáØüáµ"
        total_days: 7
        main_image: "[URL_RETOURN√âE_PAR_OUTIL_MCP]"

        flight_from: "Bruxelles"
        flight_to: "Tokyo"
        flight_duration: "12h30"
        flight_type: "Vol direct"

        hotel_name: "Hotel Gracery Shinjuku"
        hotel_rating: 4.3

        total_price: "3 885‚Ç¨"
        total_budget: "3 885‚Ç¨"
        average_weather: "22¬∞C"

        travel_style: "Culture & Gastronomie"
        travel_style_en: "Culture & Food"

        start_date: "2025-12-15"
        travelers: 2

        price_flights: "2 600‚Ç¨"
        price_hotels: "840‚Ç¨"
        price_transport: "200‚Ç¨"
        price_activities: "245‚Ç¨"

        steps:
          - step_number: 1
            day_number: 1
            title: "Arriv√©e √† Tokyo"
            subtitle: "Installation et premi√®re d√©couverte de Shibuya"
            main_image: "[URL_RETOURN√âE_PAR_OUTIL_MCP]"
            step_type: "activit√©"
            latitude: 35.6595
            longitude: 139.7004
            duration: "2h"
            price: 0
            why: "Shibuya Crossing est l'un des passages pi√©tons les plus embl√©matiques au monde."
            tips: "Visitez en fin d'apr√®s-midi pour voir le crossing illumin√©."
            weather_icon: "üå§Ô∏è"
            weather_temp: "22¬∞C"

          - step_number: 2
            day_number: 1
            title: "D√Æner √† Shibuya"
            main_image: "[URL_RETOURN√âE_PAR_OUTIL_MCP]"
            step_type: "restaurant"
            latitude: 35.6612
            longitude: 139.6988
            duration: "1h30"
            price: 35
            why: "D√©couverte de la cuisine locale dans le quartier anim√©."
            tips: "Testez un izakaya pour une exp√©rience authentique."

          # [...] Toutes les autres steps

          - step_number: 15
            day_number: 7
            title: "R√©sum√© du voyage"
            subtitle: "7 jours ‚Äî Tokyo, Japon üáØüáµ"
            main_image: "[URL_RETOURN√âE_PAR_OUTIL_MCP]"
            is_summary: true
            step_type: "r√©capitulatif"
            duration: "‚Äî"
            price: 0
            summary_stats:
              - type: days
                value: 7
              - type: budget
                value: "3 885‚Ç¨"
              - type: weather
                value: "22¬∞C"
              - type: style
                value: "Culture & Gastronomie"
              - type: cities
                value: 1
              - type: people
                value: 2
              - type: activities
                value: 14
              - type: custom
                value: "Direct"
                icon: "Plane"
                label: "VOL"
                color: "golden"
      ```

      ---

      **CHECKLIST FINALE :**
      - ‚úÖ Tous les champs obligatoires pr√©sents (code, total_days, steps)
      - ‚úÖ Code unique g√©n√©r√©/valid√©
      - ‚ö†Ô∏è Destination pr√©sente (peut √™tre un placeholder si agent strategist a √©chou√©)
      - ‚úÖ Toutes les steps valid√©es
      - ‚úÖ Toutes les main_image sont des URLs Supabase
      - ‚úÖ Toutes les steps ont GPS (sauf transport/r√©cap)
      - ‚úÖ Step r√©capitulative pr√©sente avec summary_stats
      - ‚úÖ JSON conforme au sch√©ma Trip

    expected_output: |-
      Un YAML STRICT contenant uniquement la cl√© `trip` avec tout le JSON final.

      **STRUCTURE :**
      ```yaml
      trip:
        code: "..."
        destination: "..."
        # [...] tous les champs
        steps:
          - step_number: 1
            # [...]
      ```

      ‚ö†Ô∏è **SI ERREURS DE VALIDATION :**
      ```yaml
      error: true
      error_message: "Description de l'erreur"
      failed_validations:
        - "Step 3 manque latitude/longitude"
        - "Step 5 a une main_image invalide (URL externe)"
      ```

      **NE JAMAIS PRODUIRE DE JSON.**

    async_execution: false
