tasks:
  traveller_profile_brief:
    agent: traveller_insights_analyst
    description: |-
      Analyse attentivement le questionnaire client et l'inférence persona existante
      (déjà calculée par un service amont — ne la recalculer pas, utilise-la comme
      contexte fiable).

      QUESTIONNAIRE BRUT:
      {questionnaire}

      INFÉRENCE PERSONA FOURNIE:
      {persona_context}

      Ton objectif est de comprendre les motivations, priorités et contraintes
      du voyageur. Produit un raisonnement explicite: identifie les éléments
      positifs (pour), les points de vigilance (contre), les besoins critiques,
      les préférences non critiques et les objectifs implicites. Termine par un
      paragraphe narratif immersif qui décrit la personne comme si tu la
      présentais à un travel designer.
    expected_output: |-
      Réponds STRICTEMENT en JSON suivant la structure ci-dessous. Utilise des
      phrases complètes et précises.
      {
        "persona_summary": "Résumé synthétique du profil",
        "pros": ["Liste des points favorables"],
        "cons": ["Liste des risques ou points d'attention"],
        "critical_needs": ["Besoins indispensables"],
        "non_critical_preferences": ["Envies confort mais non bloquantes"],
        "user_goals": ["Objectifs explicites ou implicites"],
        "narrative": "Paragraphe narratif en français",
        "analysis_notes": "Synthèse de ta réflexion"
      }
    async_execution: false
  persona_challenge_review:
    agent: persona_quality_challenger
    context:
      - traveller_profile_brief
    description: |-
      Tu es le relecteur critique de l'analyse précédente. Exploite le contexte
      pour évaluer la solidité du raisonnement, détecter les contradictions avec
      le questionnaire et ajouter les recommandations qui manquent pour
      opérationnaliser la proposition.

      1. Challenge l'argumentation: signale les hypothèses fragiles ou les biais
         et propose des correctifs précis.
      2. Vérifie que les pros/cons/besoins/goals sont complets et aligne-les avec
         les signaux forts du questionnaire.
      3. Termine par une synthèse actionnable expliquant quoi transmettre à un
         travel designer.

      La restitution finale DOIT respecter le même schéma JSON que la première
      tâche en y ajoutant un bloc dédié à ton challenge.
    expected_output: |-
      {
        "persona_summary": "Résumé mis à jour après challenge",
        "pros": ["Liste consolidée"],
        "cons": ["Liste consolidée"],
        "critical_needs": ["Besoins confirmés"],
        "non_critical_preferences": ["Préférences"],
        "user_goals": ["Objectifs"],
        "narrative": "Récit affiné",
        "analysis_notes": "Synthèse complète",
        "challenge_summary": "Ce que ton challenge a apporté",
        "challenge_actions": ["Actions concrètes à transmettre"]
      }
    async_execution: false
  trip_signal_synthesis:
    agent: trip_signal_synthesizer
    context:
      - persona_challenge_review
    description: |-
      Tu reprends le JSON du challenger et toutes les données brutes dans
      input_payload pour fabriquer un JSON synthétique compact nommé
      normalized_trip_request. L'objectif est de conserver 100 % des faits
      fiables tout en supprimant le bruit.

      Principes clés:
      - N'utilise aucun JSON Schema externe: tu crées un format standardisé
        simple inspiré de nos sections habituelles (user, travel_party,
        trip_frame, budget, preferences, constraints, assist_needed,
        personas, explanations).
      - Supprime toutes les métadonnées inutiles (ids techniques, pipeline_run,
        created_at, updated_at, user_id, etc.). Seules les informations utiles à
        la conception du voyage doivent rester.
      - Lorsque les dates sont flexibles, calcule toutes les dates possibles en
        utilisant la date approximative ± flexibilité (liste departure_dates et
        return_dates synchronisées). Si les dates sont fixes, garde-les telles
        quelles.
      - Conserve les valeurs nulles lorsqu'une information manque (ex: airport
        hint), mais n'invente rien.
      - Si plusieurs sources répètent la même information, garde la version la
        plus claire et indique dans discarded_elements ce que tu as supprimé.
      - Toute donnée avec une confiance < 70 (scores personas, signaux faibles)
        doit être exclue pour éviter le bruit.
      - S'il existe une destination explicite, renseigne-la. Sinon, garde une
        entrée vide (city/country null) mais n'ajoute pas de destinations
        imaginaires.
      - Liste explicitement les assistances demandées, les contraintes et les
        besoins critiques remontés par le challenger.
      - Les sections doivent rester concises: pas de paragraphes répétitifs.
      - Préserve systématiquement les informations d'origine (ville + pays)
        lorsqu'elles sont connues. Ne les remplace pas par null si elles sont
        présentes dans le questionnaire.
      - Calcule le budget global du voyage (estimated_total_group) à partir du
        budget par personne et du nombre total de voyageurs si ces deux
        informations sont fournies.
      - Le rendu final doit impérativement être en YAML lisible.
    expected_output: |-
      Retourne uniquement un YAML structuré comme suit:
      normalized_trip_request:
        user:
          email: ""
          preferred_language: ""
        travel_party:
          group_type: ""
          travelers_count: 0
          has_children: false
          children: []
        trip_frame:
          origin:
            city: null
            country: null
            airport_hint: null
          destinations:
            - label: primary
              city: null
              country: null
              stay_nights: null
          dates:
            type: fixed|flexible
            departure_dates:
              - "YYYY-MM-DD"
            return_dates:
              - "YYYY-MM-DD"
            duration_nights: null
        budget:
          is_known: false
          currency: null
          estimated_total_per_person: null
          estimated_total_group: null
          notes: null
        preferences:
          climate: []
          vibe: null
          rhythm: null
          activities: []
          accommodation:
            types: []
            comfort_min_rating: null
          transport:
            flight_preference: null
            allowed_modes_local: []
            baggage:
              cabin: false
              hold: false
        constraints:
          diet: []
          safety: null
          mobility: null
          other: []
        assist_needed:
          flights: false
          accommodation: false
          activities: false
          other: []
        personas:
          primary:
            name: null
            confidence: null
          emerging: []
        explanations:
          persona_summary: null
          pros: []
          cons: []
          critical_needs: []
          non_critical_preferences: []
          user_goals: []
      synthesis_notes: "Explique comment tu as consolidé les infos"
      discarded_elements:
        - "Ce que tu as supprimé car redondant ou <70 de confiance"
    async_execution: false
  trip_signal_quality_challenge:
    agent: trip_signal_challenger
    context:
      - trip_signal_synthesis
      - persona_challenge_review
    description: |-
      Tu relis le JSON synthétique et tu le challenges jusqu'à obtenir un
      payload compact réellement exploitable.

      Attendus:
      1. Vérifie que toutes les informations proviennent bien du questionnaire
         ou du challenger, sans invention. Corrige directement les champs qui
         seraient faux ou incomplets.
      2. Confirme que les dates flexibles contiennent toutes les combinaisons
         plausibles et que les destinations/points de départ correspondent à ce
         qui est connu (ex: Bruxelles, Belgique comme origine si fourni).
      3. Vérifie que le budget global a bien été calculé et cohérent avec la
         taille du groupe lorsque les entrées le permettent.
      4. Supprime toute répétition restante, les détails superflus (notes trop
         longues, ids, pourcentages inutiles) et assure-toi que les sections
         sont équilibrées.
      5. Si tu supprimes un élément, ajoute une justification courte dans
         challenge_feedback.removals. Si tu ajoutes ou ajustes une donnée,
         indique-le dans challenge_feedback.additions.
      6. Laisse les champs null quand l'information manque vraiment et assure-toi
         que la restitution finale reste en YAML propre et lisible.
    expected_output: |-
      normalized_trip_request:
        ... YAML final après challenge ...
      challenge_feedback:
        issues_found:
          - "Problèmes détectés"
        fixes_applied:
          - "Correctifs réalisés"
        removals:
          - "Détails supprimés"
        additions:
          - "Infos ajoutées"
    async_execution: false
