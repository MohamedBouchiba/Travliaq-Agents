tasks:
  traveller_profile_brief:
    agent: traveller_insights_analyst
    description: |-
      Analyse attentivement le questionnaire client et l'inférence persona existante
      (déjà calculée par un service amont — ne la recalculer pas, utilise-la comme
      contexte fiable).

      QUESTIONNAIRE BRUT:
      {questionnaire}

      INFÉRENCE PERSONA FOURNIE:
      {persona_context}

      Ton objectif est de comprendre les motivations, priorités et contraintes
      du voyageur. Produit un raisonnement explicite: identifie les éléments
      positifs (pour), les points de vigilance (contre), les besoins critiques,
      les préférences non critiques et les objectifs implicites. Termine par un
      paragraphe narratif immersif qui décrit la personne comme si tu la
      présentais à un travel designer.
    expected_output: |-
      Une analyse complète et structurée du profil voyageur, incluant un narratif immersif
      et une liste argumentée de points forts, faibles et besoins critiques.
      L'output final sera automatiquement formaté en JSON par le système.
    async_execution: false
  persona_challenge_review:
    agent: persona_quality_challenger
    context:
      - traveller_profile_brief
    description: |-
      Tu es le relecteur critique de l'analyse précédente. Exploite le contexte
      pour évaluer la solidité du raisonnement, détecter les contradictions avec
      le questionnaire et ajouter les recommandations qui manquent pour
      opérationnaliser la proposition.

      1. Challenge l'argumentation: signale les hypothèses fragiles ou les biais
         et propose des correctifs précis.
      2. Vérifie que les pros/cons/besoins/goals sont complets et aligne-les avec
         les signaux forts du questionnaire.
      3. Termine par une synthèse actionnable expliquant quoi transmettre à un
         travel designer.

      La restitution finale DOIT respecter le même schéma JSON que la première
      tâche en y ajoutant un bloc dédié à ton challenge.
    expected_output: |-
      Une revue critique de l'analyse précédente, validant ou corrigeant les hypothèses,
      avec des recommandations concrètes pour les designers.
      L'output final sera automatiquement formaté en JSON par le système.
    async_execution: false
  trip_specifications_design:
    agent: trip_specifications_architect
    context:
      - persona_challenge_review
    description: |-
      Tu es responsable de la création du fichier de spécifications final (normalized_trip_request).
      Tu dois fusionner les faits bruts du questionnaire (input_payload) avec l'analyse validée
      du challenger (persona_challenge_review).

      Tes directives absolues :
      1. **Fidélité Totale** : Ne jamais inventer une donnée. Si le questionnaire dit "Paris", c'est Paris.
         Si une info est absente, le champ doit rester null.
      2. **Nettoyage** : Supprime toutes les métadonnées techniques (ids, timestamps, user_id).
         Ne garde que ce qui sert à construire le voyage.
      3. **Dates & Budget** :
         - Si dates flexibles : liste toutes les dates possibles (departure_dates/return_dates).
         - Si budget inconnu : laisse null, ne devine pas.
      4. **Structure** : Produis un YAML propre respectant strictement la structure cible
         (user, travel_party, trip_frame, budget, preferences, constraints, assist_needed, personas).
      5. **Confiance** : Exclus tout élément dont la confiance est faible (< 70) ou qui contredit
         le questionnaire.

      Ton output est la source de vérité pour tout le reste du système.
    expected_output: |-
      Retourne uniquement un YAML structuré comme suit:
      normalized_trip_request:
        user:
          email: ""
          preferred_language: ""
        travel_party:
          group_type: ""
          travelers_count: 0
          has_children: false
          children: []
        trip_frame:
          origin:
            city: null
            country: null
            airport_hint: null
          destinations:
            - label: primary
              city: null
              country: null
              stay_nights: null
          dates:
            type: fixed|flexible
            departure_dates:
              - "YYYY-MM-DD"
            return_dates:
              - "YYYY-MM-DD"
            duration_nights: null
        budget:
          is_known: false
          currency: null
          estimated_total_per_person: null
          estimated_total_group: null
          notes: null
        preferences:
          climate: []
          vibe: null
          rhythm: null
          activities: []
          accommodation:
            types: []
            comfort_min_rating: null
          transport:
            flight_preference: null
            allowed_modes_local: []
            baggage:
              cabin: false
              hold: false
        constraints:
          diet: []
          safety: null
          mobility: null
          other: []
        assist_needed:
          flights: false
          accommodation: false
          activities: false
          other: []
        personas:
          primary:
            name: null
            confidence: null
          emerging: []
        explanations:
          persona_summary: null
          pros: []
          cons: []
          critical_needs: []
          non_critical_preferences: []
          user_goals: []
      synthesis_notes: "Brève note sur la qualité des données entrantes"
    async_execution: false
