{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://travliaq.com/schemas/normalized_trip_request.schema.json",
  "title": "NormalizedTripRequest",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "trip_request_id",
    "user",
    "context",
    "travel_party",
    "trip_frame",
    "budget",
    "preferences",
    "constraints",
    "assist_needed",
    "personas",
    "planning_readiness"
  ],
  "properties": {
    "trip_request_id": {
      "type": "string",
      "minLength": 1,
      "description": "Unique id for this normalized trip request."
    },
    "user": {
      "type": "object",
      "additionalProperties": false,
      "required": ["user_id"],
      "properties": {
        "user_id": {
          "type": "string",
          "minLength": 1
        },
        "email": {
          "type": ["string", "null"],
          "format": "email"
        },
        "preferred_language": {
          "type": ["string", "null"],
          "description": "ISO language code like 'fr', 'en'."
        }
      }
    },
    "context": {
      "type": "object",
      "additionalProperties": false,
      "required": ["source_questionnaire_id"],
      "properties": {
        "source_questionnaire_id": {
          "type": "string",
          "minLength": 1
        },
        "pipeline_run_id": {
          "type": ["string", "null"]
        },
        "created_at": {
          "type": ["string", "null"],
          "format": "date-time"
        },
        "updated_at": {
          "type": ["string", "null"],
          "format": "date-time"
        }
      }
    },
    "travel_party": {
      "type": "object",
      "additionalProperties": false,
      "required": ["group_type", "travelers_count"],
      "properties": {
        "group_type": {
          "type": "string",
          "enum": ["solo", "duo", "family", "friends", "group"]
        },
        "travelers_count": {
          "type": "integer",
          "minimum": 1
        },
        "has_children": {
          "type": "boolean",
          "default": false
        },
        "children": {
          "type": "array",
          "items": {
            "type": "object",
            "additionalProperties": false,
            "properties": {
              "age": {
                "type": "integer",
                "minimum": 0
              }
            }
          }
        }
      }
    },
    "trip_frame": {
      "type": "object",
      "additionalProperties": false,
      "required": ["origin", "destinations", "dates"],
      "properties": {
        "origin": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "city": {
              "type": ["string", "null"]
            },
            "country": {
              "type": ["string", "null"]
            },
            "airport_hint": {
              "type": ["string", "null"],
              "description": "IATA code or free text for preferred departure airport."
            }
          }
        },
        "destinations": {
          "type": "array",
          "minItems": 1,
          "items": {
            "type": "object",
            "additionalProperties": false,
            "required": ["id", "role"],
            "properties": {
              "id": {
                "type": "string",
                "minLength": 1,
                "description": "Internal id for this destination stop."
              },
              "role": {
                "type": "string",
                "enum": ["primary", "stopover", "extension"]
              },
              "is_primary": {
                "type": "boolean",
                "description": "True if this is the main destination of the trip."
              },
              "order": {
                "type": "integer",
                "minimum": 1,
                "description": "Position in multi-destination sequence (1 = first stay)."
              },
              "city": {
                "type": ["string", "null"]
              },
              "region": {
                "type": ["string", "null"]
              },
              "country": {
                "type": ["string", "null"]
              },
              "stay_nights": {
                "type": ["integer", "null"],
                "minimum": 1,
                "description": "Planned number of nights in this destination, if known."
              }
            }
          }
        },
        "dates": {
          "type": "object",
          "additionalProperties": false,
          "required": ["dates_type", "duration_nights"],
          "properties": {
            "dates_type": {
              "type": "string",
              "enum": ["fixed", "flexible"]
            },
            "departure_date": {
              "type": ["string", "null"],
              "format": "date"
            },
            "return_date": {
              "type": ["string", "null"],
              "format": "date"
            },
            "approx_departure_date": {
              "type": ["string", "null"],
              "format": "date"
            },
            "flexibility_days_minus": {
              "type": ["integer", "null"],
              "minimum": 0,
              "description": "Number of days before approx_departure_date allowed."
            },
            "flexibility_days_plus": {
              "type": ["integer", "null"],
              "minimum": 0,
              "description": "Number of days after approx_departure_date allowed."
            },
            "duration_nights": {
              "type": "integer",
              "minimum": 1
            },
            "duration_exact": {
              "type": "boolean",
              "default": false
            },
            "candidate_departure_dates": {
              "type": "array",
              "description": "All possible departure dates computed from approx date and flexibility, e.g. for Â±7 days.",
              "items": {
                "type": "string",
                "format": "date"
              }
            },
            "candidate_date_ranges": {
              "type": "array",
              "description": "Optional explicit departure/return combinations.",
              "items": {
                "type": "object",
                "additionalProperties": false,
                "required": ["departure_date", "return_date"],
                "properties": {
                  "departure_date": {
                    "type": "string",
                    "format": "date"
                  },
                  "return_date": {
                    "type": "string",
                    "format": "date"
                  },
                  "nights": {
                    "type": ["integer", "null"],
                    "minimum": 1
                  }
                }
              }
            }
          }
        }
      }
    },
    "budget": {
      "type": "object",
      "additionalProperties": false,
      "required": ["is_known"],
      "properties": {
        "is_known": {
          "type": "boolean"
        },
        "currency": {
          "type": ["string", "null"],
          "description": "ISO 4217 currency code like EUR, USD."
        },
        "estimated_total_per_person": {
          "type": ["number", "null"],
          "minimum": 0
        },
        "estimated_total_group": {
          "type": ["number", "null"],
          "minimum": 0
        },
        "budget_type": {
          "type": ["string", "null"],
          "description": "Optional label such as 'low', 'medium', 'high', 'luxury'."
        },
        "notes": {
          "type": ["string", "null"]
        }
      }
    },
    "preferences": {
      "type": "object",
      "additionalProperties": false,
      "required": ["climate", "activities", "transport", "accommodation"],
      "properties": {
        "climate": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "vibe": {
          "type": ["string", "null"]
        },
        "rhythm": {
          "type": ["string", "null"],
          "enum": ["chilled", "balanced", "intense", null]
        },
        "activities": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "tags": {
              "type": "array",
              "items": {
                "type": "string"
              }
            }
          }
        },
        "transport": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "flight_preference": {
              "type": ["string", "null"],
              "enum": ["cheapest", "fastest", "balanced", "dont_care", null]
            },
            "allowed_modes_local": {
              "type": "array",
              "items": {
                "type": "string"
              }
            },
            "baggage": {
              "type": "object",
              "additionalProperties": false,
              "properties": {
                "cabin": {
                  "type": "boolean"
                },
                "hold": {
                  "type": "boolean"
                }
              }
            }
          }
        },
        "accommodation": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "types": {
              "type": "array",
              "items": {
                "type": "string"
              }
            },
            "comfort_min_rating": {
              "type": ["number", "null"],
              "minimum": 0,
              "maximum": 10
            },
            "neighbourhood_style": {
              "type": ["string", "null"]
            },
            "board": {
              "type": "array",
              "items": {
                "type": "string"
              }
            },
            "equipment_preferences": {
              "type": "array",
              "items": {
                "type": "string"
              }
            }
          }
        },
        "time_preferences": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "needs_siesta": {
              "type": "boolean"
            },
            "needs_free_time": {
              "type": "boolean"
            }
          }
        }
      }
    },
    "constraints": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "diet": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "vegetarian": {
              "type": "boolean"
            },
            "vegan": {
              "type": "boolean"
            },
            "no_pork": {
              "type": "boolean"
            },
            "no_alcohol": {
              "type": "boolean"
            },
            "other": {
              "type": "array",
              "items": {
                "type": "string"
              }
            }
          }
        },
        "safety": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "special_constraints": {
              "type": "boolean"
            },
            "notes": {
              "type": ["string", "null"]
            }
          }
        },
        "mobility": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "reduced_mobility": {
              "type": "boolean"
            },
            "notes": {
              "type": ["string", "null"]
            }
          }
        },
        "other": {
          "type": "array",
          "items": {
            "type": "string"
          }
        }
      }
    },
    "assist_needed": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "flights": {
          "type": "boolean"
        },
        "accommodation": {
          "type": "boolean"
        },
        "activities": {
          "type": "boolean"
        },
        "other": {
          "type": "array",
          "items": {
            "type": "string"
          }
        }
      }
    },
    "personas": {
      "type": "object",
      "additionalProperties": false,
      "required": ["primary"],
      "properties": {
        "primary": {
          "type": "object",
          "additionalProperties": false,
          "required": ["name", "confidence"],
          "properties": {
            "code": {
              "type": ["string", "null"],
              "description": "Internal identifier of the primary persona."
            },
            "name": {
              "type": "string",
              "minLength": 1
            },
            "confidence": {
              "type": "integer",
              "minimum": 0,
              "maximum": 100
            }
          }
        },
        "emerging": {
          "type": "array",
          "description": "List of emerging personas. Only personas with score >= 70 should be included.",
          "items": {
            "type": "object",
            "additionalProperties": false,
            "required": ["code", "name", "score"],
            "properties": {
              "code": {
                "type": "string",
                "minLength": 1
              },
              "name": {
                "type": "string",
                "minLength": 1
              },
              "score": {
                "type": "integer",
                "minimum": 0,
                "maximum": 100,
                "description": "Inference score. Downstream pipeline should filter out scores < 70."
              },
              "strength": {
                "type": ["string", "null"],
                "enum": ["strong", "medium", null]
              }
            }
          }
        }
      }
    },
    "explanations": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "persona_summary": {
          "type": ["string", "null"]
        },
        "user_goals": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "pros": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "cons": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "critical_needs": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "non_critical_preferences": {
          "type": "array",
          "items": {
            "type": "string"
          }
        }
      }
    },
    "planning_readiness": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "has_fixed_destination",
        "has_exact_dates",
        "has_known_budget",
        "blocking_gaps"
      ],
      "properties": {
        "has_fixed_destination": {
          "type": "boolean"
        },
        "has_exact_dates": {
          "type": "boolean"
        },
        "has_known_budget": {
          "type": "boolean"
        },
        "blocking_gaps": {
          "type": "array",
          "description": "List of high-level missing information flags, e.g. 'destination_missing', 'budget_unknown'.",
          "items": {
            "type": "string"
          }
        }
      }
    }
  }
}
